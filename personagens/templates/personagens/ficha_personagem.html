{% extends 'base.html' %}
{% load filtros %}

{% block content %}
<div class="ficha-center">
  <style>
    /* Pares label:valor em colunas dentro de cada card (valores próximos aos rótulos) */
    .ficha-card .ficha-list.pares { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 8px 18px; }
    .ficha-card .ficha-list.pares li { display: grid; grid-template-columns: auto max-content; align-items: center; gap: 8px; }
    .ficha-card .ficha-list.pares .lbl { margin-right: 0; }
    .ficha-card .ficha-list.pares .lbl::after { content: ':'; margin-left: 4px; }
    .ficha-card .ficha-list.pares .val { text-align: left; }
  </style>
  <div class="ficha-header">
    {% if personagem.foto %}
      <div class="ficha-foto-wrap">
        <img src="{{ personagem.foto.url }}" alt="Foto de {{ personagem.nome }}" class="ficha-foto">
      </div>
    {% endif %}
    <div class="ficha-header-info">
      <h1 class="ficha-title">Ficha de {{ personagem.nome }}</h1>
      <div class="ficha-meta">
        <span class="badge">NP {{ personagem.np|default:'?' }}</span>
        <span class="badge">Usuário: {{ personagem.usuario.username }}</span>
      </div>
    </div>
  </div>

  <div class="ficha-sections-grid">
    <section class="ficha-card">
      <h2 class="ficha-section-title">Custos</h2>
      {% with custos=personagem.custos_detalhados %}
      <ul class="ficha-list pares">
        <li><span class="lbl">Características</span><span class="val">{{ custos.caracteristicas }}</span></li>
        <li><span class="lbl">Defesas</span><span class="val">{{ custos.defesas }}</span></li>
        <li><span class="lbl">Perícias</span><span class="val">{{ custos.pericias }}</span></li>
        <li><span class="lbl">Vantagens</span><span class="val">{{ custos.vantagens }}</span></li>
        <li><span class="lbl">Poderes</span><span class="val">{{ custos.poderes }}</span></li>
        <li><span class="lbl" style="font-weight:bold;">Total</span><span class="val" style="font-weight:bold;">{{ custos.total }}</span></li>
      </ul>
      {% endwith %}
    </section>
    <section class="ficha-card">
      <h2 class="ficha-section-title">Habilidades</h2>
      <!-- Exibir em linhas únicas (sem colunas) -->
      <ul class="ficha-list pares">
        {% for campo in categorias.caracteristicas %}
          <li><span class="lbl">{{ campo|capfirst }}</span><span class="val">{% total_from caracteristicas_totais personagem campo %}</span></li>
        {% endfor %}
      </ul>
    </section>
    <section class="ficha-card" id="defesas-card">
      <h2 class="ficha-section-title">Defesas</h2>
      <!-- Exibir em linhas únicas (sem colunas); marcar cada item com data-key para atualização via JS -->
      <ul class="ficha-list pares" id="defesas-list">
        {% for campo in categorias.defesas %}
          <li data-key="{{ campo }}"><span class="lbl">{{ campo|capfirst }}</span><span class="val">{% total_from defesas_totais personagem campo %}</span></li>
        {% endfor %}
      </ul>
    </section>
    <section class="ficha-card">
      <h2 class="ficha-section-title">Perícias</h2>
      <!-- Exibir em linhas únicas (sem colunas) -->
      <ul class="ficha-list pares">
        {% for campo in categorias.pericias %}
          <li><span class="lbl">{{ campo|capfirst }}</span><span class="val">{% total_from pericias_totais personagem campo %}</span></li>
        {% endfor %}
      </ul>
    </section>
    <section class="ficha-card">
      <h2 class="ficha-section-title">Vantagens</h2>
      <ul class="ficha-list">
        {% for vantagem in personagem.vantagens.all %}
          <li><strong>{{ vantagem.nome }}</strong>{% if vantagem.descricao %} <span class="desc">— {{ vantagem.descricao }}</span>{% endif %}</li>
        {% empty %}
          <li><em>Nenhuma vantagem selecionada.</em></li>
        {% endfor %}
      </ul>
    </section>
    <section class="ficha-card">
      <h2 class="ficha-section-title">Poderes</h2>
      <ul class="ficha-list" id="lista-poderes">
        {% for poder in personagem.poderes.all %}
          {% if not poder.de_item %}
            {% with arr=poder.array|default_if_none:'' %}
              <li data-array="{{ arr }}" data-array-key="{{ arr|lower }}">
                <strong>{{ poder.nome }}</strong>
                {% if arr %}<span class="badge array-badge">Array: {{ arr }}</span>{% endif %}
                <span class="desc">— Ataque: {{ poder.bonus_ataque }}, Efeito: {{ poder.nivel_efeito }}</span>
              </li>
            {% endwith %}
          {% endif %}
        {% empty %}
          <li><em>Nenhum poder adicionado.</em></li>
        {% endfor %}
      </ul>
      <div id="array-groups-container"></div>
      <script>
        document.addEventListener('DOMContentLoaded', function () {
          const list = document.getElementById('lista-poderes');
          if (!list) return;
          const items = Array.from(list.querySelectorAll('li'));
          if (!items.length) return;
          const groups = new Map();
          for (const li of items) {
            const key = (li.getAttribute('data-array-key') || '').trim();
            const name = (li.getAttribute('data-array') || '').trim();
            if (!key) continue; // apenas agrupa quando há nome de Array
            if (!groups.has(key)) groups.set(key, { name, items: [] });
            groups.get(key).items.push(li);
          }
          if (groups.size === 0) return; // nada para agrupar
          const container = document.getElementById('array-groups-container');
          // Cria grupos visuais e move os itens correspondentes
          groups.forEach((group) => {
            const wrapper = document.createElement('div');
            wrapper.className = 'array-group ficha-subcard';
            const title = document.createElement('h3');
            title.className = 'ficha-subtitle';
            title.textContent = `Array: ${group.name}`;
            wrapper.appendChild(title);
            const hint = document.createElement('div');
            hint.className = 'array-hint';
            hint.style.fontSize = '0.9em';
            hint.style.opacity = '0.8';
            hint.textContent = 'Poderes alternativos — use apenas um por vez.';
            wrapper.appendChild(hint);
            const ul = document.createElement('ul');
            ul.className = 'ficha-list';
            group.items.forEach((li) => {
              const badge = li.querySelector('.array-badge');
              if (badge) badge.remove(); // badge não é necessária dentro do grupo
              ul.appendChild(li);
            });
            wrapper.appendChild(ul);
            container.appendChild(wrapper);
          });
          // Se a lista original ficou sem itens (todos estavam em Arrays), mostra um texto opcional
          if (!list.querySelector('li')) {
            const li = document.createElement('li');
            li.innerHTML = '<em>Nenhum poder fora de Array.</em>';
            list.appendChild(li);
          }
        });
      </script>
      <h3 class="ficha-subtitle">Poderes de Itens</h3>
      <ul class="ficha-list">
        {% if poderes_de_item %}
          {% for poder in poderes_de_item %}
            <li><strong>{{ poder.nome }}</strong>{% if poder.item_origem %} <span class="item-origem">({{ poder.item_origem.nome }})</span>{% endif %} <span class="desc">— Ataque: {{ poder.bonus_ataque }}, Efeito: {{ poder.nivel_efeito }}</span></li>
          {% endfor %}
        {% else %}
          <li><em>Nenhum poder de item.</em></li>
        {% endif %}
      </ul>
    </section>
    <section class="ficha-card ficha-inventario">
      <h2 class="ficha-section-title">Inventário</h2>
      <div class="inventario-moedas-inline ficha-moedas">
        <div><strong>Ouro:</strong> {{ personagem.inventario.ouro }}</div>
        <div><strong>Dragon Shard:</strong> {{ personagem.inventario.dragon_shard }}</div>
      </div>
      <div class="ficha-inv-tabela-wrapper">
        <table class="ficha-inv-tabela">
          <thead>
            <tr>
              <th>Nome</th>
              <th>Tipo</th>
              <th>Raridade</th>
              <th>Descrição</th>
              <th>Preço</th>
              <th>Efeitos</th>
            </tr>
          </thead>
          <tbody>
            {% for item in personagem.inventario.itens.all %}
              <tr data-mods="{{ item.mods|default:'{}'|escapejs }}">
                <td class="nome-item"><a href="{% url 'ficha_item' item.id %}">{{ item.nome }}</a></td>
                <td>{{ item.tipo }}</td>
                <td>{{ item.raridade }}</td>
                <td>{{ item.descricao }}</td>
                <td>{{ item.preco }}</td>
                <td class="efeitos-item-cell">
                  <!-- Preenchido por JS para uma visualização amigável -->
                  <span class="efeitos-placeholder"><em>—</em></span>
                  <span class="item-powers-defs" style="display:none;">
                    {% for poder in item.poderes.all %}
                      <span class="item-power-def" data-nome="{{ poder.nome|escape }}"></span>
                    {% endfor %}
                  </span>
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="6"><em>Nenhum item no inventário.</em></td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>
  </div>

  <div class="ficha-acoes">
    {% if pode_editar %}
      <a href="{% url 'editar_personagem' personagem.id %}" class="btn">Editar</a>
    {% endif %}
    <a href="{% url 'listar_personagens' %}" class="btn btn-secondary">Voltar</a>
  </div>
</div>
<script>
// Renderiza efeitos dos itens na ficha (características, defesas, perícias e poderes)
document.addEventListener('DOMContentLoaded', function(){
  function parseRawMods(tr){ try { return JSON.parse(tr.getAttribute('data-mods')||'{}')||{}; } catch(_) { return {}; } }
  function normKey(k){ return (k||'').toString().trim().toLowerCase(); }
  function mapKey(k){
    const n = normKey(k);
    const aliases = {
      'strength':'forca','stamina':'vigor','dexterity':'destreza','agility':'agilidade','fighting':'luta','intellect':'inteligencia','awareness':'prontidao','presence':'presenca',
      'dodge':'esquivar','parry':'aparar','toughness':'resistencia','will':'vontade',
      'força':'forca','inteligência':'inteligencia','prontidão':'prontidao','presença':'presenca','resistência':'resistencia','esquiva':'esquivar',
    };
    return aliases[n] || n;
  }
  function normalizeMods(raw){
    const out = { caracteristicas:{}, defesas:{}, pericias:{} };
    if (!raw || typeof raw !== 'object') return out;
    ['caracteristicas','defesas','pericias'].forEach(sec=>{
      const src = raw[sec];
      if (src && typeof src === 'object') {
        Object.keys(src).forEach(k=>{
          const mk = mapKey(k);
          const v = parseFloat(src[k]);
          if (Number.isFinite(v) && v !== 0) out[sec][mk] = (out[sec][mk]||0) + v;
        });
      }
    });
    Object.keys(raw).forEach(k=>{
      if (['caracteristicas','defesas','pericias'].includes(k)) return;
      const mk = mapKey(k);
      const v = parseFloat(raw[k]);
      if (!Number.isFinite(v) || v===0) return;
      if (['esquivar','aparar','fortitude','vontade','resistencia'].includes(mk)) out.defesas[mk]=(out.defesas[mk]||0)+v;
      else out.caracteristicas[mk]=(out.caracteristicas[mk]||0)+v;
    });
    return out;
  }
  function cap(s){ try { return (s||'').charAt(0).toUpperCase()+String(s||'').slice(1); } catch(_) { return s; } }
  function listFrom(obj, keys){ const parts=[]; if(!obj) return parts; keys.forEach(k=>{ const v=parseFloat(obj[k]); if(Number.isFinite(v) && v!==0){ parts.push((v>0?'+':'')+v+' '+cap(k)); } }); return parts; }
  function poderesFromRow(tr){ return Array.from(tr.querySelectorAll('.item-power-def')).map(s => (s.getAttribute('data-nome')||'').trim()).filter(Boolean); }
  const grupos = {caracteristicas:['forca','vigor','destreza','agilidade','luta','inteligencia','prontidao','presenca'], defesas:['aparar','esquivar','fortitude','vontade','resistencia']};
  const pericias = ['acrobacias','atletismo','combate_distancia','combate_corpo','enganacao','especialidade','furtividade','intimidacao','intuicao','investigacao','percepcao','persuasao','prestidigitacao','tecnologia','tratamento','veiculos','historia','sobrevivencia','arcana','religiao'];
  document.querySelectorAll('.ficha-inv-tabela tbody tr').forEach(tr => {
    const alvo = tr.querySelector('.efeitos-item-cell'); if(!alvo) return;
    const mods = normalizeMods(parseRawMods(tr));
    const car = listFrom(mods.caracteristicas||{}, grupos.caracteristicas);
    const def = listFrom(mods.defesas||{}, grupos.defesas);
    const per = listFrom(mods.pericias||{}, pericias);
    const pods = poderesFromRow(tr);
    const parts = [];
    if (car.length) parts.push('Características: '+car.join(', '));
    if (def.length) parts.push('Defesas: '+def.join(', '));
    if (per.length) parts.push('Perícias: '+(per.length>10? per.slice(0,10).join(', ') + ` e +${per.length-10}` : per.join(', ')));
    if (pods.length) parts.push('Poderes: '+pods.join(', '));
    alvo.innerHTML = parts.length ? parts.map(p=>`<div>${p}</div>`).join('') : '<em>Sem efeitos diretos.</em>';
  });

  // As defesas já vêm totalizadas do servidor; aqui não alteramos os valores do card.
});
</script>
{% endblock %}
