{% extends 'base.html' %}
{% load static %}
{% load filtros %}

{% block content %}
<div class="personagem-form-center">
  <h1 class="personagem-form-title">Editar Personagem</h1>
  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    {# Bloco de erros gerais para facilitar depuração #}
    {% if form.non_field_errors or inventario_form.non_field_errors or form.errors or inventario_form.errors or formset.non_form_errors %}
      <div style="background:#2b1b1b; border:1px solid #a33; color:#f5cccc; padding:10px; margin-bottom:12px;">
        <strong>Erros no formulário:</strong>
        <ul style="margin:6px 0 0 18px;">
          {% for e in form.non_field_errors %}<li>{{ e }}</li>{% endfor %}
          {% for e in formset.non_form_errors %}<li>{{ e }}</li>{% endfor %}
          {% for name, errs in form.errors.items %}
            {% for e in errs %}<li>{{ name }}: {{ e }}</li>{% endfor %}
          {% endfor %}
          {% for name, errs in inventario_form.errors.items %}
            {% for e in errs %}<li>inventário.{{ name }}: {{ e }}</li>{% endfor %}
          {% endfor %}
        </ul>
      </div>
    {% endif %}
    <div class="personagem-form-fields">
      <div id="painel-custos" style="background:#1e1e28; border:1px solid #444; padding:0.8rem 1rem; margin-bottom:1.2rem; font-size:0.95rem; line-height:1.3;">
        <strong>Custos (dinâmico):</strong>
        <div style="display:flex; flex-wrap:wrap; gap:1rem; margin-top:0.4rem;">
          <span>Características: <span id="custo-caracteristicas">0</span></span>
          <span>Defesas: <span id="custo-defesas">0</span></span>
          <span>Perícias: <span id="custo-pericias">0</span></span>
          <span>Vantagens: <span id="custo-vantagens">0</span></span>
          <span>Poderes: <span id="custo-poderes">0</span></span>
          <span style="font-weight:bold;">Total: <span id="custo-total">0</span></span>
        </div>
      </div>
      <div class="linha-topo" style="display:flex; gap:2rem; flex-wrap:wrap; align-items:flex-start;">
        <div class="campo-nome" style="flex:1 1 200px; min-width:180px;">
          {{ form.nome.label_tag }} {{ form.nome }}
        </div>
        <div class="campo-foto" style="flex:2 1 320px; min-width:260px;">
          {{ form.foto.label_tag }} {{ form.foto }}
          {% if form.instance.foto %}
            <br>
            <img src="{{ form.instance.foto.url }}" alt="Foto atual" style="max-width:100px; margin-top:0.4rem;">
          {% endif %}
        </div>
        <div class="campo-np" style="flex:1 1 160px; min-width:140px;">
          {{ form.nivel_poder.label_tag }} {{ form.nivel_poder }}
        </div>
      </div>
  <h2>Características <span id="badge-carac" class="section-cost-badge" title="Cada ponto em Características custa +2 pp.">+2 pp — 0</span></h2>
      <div class="caracteristicas-grid espacamento-campos" style="display:grid; grid-template-columns:repeat(4, minmax(110px,1fr)); gap:1.5rem 2.5rem; justify-items:center;">
        <!-- Linha 1 -->
        <div class="campo-carac">{{ form.forca.label_tag }} {{ form.forca }}{% if form.forca.errors %}<div style="color:red;">{{ form.forca.errors }}</div>{% endif %}</div>
        <div class="campo-carac">{{ form.vigor.label_tag }} {{ form.vigor }}{% if form.vigor.errors %}<div style="color:red;">{{ form.vigor.errors }}</div>{% endif %}</div>
        <div class="campo-carac">{{ form.destreza.label_tag }} {{ form.destreza }}{% if form.destreza.errors %}<div style="color:red;">{{ form.destreza.errors }}</div>{% endif %}</div>
        <div class="campo-carac">{{ form.prontidao.label_tag }} {{ form.prontidao }}{% if form.prontidao.errors %}<div style="color:red;">{{ form.prontidao.errors }}</div>{% endif %}</div>
        <!-- Linha 2 -->
        <div class="campo-carac">{{ form.presenca.label_tag }} {{ form.presenca }}{% if form.presenca.errors %}<div style="color:red;">{{ form.presenca.errors }}</div>{% endif %}</div>
        <div class="campo-carac">{{ form.inteligencia.label_tag }} {{ form.inteligencia }}{% if form.inteligencia.errors %}<div style="color:red;">{{ form.inteligencia.errors }}</div>{% endif %}</div>
        <div class="campo-carac">{{ form.luta.label_tag }} {{ form.luta }}{% if form.luta.errors %}<div style="color:red;">{{ form.luta.errors }}</div>{% endif %}</div>
        <div class="campo-carac">{{ form.agilidade.label_tag }} {{ form.agilidade }}{% if form.agilidade.errors %}<div style="color:red;">{{ form.agilidade.errors }}</div>{% endif %}</div>
      </div>
  <h2>Vantagens <span id="badge-vant" class="section-cost-badge" title="Cada vantagem selecionada custa +1 pp.">+1 pp — 0</span></h2>
      <div style="display: flex; align-items: center; gap: 2rem; margin-bottom: 0.7rem; flex-wrap: wrap;">
        <input type="text" id="busca-vantagem" placeholder="Buscar vantagem..." style="flex: 1 1 250px; min-width: 200px; max-width: 350px;">
        <label for="filtro-vantagem-selecionada" style="display: flex; align-items: center; gap: 0.5rem; font-weight: 600;">
          Vantagens já selecionadas
          <input type="checkbox" id="filtro-vantagem-selecionada" style="margin: 0;">
        </label>
      </div>
      <div class="table-container">
        <table id="tabela-vantagens" class="table-scroll" border="1" style="width:100%;">
          
          <thead>
            <tr>
              <th style="width: 50px;">Sel.</th>
              <th style="min-width: 120px;">Nome</th>
              <th>Descrição</th>
            </tr>
          </thead>
          <tbody>
            {% with vantagens_selecionadas=form.vantagens.value %}
              {% for vantagem in form.fields.vantagens.queryset %}
                <tr>
                  <td style="text-align: center;">
                    <input type="checkbox" name="vantagens" value="{{ vantagem.id }}"
                      {% if vantagens_selecionadas and vantagem.id|stringformat:"s" in vantagens_selecionadas|stringformat:"s" %}checked{% endif %}>
                  </td>
                  <td class="nome-vantagem">{{ vantagem.nome }}</td>
                  <td>{{ vantagem.descricao }}</td>
                </tr>
              {% endfor %}
            {% endwith %}
          </tbody>
        </table>
      </div>
  <h2>Defesas <span id="badge-def" class="section-cost-badge" title="Cada ponto em Defesas custa +1 pp.">+1 pp — 0</span></h2>
      <div class="defesas-grid" style="display:grid; grid-template-columns:repeat(3, minmax(140px,1fr)); gap:1.8rem 3rem; justify-items:center; margin-bottom:2rem;">
        <!-- Linha 1: Aparar, Esquivar, Resistência -->
        <div class="campo-def">{{ form.aparar.label_tag }} {{ form.aparar }}{% if form.aparar.errors %}<div style="color:red;">{{ form.aparar.errors }}</div>{% endif %}</div>
        <div class="campo-def">{{ form.esquivar.label_tag }} {{ form.esquivar }}{% if form.esquivar.errors %}<div style="color:red;">{{ form.esquivar.errors }}</div>{% endif %}</div>
        <div class="campo-def">{{ form.resistencia.label_tag }} {{ form.resistencia }}{% if form.resistencia.errors %}<div style="color:red;">{{ form.resistencia.errors }}</div>{% endif %}</div>
        <!-- Linha 2: Vontade, Fortitude -->
        <div class="campo-def">{{ form.vontade.label_tag }} {{ form.vontade }}{% if form.vontade.errors %}<div style="color:red;">{{ form.vontade.errors }}</div>{% endif %}</div>
        <div class="campo-def">{{ form.fortitude.label_tag }} {{ form.fortitude }}{% if form.fortitude.errors %}<div style="color:red;">{{ form.fortitude.errors }}</div>{% endif %}</div>
        <div></div>
      </div>
  <h2>Perícias <span id="badge-per" class="section-cost-badge" title="Cada ponto em Perícias custa +0,5 pp.">+0,5 pp — 0</span></h2>
      <div>
        {{ form.especialidade_casting_ability.label_tag }} {{ form.especialidade_casting_ability }}
      </div>
  <div class="pericias-grid-4" style="display:grid; grid-template-columns:repeat(4, minmax(140px,1fr)); gap:1.4rem 2.2rem; justify-items:center; margin-bottom:2rem;">
        {% for campo in pericias_col1 %}
          {% with field=form|lookup:campo %}
            <div class="pericia-campo" style="display:flex; flex-direction:column; align-items:center;">
              <label style="font-weight:bold; margin-bottom:0.25rem;">{{ field.label }}</label>
              {{ field }}
              {% if field.errors %}<div style="color:red;">{{ field.errors }}</div>{% endif %}
            </div>
          {% endwith %}
        {% endfor %}
        {% for campo in pericias_col2 %}
          {% with field=form|lookup:campo %}
            <div class="pericia-campo" style="display:flex; flex-direction:column; align-items:center;">
              <label style="font-weight:bold; margin-bottom:0.25rem;">{{ field.label }}</label>
              {{ field }}
              {% if field.errors %}<div style="color:red;">{{ field.errors }}</div>{% endif %}
            </div>
          {% endwith %}
        {% endfor %}
      </div>

  <h2>Poderes <span id="badge-pod" class="section-cost-badge" title="Custo por poder = Nível × (1 + bônus de Tipo + Duração + Modo). Bônus: Tipo: +1 (cura/aprimorar). Duração: +1 (concentração), +2 (sustentado). Modo: +1 (ranged), +2 (área), +3 (percepção). Arrays: custo do grupo = maior base + (n−1); líder paga o maior, demais pagam 1.">Nivel x (1+Tipo+Duração+Modo) — 0</span></h2>
      <div id="empty-poder-form" style="display:none;">
        <div class="poder-form poder-form-grid" style="border:1px solid #444; width:100%; position: relative;">
          <div style="display:none;">
            {{ formset.empty_form.id }}
            {{ formset.empty_form.DELETE }}
          </div>
          <div class="campo-poder">{{ formset.empty_form.nome.label_tag }}{{ formset.empty_form.nome }}</div>
          <div class="campo-poder">{{ formset.empty_form.array.label_tag }}{{ formset.empty_form.array }}</div>
          <div class="campo-poder">{{ formset.empty_form.tipo.label_tag }}{{ formset.empty_form.tipo }}</div>
          <div class="campo-poder">{{ formset.empty_form.modo.label_tag }}{{ formset.empty_form.modo }}</div>
          <div class="campo-poder">{{ formset.empty_form.duracao.label_tag }}{{ formset.empty_form.duracao }}</div>
          <div class="campo-poder">{{ formset.empty_form.casting_ability.label_tag }}{{ formset.empty_form.casting_ability }}</div>
          <div class="campo-poder">{{ formset.empty_form.nivel_efeito.label_tag }}{{ formset.empty_form.nivel_efeito }}</div>
          <div class="campo-poder">{{ formset.empty_form.bonus_ataque.label_tag }}{{ formset.empty_form.bonus_ataque }}</div>
          <div class="campo-poder">{{ formset.empty_form.defesa_ativa.label_tag }}{{ formset.empty_form.defesa_ativa }}</div>
          <div class="campo-poder">{{ formset.empty_form.defesa_passiva.label_tag }}{{ formset.empty_form.defesa_passiva }}</div>
          <div class="campo-poder">{{ formset.empty_form.item_origem.label_tag }}{{ formset.empty_form.item_origem }}</div>
          <div class="campo-poder linha-checkbox">{{ formset.empty_form.de_item }} <label for="{{ formset.empty_form.de_item.id_for_label }}">Poder de Item?</label></div>
          <div class="campo-poder">{{ formset.empty_form.vantagem_origem.label_tag }}{{ formset.empty_form.vantagem_origem }}</div>
          <div class="campo-poder linha-checkbox">{{ formset.empty_form.de_vantagem }} <label for="{{ formset.empty_form.de_vantagem.id_for_label }}">Poder de Vantagem?</label></div>
          <div class="campo-poder span-2">
            <div class="helptext">Ligação automática: poderes com mesmo nome, modo e duração serão ligados ao salvar.</div>
          </div>
          <div class="span-2" style="margin-top:0.4rem; text-align:right; display:flex; gap:0.7rem; justify-content:flex-end;">
            <span style="display:none;">{{ formset.empty_form.DELETE }}</span>
            <button type="button" class="btn btn-danger" onclick="removerPoderLinha(this)">Remover</button>
          </div>
        </div>
      </div>

      <div class="poder-form-outer">
        <div id="poderes-formset">
          {{ formset.management_form }}
          <div style="display: flex; flex-direction: column; gap: 1.5rem; align-items: center;">
            {% for form in formset %}
              <div class="poder-form poder-form-grid" style="border:1px solid #444; width:100%; position: relative;">
                <div style="display:none;">
                  {% for h in form.hidden_fields %}{{ h }}{% endfor %}
                  {% if form.instance.pk %}<input type="hidden" name="{{ form.prefix }}-id" value="{{ form.instance.pk }}">{% endif %}
                  {{ form.DELETE }}
                </div>
                <div class="campo-poder">{{ form.nome.label_tag }}{{ form.nome }}</div>
                <div class="campo-poder">{{ form.array.label_tag }}{{ form.array }}</div>
                <div class="campo-poder">{{ form.tipo.label_tag }}{{ form.tipo }}</div>
                <div class="campo-poder">{{ form.modo.label_tag }}{{ form.modo }}</div>
                <div class="campo-poder">{{ form.duracao.label_tag }}{{ form.duracao }}</div>
                <div class="campo-poder">{{ form.casting_ability.label_tag }}{{ form.casting_ability }}</div>
                <div class="campo-poder">{{ form.nivel_efeito.label_tag }}{{ form.nivel_efeito }}</div>
                <div class="campo-poder">{{ form.bonus_ataque.label_tag }}{{ form.bonus_ataque }}</div>
                <div class="campo-poder">{{ form.defesa_ativa.label_tag }}{{ form.defesa_ativa }}</div>
                <div class="campo-poder">{{ form.defesa_passiva.label_tag }}{{ form.defesa_passiva }}</div>
                <div class="campo-poder">{{ form.item_origem.label_tag }}{{ form.item_origem }}</div>
                <div class="campo-poder linha-checkbox">{{ form.de_item }} <label for="{{ form.de_item.id_for_label }}">Poder de Item?</label></div>
                <div class="campo-poder">{{ form.vantagem_origem.label_tag }}{{ form.vantagem_origem }}</div>
                <div class="campo-poder linha-checkbox">{{ form.de_vantagem }} <label for="{{ form.de_vantagem.id_for_label }}">Poder de Vantagem?</label></div>
                <!-- detalhe do custo por poder (preenchido via JS) -->
                <div class="poder-custo-detalhe" style="grid-column:1 / -1; text-align:right; font-size:0.85rem; color:#cfcfe1; opacity:0.95; padding-top:0.2rem;"></div>
                <div class="campo-poder span-2">
                  <div class="helptext">Ligação automática: poderes com mesmo nome, modo e duração serão ligados ao salvar.</div>
                </div>
                {% if form.DELETE %}
                  <div class="span-2" style="margin-top:0.4rem; text-align: right; display: flex; align-items: center; gap: 0.7rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-danger" onclick="removerPoderLinha(this)">Remover</button>
                  </div>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        </div>
      </div>

      <div style="margin-top:1.5rem; display:flex; gap:1rem; justify-content:center;">
        <button type="button" class="btn btn-danger" onclick="adicionarPoder()">Adicionar Poder</button>
        <button type="button" class="btn btn-danger" onclick="removerPoder()">Remover Último Poder</button>
      </div>

      <div class="inventario-largo">
        <h2>Inventário</h2>
        <div class="inventario-moedas-inline">Ouro: {{ inventario_form.ouro }} &nbsp; Dragon shard: {{ inventario_form.dragon_shard }}</div>
        <div class="inventario-filtros"> 
          <input type="text" id="busca-item" placeholder="Buscar por nome ou descrição...">
          <select id="filtro-raridade" style="min-width:140px;">
            <option value="">Todas raridades</option>
            <option>Common</option>
            <option>Uncommon</option>
            <option>Rare</option>
            <option>Very Rare</option>
            <option>Legendary</option>
            <option>Artifact</option>
            <option>None</option>
            <option>Unknown</option>
            <option>Unknown (Magic)</option>
            <option>Varies</option>
          </select>
          <select id="filtro-tipo" style="min-width:160px;">
            <option value="">Todos tipos</option>
            <option>Melee Weapon</option>
            <option>Ranged Weapon</option>
            <option>Light Armor</option>
            <option>Medium Armor</option>
            <option>Heavy Armor</option>
            <option>Shield</option>
            <option>Ammunition</option>
            <option>Rod</option>
            <option>Wondrous Item</option>
            <option>Trade Good</option>
            <option>Adventuring Gear</option>
            <option>Generic Variant</option>
            <option>Gaming Set</option>
            <option>Tool</option>
            <option>Artisan's Tools</option>
            <option>Instrument</option>
            <option>Spellcasting Focus</option>
            <option>Scroll</option>
            <option>Poison</option>
            <option>Food/Drink</option>
            <option>Explosive</option>
            <option>Ring</option>
            <option>Tack and Harness</option>
            <option>Mount</option>
            <option>Vehicle</option>
            <option>Ship</option>
            <option>Air Vehicle</option>
            <option>Tinker’s Tool (Bundle)</option>
            <option>Space Vehicle</option>
            <option>Idol/Relic</option>
            <option>Other</option>
            <option>martial Weapon, Melee Weapon</option>
            <option>martial Weapon, Ranged Weapon</option>
            <option>simple Weapon, Melee Weapon</option>
            <option>simple Weapon, Ranged Weapon</option>
          </select>
          <label class="check-inline">
            <input type="checkbox" id="filtro-possuido">
            Itens Obtidos
          </label>
        </div>
        <div class="inventario-tabela-wrapper">
          <table id="tabela-itens" class="table-scroll inventario-tabela" border="1">
            <thead>
              <tr>
                <th>Sel.</th>
                <th>Nome</th>
                <th>Tipo</th>
                <th>Raridade</th>
                <th>Descrição</th>
                <th>Preço</th>
              </tr>
            </thead>
            <tbody>
              {% for item in inventario_form.fields.itens.queryset %}
                <tr>
                  <td>
                    <input type="checkbox" name="itens" value="{{ item.id }}"
                      {% if item.id in itens_possuido_ids %}checked{% endif %}>
                  </td>
                  <td class="nome-item">{{ item.nome }}</td>
                  <td class="tipo-item">{{ item.tipo }}</td>
                  <td class="raridade-item">{{ item.raridade }}</td>
                  <td class="descricao-item" style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:260px;" title="{{ item.descricao|striptags }}">{{ item.descricao|truncatechars:80 }}</td>
                  <td>{{ item.preco }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <div style="margin-top:2rem; text-align:center;">
        <input type="submit" value="Salvar" class="btn">
      </div>

    </div>
  </form>
</div>

<script>
// Remove uma linha específica (botão dentro do bloco)
function removerPoderLinha(botao) {
  const formDiv = botao.closest('.poder-form');
  if (!formDiv) return;
  const deleteCheckbox = formDiv.querySelector('input[type="checkbox"][name$="-DELETE"]');
  const totalFormsInput = document.getElementById('id_poder_set-TOTAL_FORMS');
  if (!totalFormsInput) return;

  if (deleteCheckbox) {
    deleteCheckbox.checked = true;
    formDiv.style.display = 'none';
  } else {
    formDiv.remove();
    reindexarPoderes();
  }
  function reindexarPoderes() {
    const forms = document.querySelectorAll('#poderes-formset .poder-form');
    forms.forEach((div, idx) => {
      div.querySelectorAll('[name]').forEach(el => {
        if (el.name.includes('poder_set-')) {
          el.name = el.name.replace(/poder_set-(\d+)-/, 'poder_set-' + idx + '-');
        }
      });
      div.querySelectorAll('[id]').forEach(el => {
        if (el.id && el.id.includes('poder_set-')) {
          el.id = el.id.replace(/poder_set-(\d+)-/, 'poder_set-' + idx + '-');
        }
      });
      div.querySelectorAll('label[for]').forEach(label => {
        if (label.htmlFor && label.htmlFor.includes('poder_set-')) {
          label.htmlFor = label.htmlFor.replace(/poder_set-(\d+)-/, 'poder_set-' + idx + '-');
        }
      });
      const hiddenId = div.querySelector('input[type="hidden"][name$="-id"]');
      if (hiddenId && hiddenId.name.includes('poder_set-')) {
        hiddenId.name = hiddenId.name.replace(/poder_set-(\d+)-/, 'poder_set-' + idx + '-');
        if (!hiddenId.value) hiddenId.value = '';
      }
    });
    totalFormsInput.value = forms.length;
  }
}

function adicionarPoder() {
  const formsetDiv = document.getElementById('poderes-formset');
  const poderesContainer = formsetDiv.querySelector('div[style*="flex-direction: column"]');
  const totalFormsInput = document.getElementById('id_poder_set-TOTAL_FORMS');
  if (!totalFormsInput) {
    console.error('TOTAL_FORMS não encontrado.');
    return;
  }
  const formIdx = parseInt(totalFormsInput.value);
  const emptyDiv = document.getElementById('empty-poder-form').firstElementChild.cloneNode(true);
  emptyDiv.innerHTML = emptyDiv.innerHTML.replace(/__prefix__/g, formIdx);
  const hId = emptyDiv.querySelector('input[type="hidden"][name$="-id"]');
  if (hId) hId.value = '';
  if (poderesContainer) {
    poderesContainer.appendChild(emptyDiv);
  } else {
    formsetDiv.appendChild(emptyDiv);
  }
  totalFormsInput.value = formIdx + 1;
  atualizarCamposOrigem(emptyDiv);
}

function removerPoder() {
  const formsetDiv = document.getElementById('poderes-formset');
  const totalFormsInput = document.getElementById('id_poder_set-TOTAL_FORMS');
  const poderForms = formsetDiv.querySelectorAll('.poder-form');
  const formCount = parseInt(totalFormsInput.value);
  if (formCount > 0) {
    const lastForm = poderForms[poderForms.length - 1];
    const deleteCheckbox = lastForm.querySelector('input[type="checkbox"][name$="DELETE"]');
    if (deleteCheckbox) {
      deleteCheckbox.checked = true;
      lastForm.style.display = 'none';
    } else {
      formsetDiv.removeChild(lastForm);
      totalFormsInput.value = formCount - 1;
    }
  }
}
</script>

<script>
// Filtros de Inventário
document.addEventListener('DOMContentLoaded', function() {
  const busca = document.getElementById('busca-item');
  const filtroPossuido = document.getElementById('filtro-possuido');
  const filtroRaridade = document.getElementById('filtro-raridade');
  const filtroTipo = document.getElementById('filtro-tipo');
  const linhas = document.querySelectorAll('#tabela-itens tbody tr');
  function filtrar() {
    const texto = (busca?.value || '').toLowerCase();
    const soPossuido = !!(filtroPossuido && filtroPossuido.checked);
    const raridadeSel = ((filtroRaridade?.value) || '').toLowerCase();
    const tipoSel = ((filtroTipo?.value) || '').toLowerCase();
    linhas.forEach(tr => {
      const nome = tr.querySelector('.nome-item')?.textContent.toLowerCase() || '';
      const desc = tr.querySelector('.descricao-item')?.textContent.toLowerCase() || '';
      const rar = tr.querySelector('.raridade-item')?.textContent.toLowerCase() || '';
      const tipo = tr.querySelector('.tipo-item')?.textContent.toLowerCase() || '';
      const checkbox = tr.querySelector('input[type="checkbox"][name="itens"]');
      const possuido = checkbox && checkbox.checked;
      const matchTexto = !texto || nome.includes(texto) || desc.includes(texto);
      const matchRaridade = !raridadeSel || rar === raridadeSel;
      const matchTipo = !tipoSel || tipo === tipoSel;
      const matchPossuido = !soPossuido || possuido;
      const mostrar = matchTexto && matchRaridade && matchTipo && matchPossuido;
      tr.style.display = mostrar ? '' : 'none';
    });
  }
  [busca, filtroPossuido, filtroRaridade, filtroTipo].forEach(el => el && el.addEventListener('input', filtrar));
  filtroPossuido && filtroPossuido.addEventListener('change', filtrar);
  filtroRaridade && filtroRaridade.addEventListener('change', filtrar);
  filtroTipo && filtroTipo.addEventListener('change', filtrar);
  filtrar();
});
</script>

<script>
// Filtro de vantagens
document.addEventListener('DOMContentLoaded', function() {
  const busca = document.getElementById('busca-vantagem');
  const filtroSelecionada = document.getElementById('filtro-vantagem-selecionada');
  const linhas = document.querySelectorAll('#tabela-vantagens tbody tr');

  function filtrar() {
    const texto = (busca?.value || '').toLowerCase();
    const soSelecionada = !!(filtroSelecionada && filtroSelecionada.checked);
    linhas.forEach(tr => {
      const nome = tr.querySelector('.nome-vantagem')?.textContent.toLowerCase() || '';
      const checkbox = tr.querySelector('input[type="checkbox"][name="vantagens"]');
      const selecionada = checkbox && checkbox.checked;
      const matchNome = nome.includes(texto);
      const matchSelecionada = !soSelecionada || selecionada;
      tr.style.display = (matchNome && matchSelecionada) ? '' : 'none';
    });
  }

  busca && busca.addEventListener('input', filtrar);
  filtroSelecionada && filtroSelecionada.addEventListener('change', filtrar);
  linhas.forEach(tr => {
    const checkbox = tr.querySelector('input[type="checkbox"][name="vantagens"]');
    if (checkbox) checkbox.addEventListener('change', filtrar);
  });
  filtrar();
});
</script>

<script>
// Campos de origem do poder (itens/vantagens)
document.addEventListener('DOMContentLoaded', function() {
  function atualizarCamposOrigem(poderForm) {
    const deItem = poderForm.querySelector('input[type="checkbox"][name$="de_item"]');
    const deVantagem = poderForm.querySelector('input[type="checkbox"][name$="de_vantagem"]');
    if (deItem && deVantagem) {
      deItem.addEventListener('change', function() { if (deItem.checked) deVantagem.checked = false; });
      deVantagem.addEventListener('change', function() { if (deVantagem.checked) deItem.checked = false; });
    }
  }

  document.querySelectorAll('.poder-form').forEach(function(poderForm) {
    atualizarCamposOrigem(poderForm);
    const deItem = poderForm.querySelector('input[type="checkbox"][name$="de_item"]');
    const deVantagem = poderForm.querySelector('input[type="checkbox"][name$="de_vantagem"]');
    if (deItem) deItem.addEventListener('change', function() { atualizarCamposOrigem(poderForm); });
    if (deVantagem) deVantagem.addEventListener('change', function() { atualizarCamposOrigem(poderForm); });
  });
});
</script>

<script>
// Cálculo Dinâmico de Custos (edição)
document.addEventListener('DOMContentLoaded', function() {
  const camposCaracteristicas = ['forca','vigor','destreza','agilidade','luta','inteligencia','prontidao','presenca'];
  const camposDefesas = ['aparar','esquivar','fortitude','vontade','resistencia'];
  const camposPericias = ['acrobacias','atletismo','combate_distancia','combate_corpo','enganacao','especialidade','furtividade','intimidacao','intuicao','investigacao','percepcao','persuasao','prestidigitacao','tecnologia','tratamento','veiculos','historia','sobrevivencia','arcana','religiao'];

  function val(id){
    const el = document.getElementById('id_'+id);
    if(!el) return 0;
    const v = parseFloat((el.value||'').toString().replace(',', '.'));
    return isNaN(v)?0:v;
  }

  function custoPoderDiv(div){
    function sel(name){ return div.querySelector('[name$="-'+name+'"]'); }
    // Ignora custo se for de item ou de vantagem
    const chItem = div.querySelector('input[type="checkbox"][name$="-de_item"]');
    const chVant = div.querySelector('input[type="checkbox"][name$="-de_vantagem"]');
    if ((chItem && chItem.checked) || (chVant && chVant.checked)) return 0;
    const nivelInput = sel('nivel_efeito');
    if(!nivelInput) return 0;
    let n = parseFloat(nivelInput.value)||0;
    n = Math.abs(n);
    if(n===0) return 0;
    const tipo = (sel('tipo')?.value)||'';
    const dur = (sel('duracao')?.value)||'';
    const modo = (sel('modo')?.value)||'';
    const tipoBonus = (tipo==='cura'||tipo==='aprimorar')?1:0;
    const durBonus = dur==='concentracao'?1:(dur==='sustentado'?2:0);
    const modoBonus = modo==='ranged'?1:(modo==='area'?2:(modo==='percepcao'?3:0));
    const mult = 1 + tipoBonus + durBonus + modoBonus;
    return n * mult;
  }

  function atualizarCustos(){
    const custoCarac = camposCaracteristicas.reduce((s,c)=>s+val(c),0)*2;
    const custoDef = camposDefesas.reduce((s,c)=>s+val(c),0)*1;
    const custoPer = camposPericias.reduce((s,c)=>s+val(c),0)*0.5;
    const custoVant = document.querySelectorAll('input[type="checkbox"][name="vantagens"]:checked').length * 1;
    // Custos de Poderes com Arrays: agrupar por nome do array (case-insensitive)
    const grupos = new Map();
    const individuais = [];
    document.querySelectorAll('.poder-form').forEach(div=>{
      const del = div.querySelector('input[type="checkbox"][name$="-DELETE"]');
      if(del && del.checked) return;
      if(div.style.display==='none') return;
      // Ignora poderes de item/vantagem no custo (custo base já ignora, mas garantimos)
      const chItem = div.querySelector('input[type="checkbox"][name$="-de_item"]');
      const chVant = div.querySelector('input[type="checkbox"][name$="-de_vantagem"]');
      if ((chItem && chItem.checked) || (chVant && chVant.checked)) return;
      const base = custoPoderDiv(div);
      const arrName = (div.querySelector('[name$="-array"]')?.value || '').trim().toLowerCase();
      if (arrName) {
        if (!grupos.has(arrName)) grupos.set(arrName, []);
        grupos.get(arrName).push(base);
      } else {
        individuais.push(base);
      }
    });
    let custoPod = individuais.reduce((a,b)=>a+b,0);
    let temArray = false;
    grupos.forEach(bases=>{
      if (!bases || bases.length===0) return;
      const n = bases.length;
      const maxBase = Math.max.apply(null, bases);
      custoPod += maxBase + Math.max(0, n - 1);
      temArray = true;
    });
    const total = custoCarac + custoDef + custoPer + custoVant + custoPod;
    function fmt(x){ return (Math.round(x*10)%10===0)?x: x.toFixed(1).replace('.0',''); }
    document.getElementById('custo-caracteristicas').textContent = custoCarac;
    document.getElementById('custo-defesas').textContent = custoDef;
    document.getElementById('custo-pericias').textContent = fmt(custoPer);
    document.getElementById('custo-vantagens').textContent = custoVant;
    document.getElementById('custo-poderes').textContent = custoPod;
    document.getElementById('custo-total').textContent = fmt(total);
    // Badges de seção
    const bCar = document.getElementById('badge-carac'); if (bCar){ bCar.textContent = '+2 pp — ' + custoCarac; bCar.title = 'Cada ponto em Características custa +2 pp. Total atual: '+custoCarac; }
    const bDef = document.getElementById('badge-def'); if (bDef){ bDef.textContent = '+1 pp — ' + custoDef; bDef.title = 'Cada ponto em Defesas custa +1 pp. Total atual: '+custoDef; }
    const bPer = document.getElementById('badge-per'); if (bPer){ bPer.textContent = '+0,5 pp — ' + fmt(custoPer); bPer.title = 'Cada ponto em Perícias custa +0,5 pp. Total atual: '+fmt(custoPer); }
    const bVan = document.getElementById('badge-vant'); if (bVan){ bVan.textContent = '+1 pp — ' + custoVant; bVan.title = 'Cada vantagem selecionada custa +1 pp. Total atual: '+custoVant; }
    const bPod = document.getElementById('badge-pod');
    if (bPod){
      bPod.textContent = (temArray? 'Nivel x (1+Tipo+Duração+Modo) + Arrays' : 'Nivel x (1+Tipo+Duração+Modo)') + ' — ' + custoPod;
      bPod.title = 'Custo por poder = Nível × (1 + Tipo + Duração + Modo). Tipo: +1 (cura/aprimorar). Duração: +1 (concentração), +2 (sustentado). Modo: +1 (ranged), +2 (área), +3 (percepção). ' + (temArray ? 'Arrays: grupo = maior base + (n−1); líder paga maior, demais 1. ' : '') + 'Total atual: ' + custoPod;
    }
  }
  window.atualizarCustos = atualizarCustos;

  const watchSelectors = []
    .concat(camposCaracteristicas.map(c=>'#id_'+c))
    .concat(camposDefesas.map(c=>'#id_'+c))
    .concat(camposPericias.map(c=>'#id_'+c))
    .concat(['input[type="checkbox"][name="vantagens"]']);

  function addListeners(){
    watchSelectors.forEach(sel=>{
      document.querySelectorAll(sel).forEach(el=>{
        el.addEventListener('input', atualizarCustos);
        el.addEventListener('change', atualizarCustos);
      });
    });
    document.querySelectorAll('.poder-form select, .poder-form input').forEach(el=>{
      el.addEventListener('input', atualizarCustos);
      el.addEventListener('change', atualizarCustos);
    });
  }
  addListeners();

  const originalAdicionar = window.adicionarPoder;
  window.adicionarPoder = function(){
    if (typeof originalAdicionar === 'function') originalAdicionar();
    setTimeout(()=>{
      const last = document.querySelector('.poder-form:last-child');
      if(last){
        last.querySelectorAll('select, input').forEach(el=>{
          el.addEventListener('input', atualizarCustos);
          el.addEventListener('change', atualizarCustos);
        });
      }
      atualizarCustos();
    },50);
  };
  const originalRemoverLinha = window.removerPoderLinha;
  window.removerPoderLinha = function(btn){
    originalRemoverLinha(btn);
    atualizarCustos();
  }
  const originalRemoverUltimo = window.removerPoder;
  window.removerPoder = function(){
    originalRemoverUltimo();
    atualizarCustos();
  }

  atualizarCustos();
});
</script>

<script>
// Badge de custo por poder (considerando Array)
document.addEventListener('DOMContentLoaded', function(){
  function isDeletedOrHidden(div){
    const del = div.querySelector('input[type="checkbox"][name$="-DELETE"]');
    if (del && del.checked) return true;
    if (div.style.display === 'none') return true;
    return false;
  }
  function isItemOuVant(div){
    const chItem = div.querySelector('input[type="checkbox"][name$="-de_item"]');
    const chVant = div.querySelector('input[type="checkbox"][name$="-de_vantagem"]');
    return (chItem && chItem.checked) || (chVant && chVant.checked);
  }
  function baseDoPoder(div){
    // espelha custoPoderDiv, mas sem regras de Array; já considera item/vantagem
    if (isItemOuVant(div)) return 0;
    const sel = n => div.querySelector('[name$="-'+n+'"]');
    const nivelInput = sel('nivel_efeito');
    if (!nivelInput) return 0;
    let n = parseFloat((nivelInput.value||'').toString().replace(',', '.'))||0;
    n = Math.abs(n);
    if (n === 0) return 0;
    const tipo = (sel('tipo')?.value)||'';
    const dur = (sel('duracao')?.value)||'';
    const modo = (sel('modo')?.value)||'';
    const tipoBonus = (tipo==='cura'||tipo==='aprimorar')?1:0;
    const durBonus = dur==='concentracao'?1:(dur==='sustentado'?2:0);
    const modoBonus = modo==='ranged'?1:(modo==='area'?2:(modo==='percepcao'?3:0));
    const mult = 1 + tipoBonus + durBonus + modoBonus;
    return n * mult;
  }
  function breakdown(div){
    const sel = n => div.querySelector('[name$="-'+n+'"]');
    const nivelInput = sel('nivel_efeito');
    let n = 0; if (nivelInput){ n = parseFloat((nivelInput.value||'').toString().replace(',', '.'))||0; }
    n = Math.abs(n);
    const tipo = (sel('tipo')?.value)||'';
    const dur = (sel('duracao')?.value)||'';
    const modo = (sel('modo')?.value)||'';
    const tipoBonus = (tipo==='cura'||tipo==='aprimorar')?1:0;
    const durBonus = dur==='concentracao'?1:(dur==='sustentado'?2:0);
    const modoBonus = modo==='ranged'?1:(modo==='area'?2:(modo==='percepcao'?3:0));
    const mult = 1 + tipoBonus + durBonus + modoBonus;
    const base = (n||0) * mult;
    return { n, tipoBonus, durBonus, modoBonus, mult, base };
  }
  function ensureBadge(div){
    let b = div.querySelector('.poder-custo-badge');
    if (!b){
      b = document.createElement('span');
      b.className = 'poder-custo-badge';
      div.appendChild(b);
    }
    return b;
  }
  function setDetalhe(div, texto){
    let det = div.querySelector('.poder-custo-detalhe');
    if (!det){
      det = document.createElement('div');
      det.className = 'poder-custo-detalhe';
      det.style.gridColumn = '1 / -1';
      det.style.textAlign = 'right';
      det.style.fontSize = '0.85rem';
      det.style.color = '#cfcfe1';
      det.style.opacity = '0.95';
      det.style.paddingTop = '0.2rem';
      div.appendChild(det);
    }
    det.textContent = texto;
  }
  function updateBadges(){
    const forms = Array.from(document.querySelectorAll('.poder-form'));
    // preparar grupos por array (somente poderes que contam)
    const grupos = new Map();
    const elegiveis = [];
    forms.forEach(div => {
      if (isDeletedOrHidden(div)) return;
  const arr = (div.querySelector('[name$="-array"]')?.value||'').trim().toLowerCase();
  const base = baseDoPoder(div);
  const brk = breakdown(div);
  const excluido = isItemOuVant(div);
  const info = {div, arr, base, excluido, brk};
      elegiveis.push(info);
      if (!excluido && arr){
        if (!grupos.has(arr)) grupos.set(arr, []);
        grupos.get(arr).push(info);
      }
    });
    // identificar líderes de cada grupo (maior base; 1º em caso de empate)
    const lideres = new Map();
    grupos.forEach((lista, arr) => {
      let maxBase = -Infinity;
      let lider = null;
      lista.forEach(info => {
        if (info.base > maxBase){ maxBase = info.base; lider = info; }
      });
      lideres.set(arr, {lider, maxBase, n: lista.length});
    });
    // aplicar custos individuais
    elegiveis.forEach(info => {
      const {div, arr, base, excluido, brk} = info;
      const badge = ensureBadge(div);
      if (excluido){ badge.textContent = 'Custo: 0'; badge.title = 'Este poder não conta custo (Poder de Item/Vantagem).'; setDetalhe(div, 'Item/Vantagem: custo 0'); return; }
      if (!arr){ badge.textContent = 'Custo: ' + base; badge.title = `Base = Nível ${brk.n} × (1 + Tipo ${brk.tipoBonus} + Duração ${brk.durBonus} + Modo ${brk.modoBonus}) = ${base}`; setDetalhe(div, `Sem array • Base: ${brk.n} × (1 + ${brk.tipoBonus}+${brk.durBonus}+${brk.modoBonus}) = ${base}`); return; }
      const meta = lideres.get(arr);
      if (!meta || meta.n <= 0){ badge.textContent = 'Custo: ' + base; badge.title = `Array sem elegíveis; usando base. Base = Nível ${brk.n} × (1 + ${brk.tipoBonus}+${brk.durBonus}+${brk.modoBonus}) = ${base}`; setDetalhe(div, `Array (sem líder) • Base: ${brk.n} × (1 + ${brk.tipoBonus}+${brk.durBonus}+${brk.modoBonus}) = ${base}`); return; }
      const contrib = (meta.lider === info) ? meta.maxBase : 1;
      badge.textContent = 'Custo: ' + contrib;
      badge.title = `Array "${arr}": grupo = ${meta.maxBase} + (${meta.n}-1). Contribuição deste poder: ${contrib}. Base = Nível ${brk.n} × (1 + Tipo ${brk.tipoBonus} + Duração ${brk.durBonus} + Modo ${brk.modoBonus}) = ${base}`;
      const papel = (meta.lider === info) ? 'Líder' : 'Membro';
      setDetalhe(div, `Array: ${arr} • ${papel} • Contrib.: ${contrib} • Base: ${brk.n} × (1 + ${brk.tipoBonus}+${brk.durBonus}+${brk.modoBonus}) = ${base}`);
    });
  }
  window.updateBadges = updateBadges;
  function bindListeners(scope){
    (scope||document).querySelectorAll('.poder-form select, .poder-form input').forEach(el => {
      el.addEventListener('input', updateBadges);
      el.addEventListener('change', updateBadges);
    });
  }
  // hook adicionar/remover
  const oldAdd = window.adicionarPoder;
  window.adicionarPoder = function(){
    if (typeof oldAdd === 'function') oldAdd();
    setTimeout(() => { bindListeners(document); updateBadges(); }, 50);
  };
  const oldRemLinha = window.removerPoderLinha;
  window.removerPoderLinha = function(btn){
    if (typeof oldRemLinha === 'function') oldRemLinha(btn);
    setTimeout(updateBadges, 10);
  };
  const oldRem = window.removerPoder;
  window.removerPoder = function(){
    if (typeof oldRem === 'function') oldRem();
    setTimeout(updateBadges, 10);
  };
  bindListeners(document);
  updateBadges();
});
</script>

{% endblock %}
<!-- Unificador final: garante recálculo de custos e badges após adicionar novo Poder -->
<script>
(function(){
  if(window._addPoderUnified) return; // já aplicado
  window._addPoderUnified = true;
  const prev = window.adicionarPoder;
  window.adicionarPoder = function(){
    if (typeof prev === 'function') prev();
    setTimeout(function(){
      if (typeof atualizarCustos === 'function') { try { atualizarCustos(); } catch(e){} }
      if (typeof updateBadges === 'function') { try { updateBadges(); } catch(e){} }
    }, 60);
  };
})();
</script>
