{% extends 'base.html' %}
{% load static %}
{% load filtros %}

{% block content %}
<div class="personagem-form-center">
  <h1 class="personagem-form-title">Editar Personagem</h1>
  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    {# Bloco de erros gerais para facilitar depuração #}
    {% if form.non_field_errors or inventario_form.non_field_errors or form.errors or inventario_form.errors or formset.non_form_errors %}
      <div style="background:#2b1b1b; border:1px solid #a33; color:#f5cccc; padding:10px; margin-bottom:12px;">
        <strong>Erros no formulário:</strong>
        <ul style="margin:6px 0 0 18px;">
          {% for e in form.non_field_errors %}<li>{{ e }}</li>{% endfor %}
          {% for e in formset.non_form_errors %}<li>{{ e }}</li>{% endfor %}
          {% for name, errs in form.errors.items %}
            {% for e in errs %}<li>{{ name }}: {{ e }}</li>{% endfor %}
          {% endfor %}
          {% for name, errs in inventario_form.errors.items %}
            {% for e in errs %}<li>inventário.{{ name }}: {{ e }}</li>{% endfor %}
          {% endfor %}
        </ul>
      </div>
    {% endif %}
    <div class="personagem-form-fields">
      <div id="painel-custos" style="background:#1e1e28; border:1px solid #444; padding:0.8rem 1rem; margin-bottom:1.2rem; font-size:0.95rem; line-height:1.3;">
        <strong>Custos (dinâmico):</strong>
        <div style="display:flex; flex-wrap:wrap; gap:1rem; margin-top:0.4rem;">
          <span>Características: <span id="custo-caracteristicas">0</span></span>
          <span>Defesas: <span id="custo-defesas">0</span></span>
          <span>Perícias: <span id="custo-pericias">0</span></span>
          <span>Vantagens: <span id="custo-vantagens">0</span></span>
          <span>Poderes: <span id="custo-poderes">0</span></span>
          <span style="font-weight:bold;">Total: <span id="custo-total">0</span></span>
        </div>
      </div>
      <div class="linha-topo" style="display:flex; gap:2rem; flex-wrap:wrap; align-items:flex-start;">
        <div class="campo-nome" style="flex:1 1 200px; min-width:180px;">
          {{ form.nome.label_tag }} {{ form.nome }}
        </div>
        <div class="campo-foto" style="flex:2 1 320px; min-width:260px;">
          {{ form.foto.label_tag }} {{ form.foto }}
          {% if form.instance.foto %}
            <br>
            <img src="{{ form.instance.foto.url }}" alt="Foto atual" style="max-width:100px; margin-top:0.4rem;">
          {% endif %}
        </div>
        <div class="campo-np" style="flex:1 1 160px; min-width:140px;">
          {{ form.nivel_poder.label_tag }} {{ form.nivel_poder }}
        </div>
      </div>
      <h2>Características</h2>
      <div class="caracteristicas-grid espacamento-campos" style="display:grid; grid-template-columns:repeat(4, minmax(110px,1fr)); gap:1.5rem 2.5rem; justify-items:center;">
        <!-- Linha 1 -->
        <div class="campo-carac">{{ form.forca.label_tag }} {{ form.forca }}{% if form.forca.errors %}<div style="color:red;">{{ form.forca.errors }}</div>{% endif %}</div>
        <div class="campo-carac">{{ form.vigor.label_tag }} {{ form.vigor }}{% if form.vigor.errors %}<div style="color:red;">{{ form.vigor.errors }}</div>{% endif %}</div>
        <div class="campo-carac">{{ form.destreza.label_tag }} {{ form.destreza }}{% if form.destreza.errors %}<div style="color:red;">{{ form.destreza.errors }}</div>{% endif %}</div>
        <div class="campo-carac">{{ form.prontidao.label_tag }} {{ form.prontidao }}{% if form.prontidao.errors %}<div style="color:red;">{{ form.prontidao.errors }}</div>{% endif %}</div>
        <!-- Linha 2 -->
        <div class="campo-carac">{{ form.presenca.label_tag }} {{ form.presenca }}{% if form.presenca.errors %}<div style="color:red;">{{ form.presenca.errors }}</div>{% endif %}</div>
        <div class="campo-carac">{{ form.inteligencia.label_tag }} {{ form.inteligencia }}{% if form.inteligencia.errors %}<div style="color:red;">{{ form.inteligencia.errors }}</div>{% endif %}</div>
        <div class="campo-carac">{{ form.luta.label_tag }} {{ form.luta }}{% if form.luta.errors %}<div style="color:red;">{{ form.luta.errors }}</div>{% endif %}</div>
        <div class="campo-carac">{{ form.agilidade.label_tag }} {{ form.agilidade }}{% if form.agilidade.errors %}<div style="color:red;">{{ form.agilidade.errors }}</div>{% endif %}</div>
      </div>
      <h2>Vantagens</h2>
      <div style="display: flex; align-items: center; gap: 2rem; margin-bottom: 0.7rem; flex-wrap: wrap;">
        <input type="text" id="busca-vantagem" placeholder="Buscar vantagem..." style="flex: 1 1 250px; min-width: 200px; max-width: 350px;">
        <label for="filtro-vantagem-selecionada" style="display: flex; align-items: center; gap: 0.5rem; font-weight: 600;">
          Vantagens já selecionadas
          <input type="checkbox" id="filtro-vantagem-selecionada" style="margin: 0;">
        </label>
      </div>
      <div class="table-container">
        <table id="tabela-vantagens" class="table-scroll" border="1" style="width:100%;">
          
          <thead>
            <tr>
              <th style="width: 50px;">Sel.</th>
              <th style="min-width: 120px;">Nome</th>
              <th>Descrição</th>
            </tr>
          </thead>
          <tbody>
            {% with vantagens_selecionadas=form.vantagens.value %}
              {% for vantagem in form.fields.vantagens.queryset %}
                <tr>
                  <td style="text-align: center;">
                    <input type="checkbox" name="vantagens" value="{{ vantagem.id }}"
                      {% if vantagens_selecionadas and vantagem.id|stringformat:"s" in vantagens_selecionadas|stringformat:"s" %}checked{% endif %}>
                  </td>
                  <td class="nome-vantagem">{{ vantagem.nome }}</td>
                  <td>{{ vantagem.descricao }}</td>
                </tr>
              {% endfor %}
            {% endwith %}
          </tbody>
        </table>
      </div>
      <h2>Defesas</h2>
      <div class="defesas-grid" style="display:grid; grid-template-columns:repeat(3, minmax(140px,1fr)); gap:1.8rem 3rem; justify-items:center; margin-bottom:2rem;">
        <!-- Linha 1: Aparar, Esquivar, Resistência -->
        <div class="campo-def">{{ form.aparar.label_tag }} {{ form.aparar }}{% if form.aparar.errors %}<div style="color:red;">{{ form.aparar.errors }}</div>{% endif %}</div>
        <div class="campo-def">{{ form.esquivar.label_tag }} {{ form.esquivar }}{% if form.esquivar.errors %}<div style="color:red;">{{ form.esquivar.errors }}</div>{% endif %}</div>
        <div class="campo-def">{{ form.resistencia.label_tag }} {{ form.resistencia }}{% if form.resistencia.errors %}<div style="color:red;">{{ form.resistencia.errors }}</div>{% endif %}</div>
        <!-- Linha 2: Vontade, Fortitude -->
        <div class="campo-def">{{ form.vontade.label_tag }} {{ form.vontade }}{% if form.vontade.errors %}<div style="color:red;">{{ form.vontade.errors }}</div>{% endif %}</div>
        <div class="campo-def">{{ form.fortitude.label_tag }} {{ form.fortitude }}{% if form.fortitude.errors %}<div style="color:red;">{{ form.fortitude.errors }}</div>{% endif %}</div>
        <div></div>
      </div>
      <h2>Perícias</h2>
      <div>
        {{ form.especialidade_casting_ability.label_tag }} {{ form.especialidade_casting_ability }}
      </div>
  <div class="pericias-grid-4" style="display:grid; grid-template-columns:repeat(4, minmax(140px,1fr)); gap:1.4rem 2.2rem; justify-items:center; margin-bottom:2rem;">
        {% for campo in pericias_col1 %}
          {% with field=form|lookup:campo %}
            <div class="pericia-campo" style="display:flex; flex-direction:column; align-items:center;">
              <label style="font-weight:bold; margin-bottom:0.25rem;">{{ field.label }}</label>
              {{ field }}
              {% if field.errors %}<div style="color:red;">{{ field.errors }}</div>{% endif %}
            </div>
          {% endwith %}
        {% endfor %}
        {% for campo in pericias_col2 %}
          {% with field=form|lookup:campo %}
            <div class="pericia-campo" style="display:flex; flex-direction:column; align-items:center;">
              <label style="font-weight:bold; margin-bottom:0.25rem;">{{ field.label }}</label>
              {{ field }}
              {% if field.errors %}<div style="color:red;">{{ field.errors }}</div>{% endif %}
            </div>
          {% with
