{% extends 'base.html' %}
{% load static %}
{% load filtros %}

{% block content %}
<style>
input[type="checkbox"][name$="DELETE"] {
  display: none;
}
</style>
  <h1>Editar Personagem</h1>
  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    
    <div>{{ form.nome.label_tag }} {{ form.nome }}</div>
    <div>{{ form.nivel_poder.label_tag }} {{ form.nivel_poder }}</div>

  <div>
    {{ form.foto.label_tag }} {{ form.foto }}
    {% if form.foto.value %}
      <br>
      <img src="{{ form.foto.value.url }}" alt="Foto atual" style="max-width:100px;">
    {% endif %}
  </div>

    <h2>Características</h2>
    {% for campo in caracteristicas %}
      <div>
        {% with field=form|lookup:campo %}
          {{ field.label_tag }} {{ field }}
        {% endwith %}
      </div>
    {% endfor %}

    <h2>Defesas</h2>
    {% for campo in defesas %}
      <div>
        {% with field=form|lookup:campo %}
          {{ field.label_tag }} {{ field }}
        {% endwith %}
      </div>
    {% endfor %}

    <h2>Perícias</h2>
  <div>
  {{ form.especialidade_casting_ability.label_tag }} {{ form.especialidade_casting_ability }}
</div>

  {% for campo in pericias %}
    {% with field=form|lookup:campo %}
      <div>{{ field.label_tag }} {{ field }}</div>
    {% endwith %}
  {% endfor %}

    <h2>Poderes</h2>
<div id="poderes-formset">
  {{ formset.management_form }}
{% for form in formset %}
  <div class="poder-form">
    {% for field in form %}
      {% if field.name != 'DELETE' %}
        {{ field.label_tag }} {{ field }}
      {% else %}
        {{ field }}
      {% endif %}
    {% endfor %}
  </div>
{% endfor %}

<!-- ...campos do formulário... -->

{% if form.non_field_errors %}
  <div style="color: red; margin-bottom: 1em;">
    {% for error in form.non_field_errors %}
      <div>{{ error }}</div>
    {% endfor %}
  </div>
{% endif %}

{% if formset.non_form_errors %}
  <div style="color: red; margin-bottom: 1em;">
    {% for error in formset.non_form_errors %}
      <div>{{ error }}</div>
    {% endfor %}
  </div>
{% endif %}

</div>

    <button type="button" onclick="adicionarPoder()">Adicionar Poder</button>
    <button type="button" onclick="removerPoder()">Remover Último Poder</button>
    <br><br>
    <input type="submit" value="Salvar Alterações">
  </form>

<script>
function adicionarPoder() {
  const formsetDiv = document.getElementById('poderes-formset');
  const totalFormsInput = document.getElementById('id_poder_set-TOTAL_FORMS');

  if (!totalFormsInput) {
    console.error('TOTAL_FORMS não encontrado.');
    return;
  }

  const formIdx = parseInt(totalFormsInput.value);
  const emptyFormHtml = `{{ formset.empty_form.as_p|escapejs }}`;
  const newFormHtml = emptyFormHtml.replace(/__prefix__/g, formIdx);

  const wrapper = document.createElement('div');
  wrapper.classList.add('poder-form'); // <-- Adicione esta linha!
  wrapper.innerHTML = newFormHtml;
  formsetDiv.appendChild(wrapper);

  totalFormsInput.value = formIdx + 1;
}
</script>

<script>
function removerPoder() {
  const formsetDiv = document.getElementById('poderes-formset');
  const poderForms = formsetDiv.querySelectorAll('.poder-form');
  if (poderForms.length === 0) return;

  const lastForm = poderForms[poderForms.length - 1];
  const deleteCheckbox = lastForm.querySelector('input[type="checkbox"][name$="DELETE"]');

  if (deleteCheckbox) {
    // Poder já salvo: marca para deletar e esconde visualmente
    deleteCheckbox.checked = true;
    lastForm.style.display = 'none';
  } else {
    // Poder novo: remove do DOM e atualiza TOTAL_FORMS
    lastForm.remove();
    const totalFormsInput = document.getElementById('id_poder_set-TOTAL_FORMS');
    totalFormsInput.value = poderForms.length - 1;
  }
}
</script>

{% endblock %}
