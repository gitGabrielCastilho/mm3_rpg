{% extends 'base.html' %}
{% load static %}
{% load filtros %}

{% block content %}
<div class="personagem-form-center">
  <h1 class="personagem-form-title">Editar Personagem</h1>
  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <div class="personagem-form-fields">
      <div class="linha-nome-full">
        <div class="campo-nome-full">{{ form.nome.label_tag }} {{ form.nome }}</div>
      </div>
      <div class="linha-foto-np">
        <div class="campo-foto">
          {{ form.foto.label_tag }} {{ form.foto }}
          {% if form.foto.value %}
            <br>
            <img src="{{ form.foto.value.url }}" alt="Foto atual" style="max-width:100px;">
          {% endif %}
        </div>
        <div class="campo-np">
          {{ form.nivel_poder.label_tag }} {{ form.nivel_poder }}
        </div>
      </div>
      <h2>Características</h2>
      <div class="caracteristicas-grid espacamento-campos">
        {% for campo in caracteristicas %}
          <div class="campo-carac">
            {% with field=form|lookup:campo %}
              {{ field.label_tag }} {{ field }}
              {% if field.errors %}
                <div style="color:red;">{{ field.errors }}</div>
              {% endif %}
            {% endwith %}
          </div>
        {% endfor %}
      </div>
      <h2>Vantagens</h2>
      <div style="display: flex; align-items: center; gap: 2rem; margin-bottom: 0.7rem; flex-wrap: wrap;">
        <input type="text" id="busca-vantagem" placeholder="Buscar vantagem..." style="flex: 1 1 250px; min-width: 200px; max-width: 350px;">
        <label for="filtro-vantagem-selecionada" style="display: flex; align-items: center; gap: 0.5rem; font-weight: 600;">
          Vantagens já selecionadas
          <input type="checkbox" id="filtro-vantagem-selecionada" style="margin: 0;">
        </label>
      </div>
      <div style="max-height: 250px; overflow-y: auto;">
        <table id="tabela-vantagens" border="1" style="width:100%;">
          <thead>
            <tr>
              <th style="width: 60px;">Selecionar</th>
              <th style="min-width: 140px;">Nome</th>
              <th>Descrição</th>
            </tr>
          </thead>
          <tbody>
            {% with vantagens_selecionadas=form.vantagens.value %}
              {% for vantagem in form.fields.vantagens.queryset %}
                <tr>
                  <td style="text-align: center;">
                    <input type="checkbox" name="vantagens" value="{{ vantagem.id }}"
                      {% if vantagens_selecionadas and vantagem.id|stringformat:"s" in vantagens_selecionadas|stringformat:"s" %}checked{% endif %}>
                  </td>
                  <td class="nome-vantagem">{{ vantagem.nome }}</td>
                  <td>{{ vantagem.descricao }}</td>
                </tr>
              {% endfor %}
            {% endwith %}
          </tbody>
        </table>
      </div>
      <h2>Defesas</h2>
      <div class="defesas-duas-colunas">
        <div class="defesas-coluna">
          {% for campo in defesas|slice:':2' %}
            <div class="campo-def">
              {% with field=form|lookup:campo %}
                {{ field.label_tag }} {{ field }}
                {% if field.errors %}
                  <div style="color:red;">{{ field.errors }}</div>
                {% endif %}
              {% endwith %}
            </div>
          {% endfor %}
        </div>
        <div class="defesas-coluna">
          {% for campo in defesas|slice:'2:' %}
            <div class="campo-def">
              {% with field=form|lookup:campo %}
                {{ field.label_tag }} {{ field }}
                {% if field.errors %}
                  <div style="color:red;">{{ field.errors }}</div>
                {% endif %}
              {% endwith %}
            </div>
          {% endfor %}
        </div>
      </div>
      <h2>Perícias</h2>
      <div>
        {{ form.especialidade_casting_ability.label_tag }} {{ form.especialidade_casting_ability }}
      </div>
      {% if pericias_col1 and pericias_col2 %}
      <div class="pericias-duas-colunas">
        <div class="pericias-coluna">
          {% for campo in pericias_col1 %}
            {% with field=form|lookup:campo %}
              <label style="font-weight: bold; margin-bottom: 0.2rem;">{{ field.label }}</label>
              {{ field }}
              {% if field.errors %}
                <div style="color:red;">{{ field.errors }}</div>
              {% endif %}
            {% endwith %}
          {% endfor %}
        </div>
        <div class="pericias-coluna">
          {% for campo in pericias_col2 %}
            {% with field=form|lookup:campo %}
              <label style="font-weight: bold; margin-bottom: 0.2rem;">{{ field.label }}</label>
              {{ field }}
              {% if field.errors %}
                <div style="color:red;">{{ field.errors }}</div>
              {% endif %}
            {% endwith %}
          {% endfor %}
        </div>
      </div>
      {% endif %}
      <h2>Poderes</h2>
      <div id="poderes-formset">
        {{ formset.management_form }}
        {% for form in formset %}
          <div class="poder-form" style="border:1px solid #ccc; margin-bottom:1em; padding:1em;">
            <div>
              {{ form.nome.label_tag }} {{ form.nome }}
            </div>
            <div>
              {{ form.tipo.label_tag }} {{ form.tipo }}
              {{ form.modo.label_tag }} {{ form.modo }}
              {{ form.nivel_efeito.label_tag }} {{ form.nivel_efeito }}
              {{ form.bonus_ataque.label_tag }} {{ form.bonus_ataque }}
              {{ form.defesa_ativa.label_tag }} {{ form.defesa_ativa }}
              {{ form.defesa_passiva.label_tag }} {{ form.defesa_passiva }}
              {{ form.casting_ability.label_tag }} {{ form.casting_ability }}
            </div>
            <div>
              {{ form.de_item.label_tag }} {{ form.de_item }}
              {{ form.item_origem.label_tag }} {{ form.item_origem }}
            </div>
            <div>
              {{ form.de_vantagem.label_tag }} {{ form.de_vantagem }}
              {{ form.vantagem_origem.label_tag }} {{ form.vantagem_origem }}
            </div>
            {% if form.DELETE %}
              <div style="margin-top: 1em;">
                {{ form.DELETE }} <button type="button" onclick="removerPoder()">Remover</button>
              </div>
            {% endif %}
          </div>
        {% endfor %}
      </div>
      <div class="personagem-form-btns">
        <button type="button" onclick="adicionarPoder()">Adicionar Poder</button>
        <button type="button" onclick="removerPoder()">Remover Último Poder</button>
      </div>
      <h2>Inventário</h2>
      <div>
        Ouro: {{ inventario_form.ouro }}
      </div>
      <div>
        Dragon shard: {{ inventario_form.dragon_shard }}
      </div>
      <input type="text" id="busca-item" placeholder="Buscar por nome...">
      <select id="filtro-raridade">
        <option value="">All rarities</option>
        <option value="Common">Common</option>
        <option value="Uncommon">Uncommon</option>
        <option value="Rare">Rare</option>
        <option value="Very Rare">Very Rare</option>
        <option value="Legendary">Legendary</option>
        <option value="Artifact">Artifact</option>
        <option value="None">None</option>
        <option value="Unknown">Unknown</option>
        <option value="Unknown (Magic)">Unknown (Magic)</option>
        <option value="Varies">Varies</option>
      </select>
      <select id="filtro-tipo">
        <option value="">All types</option>
        <option value="Melee Weapon">Melee Weapon</option>
        <option value="Ranged Weapon">Ranged Weapon</option>
        <option value="Light Armor">Light Armor</option>
        <option value="Medium Armor">Medium Armor</option>
        <option value="Heavy Armor">Heavy Armor</option>
        <option value="Shield">Shield</option>
        <option value="Ammunition">Ammunition</option>
        <option value="Rod">Rod</option>
        <option value="Wondrous Item">Wondrous Item</option>
        <option value="Trade Good">Trade Good</option>
        <option value="Adventuring Gear">Adventuring Gear</option>
        <option value="Generic Variant">Generic Variant</option>
        <option value="Gaming Set">Gaming Set</option>
        <option value="Tool">Tool</option>
        <option value="Artisan's Tools">Artisan's Tools</option>
        <option value="Instrument">Instrument</option>
        <option value="Spellcasting Focus">Spellcasting Focus</option>
        <option value="Scroll">Scroll</option>
        <option value="Poison">Poison</option>
        <option value="Food/Drink">Food/Drink</option>
        <option value="Explosive">Explosive</option>
        <option value="Ring">Ring</option>
        <option value="Tack and Harness">Tack and Harness</option>
        <option value="Mount">Mount</option>
        <option value="Vehicle">Vehicle</option>
        <option value="Ship">Ship</option>
        <option value="Air Vehicle">Air Vehicle</option>
        <option value="Tinker’s Tool (Bundle)">Tinker’s Tool (Bundle)</option>
        <option value="Space Vehicle">Space Vehicle</option>
        <option value="Idol/Relic">Idol/Relic</option>
        <option value="Other">Other</option>
      </select>
      <label>
        <input type="checkbox" id="filtro-possuido">
        Mostrar apenas itens já possuídos
      </label>
      <div style="max-height: 350px; overflow-y: auto;">
        <table id="tabela-itens" border="1" style="width:100%;">
          <thead>
            <tr>
              <th>Selecionar</th>
              <th>Nome</th>
              <th>Tipo</th>
              <th>Raridade</th>
              <th>Descrição</th>
              <th>Preço</th>
            </tr>
          </thead>
          <tbody>
            {% for item in inventario_form.fields.itens.queryset %}
              <tr>
                <td>
                  <input type="checkbox" name="itens" value="{{ item.id }}"
                    {% if item in inventario_form.instance.itens.all %}checked{% endif %}>
                </td>
                <td class="nome-item">{{ item.nome }}</td>
                <td>{{ item.tipo }}</td>
                <td class="raridade-item">{{ item.raridade }}</td>
                <td>{{ item.descricao }}</td>
                <td>{{ item.preco }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div style="margin-top:2rem; text-align:center;">
  <input type="submit" value="Salvar" class="btn">
      </div>
    </div>
  </form>
</div>

<script>
function adicionarPoder() {
  const formsetDiv = document.getElementById('poderes-formset');
  const totalFormsInput = document.getElementById('id_poder_set-TOTAL_FORMS');

  if (!totalFormsInput) {
    console.error('TOTAL_FORMS não encontrado.');
    return;
  }

  const formIdx = parseInt(totalFormsInput.value);
  const emptyFormHtml = `{{ formset.empty_form.as_p|escapejs }}`;
  const newFormHtml = emptyFormHtml.replace(/__prefix__/g, formIdx);

  const wrapper = document.createElement('div');
  wrapper.classList.add('poder-form');
  wrapper.innerHTML = newFormHtml;
  formsetDiv.appendChild(wrapper);

  totalFormsInput.value = formIdx + 1;

  // Atualiza campos de origem para o novo poder
  atualizarCamposOrigem(wrapper);
}
</script>

<script>
function removerPoder() {
  const formsetDiv = document.getElementById('poderes-formset');
  const poderForms = formsetDiv.querySelectorAll('.poder-form');
  if (poderForms.length === 0) return;

  const lastForm = poderForms[poderForms.length - 1];
  const deleteCheckbox = lastForm.querySelector('input[type="checkbox"][name$="DELETE"]');

  if (deleteCheckbox) {
    // Poder já salvo: marca para deletar e esconde visualmente
    deleteCheckbox.checked = true;
    lastForm.style.display = 'none';
  } else {
    // Poder novo: remove do DOM e atualiza TOTAL_FORMS
    lastForm.remove();
    const totalFormsInput = document.getElementById('id_poder_set-TOTAL_FORMS');
    totalFormsInput.value = poderForms.length - 1;
  }
}
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const busca = document.getElementById('busca-item');
  const filtroRaridade = document.getElementById('filtro-raridade');
  const filtroTipo = document.getElementById('filtro-tipo');
  const filtroPossuido = document.getElementById('filtro-possuido');
  const linhas = document.querySelectorAll('#tabela-itens tbody tr');

  function filtrar() {
    const texto = busca.value.toLowerCase();
    const raridade = filtroRaridade.value.toLowerCase();
    const tipo = filtroTipo.value.toLowerCase();
    const soPossuido = filtroPossuido.checked;

    linhas.forEach(tr => {
      const nome = tr.querySelector('.nome-item').textContent.toLowerCase();
      const rar = tr.querySelector('.raridade-item').textContent.toLowerCase();
      const tipoItem = tr.children[2].textContent.toLowerCase();
      const checkbox = tr.querySelector('input[type="checkbox"][name="itens"]');
      const possuido = checkbox && checkbox.checked;

      const matchNome = nome.includes(texto);
      const matchRaridade = !raridade || rar === raridade;
      const matchTipo = !tipo || tipoItem === tipo;
      const matchPossuido = !soPossuido || possuido;

      if (matchNome && matchRaridade && matchTipo && matchPossuido) {
        tr.style.display = '';
      } else {
        tr.style.display = 'none';
      }
    });
  }

  busca.addEventListener('input', filtrar);
  filtroRaridade.addEventListener('change', filtrar);
  filtroTipo.addEventListener('change', filtrar);
  filtroPossuido.addEventListener('change', filtrar);
  filtrar();
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const busca = document.getElementById('busca-vantagem');
  const filtroSelecionada = document.getElementById('filtro-vantagem-selecionada');
  const linhas = document.querySelectorAll('#tabela-vantagens tbody tr');

  function filtrar() {
    const texto = busca.value.toLowerCase();
    const soSelecionada = filtroSelecionada.checked;

    linhas.forEach(tr => {
      const nome = tr.querySelector('.nome-vantagem').textContent.toLowerCase();
      const checkbox = tr.querySelector('input[type="checkbox"][name="vantagens"]');
      const selecionada = checkbox && checkbox.checked;

      const matchNome = nome.includes(texto);
      const matchSelecionada = !soSelecionada || selecionada;

      if (matchNome && matchSelecionada) {
        tr.style.display = '';
      } else {
        tr.style.display = 'none';
      }
    });
  }

  busca.addEventListener('input', filtrar);
  filtroSelecionada.addEventListener('change', filtrar);
  linhas.forEach(tr => {
    const checkbox = tr.querySelector('input[type="checkbox"][name="vantagens"]');
    if (checkbox) checkbox.addEventListener('change', filtrar);
  });
  filtrar();
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  function atualizarCamposOrigem(poderForm) {
    const deItem = poderForm.querySelector('input[type="checkbox"][name$="de_item"]');
    const deVantagem = poderForm.querySelector('input[type="checkbox"][name$="de_vantagem"]');
    // const itemOrigem = poderForm.querySelector('select[name$="item_origem"]');
    // const vantagemOrigem = poderForm.querySelector('select[name$="vantagem_origem"]');
    // const itemOrigemDiv = itemOrigem ? itemOrigem.parentElement : null;
    // const vantagemOrigemDiv = vantagemOrigem ? vantagemOrigem.parentElement : null;

    // REMOVA OU COMENTE AS LINHAS ABAIXO:
    // if (deItem && itemOrigemDiv) {
    //   itemOrigemDiv.style.display = deItem.checked ? '' : 'none';
    // }
    // if (deVantagem && vantagemOrigemDiv) {
    //   vantagemOrigemDiv.style.display = deVantagem.checked ? '' : 'none';
    // }

    // Impede marcar ambos ao mesmo tempo
    if (deItem && deVantagem) {
      deItem.addEventListener('change', function() {
        if (deItem.checked) deVantagem.checked = false;
      });
      deVantagem.addEventListener('change', function() {
        if (deVantagem.checked) deItem.checked = false;
      });
    }
  }

  document.querySelectorAll('.poder-form').forEach(function(poderForm) {
    atualizarCamposOrigem(poderForm);
    // Atualiza ao mudar checkboxes
    const deItem = poderForm.querySelector('input[type="checkbox"][name$="de_item"]');
    const deVantagem = poderForm.querySelector('input[type="checkbox"][name$="de_vantagem"]');
    if (deItem) deItem.addEventListener('change', function() { atualizarCamposOrigem(poderForm); });
    if (deVantagem) deVantagem.addEventListener('change', function() { atualizarCamposOrigem(poderForm); });
  });
});
</script>
{% endblock %}
