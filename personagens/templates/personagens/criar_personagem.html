{% extends 'base.html' %}
{% load static %}
{% load filtros %}

{% block content %}
<div class="personagem-form-center">
  <h1 class="personagem-form-title">Criar Personagem</h1>
  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    {% if form.non_field_errors or inventario_form.non_field_errors or form.errors or inventario_form.errors or formset.non_form_errors %}
      <div class="form-rule-errors">
        <strong>Erros no formulário:</strong>
        <ul>
          {% for e in form.non_field_errors %}<li>{{ e }}</li>{% endfor %}
          {% for e in formset.non_form_errors %}<li>{{ e }}</li>{% endfor %}
          {% for name, errs in form.errors.items %}
            {% for e in errs %}<li>{{ name }}: {{ e }}</li>{% endfor %}
          {% endfor %}
          {% for name, errs in inventario_form.errors.items %}
            {% for e in errs %}<li>inventário.{{ name }}: {{ e }}</li>{% endfor %}
          {% endfor %}
        </ul>
      </div>
    {% endif %}
    <div class="personagem-form-fields">
      <div id="painel-custos" style="background:#1e1e28; border:1px solid #444; padding:0.8rem 1rem; margin-bottom:1.2rem; font-size:0.95rem; line-height:1.3;">
        <strong>Custos (dinâmico):</strong>
        <div style="display:flex; flex-wrap:wrap; gap:1rem; margin-top:0.4rem;">
          <span>Características: <span id="custo-caracteristicas">0</span></span>
          <span>Defesas: <span id="custo-defesas">0</span></span>
          <span>Perícias: <span id="custo-pericias">0</span></span>
          <span>Vantagens: <span id="custo-vantagens">0</span></span>
          <span>Poderes: <span id="custo-poderes">0</span></span>
          <span style="font-weight:bold;">Total: <span id="custo-total">0</span></span>
        </div>
      </div>
      {# Bloco visual antigo de "Poderes de Itens" removido: sincronização agora só afeta efeitos/custos #}
      <div class="linha-topo" style="display:flex; gap:2rem; flex-wrap:wrap; align-items:flex-start;">
        <div class="campo-nome" style="flex:1 1 200px; min-width:180px;">
          {{ form.nome.label_tag }} {{ form.nome }}
        </div>
        <div class="campo-foto" style="flex:2 1 320px; min-width:260px;">
          {{ form.foto.label_tag }} {{ form.foto }}
          {% if form.instance.foto %}
            <br>
            <img src="{{ form.instance.foto.url }}" alt="Foto atual" style="max-width:100px; margin-top:0.4rem;">
          {% endif %}
        </div>
        <div class="campo-np" style="flex:1 1 160px; min-width:140px;">
          {{ form.nivel_poder.label_tag }} {{ form.nivel_poder }}
        </div>
      </div>
  <h2>Características <span id="badge-carac" class="section-cost-badge" title="Cada ponto em Características custa +2 pp.">+2 pp — 0</span></h2>
  <div class="caracteristicas-grid espacamento-campos" style="display:grid; grid-template-columns:repeat(4, minmax(110px,1fr)); gap:1.5rem 2.5rem; justify-items:center;">
        <!-- Linha 1 -->
        <div class="campo-carac">{{ form.forca.label_tag }} {{ form.forca }}{% if form.forca.errors %}<div style="color:red;">{{ form.forca.errors }}</div>{% endif %}</div>
        <div class="campo-carac">{{ form.vigor.label_tag }} {{ form.vigor }}{% if form.vigor.errors %}<div style="color:red;">{{ form.vigor.errors }}</div>{% endif %}</div>
        <div class="campo-carac">{{ form.destreza.label_tag }} {{ form.destreza }}{% if form.destreza.errors %}<div style="color:red;">{{ form.destreza.errors }}</div>{% endif %}</div>
        <div class="campo-carac">{{ form.prontidao.label_tag }} {{ form.prontidao }}{% if form.prontidao.errors %}<div style="color:red;">{{ form.prontidao.errors }}</div>{% endif %}</div>
  <!-- Linha 2 -->
        <div class="campo-carac">{{ form.presenca.label_tag }} {{ form.presenca }}{% if form.presenca.errors %}<div style="color:red;">{{ form.presenca.errors }}</div>{% endif %}</div>
        <div class="campo-carac">{{ form.inteligencia.label_tag }} {{ form.inteligencia }}{% if form.inteligencia.errors %}<div style="color:red;">{{ form.inteligencia.errors }}</div>{% endif %}</div>
        <div class="campo-carac">{{ form.luta.label_tag }} {{ form.luta }}{% if form.luta.errors %}<div style="color:red;">{{ form.luta.errors }}</div>{% endif %}</div>
        <div class="campo-carac">{{ form.agilidade.label_tag }} {{ form.agilidade }}{% if form.agilidade.errors %}<div style="color:red;">{{ form.agilidade.errors }}</div>{% endif %}</div>
      </div>
  <h2>Vantagens <span id="badge-vant" class="section-cost-badge" title="Cada vantagem selecionada custa +1 pp.">+1 pp — 0</span></h2>
      <div style="display: flex; align-items: center; gap: 2rem; margin-bottom: 0.7rem; flex-wrap: wrap;">
        <input type="text" id="busca-vantagem" placeholder="Buscar vantagem..." style="flex: 1 1 250px; min-width: 200px; max-width: 350px;">
        <label for="filtro-vantagem-selecionada" style="display: flex; align-items: center; gap: 0.5rem; font-weight: 600;">
          Vantagens já selecionadas
          <input type="checkbox" id="filtro-vantagem-selecionada" style="margin: 0;">
        </label>
      </div>
      <div class="table-container">
        <table id="tabela-vantagens" class="table-scroll" border="1" style="width:100%;">
          
          <thead>
            <tr>
              <th style="width: 50px;">Sel.</th>
              <th style="min-width: 120px;">Nome</th>
              <th>Descrição</th>
            </tr>
          </thead>
          <tbody>
            {% for vantagem in form.fields.vantagens.queryset %}
              <tr>
                <td style="text-align: center;">
                  <input type="checkbox" name="vantagens" value="{{ vantagem.id }}"
                    {% if vantagem.id|stringformat:"s" in form.vantagens.value %}checked{% endif %}>
                </td>
                <td class="nome-vantagem">{{ vantagem.nome }}</td>
                <td>{{ vantagem.descricao }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
  <h2>Defesas <span id="badge-def" class="section-cost-badge" title="Cada ponto em Defesas custa +1 pp.">+1 pp — 0</span></h2>
      <div class="defesas-grid" style="display:grid; grid-template-columns:repeat(3, minmax(170px,1fr)); gap:1.8rem 3rem; justify-items:center; margin-bottom:2rem;">
        <!-- Linha 1: Aparar (Luta), Esquivar (Agilidade), Resistência (Vigor) -->
        <div class="campo-def">
          <label for="id_aparar">Aparar <small>(Luta)</small></label>
          {{ form.aparar }}
          <div class="defesa-total" data-defesa="aparar">Total: <span class="valor-total" id="total_aparar">0</span></div>
          {% if form.aparar.errors %}<div style="color:red;">{{ form.aparar.errors }}</div>{% endif %}
        </div>
        <div class="campo-def">
          <label for="id_esquivar">Esquivar <small>(Agilidade)</small></label>
          {{ form.esquivar }}
          <div class="defesa-total" data-defesa="esquivar">Total: <span class="valor-total" id="total_esquivar">0</span></div>
          {% if form.esquivar.errors %}<div style="color:red;">{{ form.esquivar.errors }}</div>{% endif %}
        </div>
        <div class="campo-def">
          <label for="id_resistencia">Resistência <small>(Vigor)</small></label>
          {{ form.resistencia }}
          <div class="defesa-total" data-defesa="resistencia">Total: <span class="valor-total" id="total_resistencia">0</span></div>
          {% if form.resistencia.errors %}<div style="color:red;">{{ form.resistencia.errors }}</div>{% endif %}
        </div>
        <!-- Linha 2: Vontade (Prontidão), Fortitude (Vigor) -->
        <div class="campo-def">
          <label for="id_vontade">Vontade <small>(Prontidão)</small></label>
          {{ form.vontade }}
          <div class="defesa-total" data-defesa="vontade">Total: <span class="valor-total" id="total_vontade">0</span></div>
          {% if form.vontade.errors %}<div style="color:red;">{{ form.vontade.errors }}</div>{% endif %}
        </div>
        <div class="campo-def">
          <label for="id_fortitude">Fortitude <small>(Vigor)</small></label>
          {{ form.fortitude }}
          <div class="defesa-total" data-defesa="fortitude">Total: <span class="valor-total" id="total_fortitude">0</span></div>
          {% if form.fortitude.errors %}<div style="color:red;">{{ form.fortitude.errors }}</div>{% endif %}
        </div>
        <div>
          <div id="limites-defesas" style="font-size:0.8rem; line-height:1.3; text-align:left;">
            <strong>Limites:</strong><br>
            Esquivar + Resistência ≤ 2×NP<br>
            Aparar + Resistência ≤ 2×NP<br>
            Fortitude + Vontade ≤ 2×NP
          </div>
        </div>
      </div>

  <h2>Resistências e Imunidades <span id="badge-res" class="section-cost-badge" title="Resistência: +5 pp por tipo. Imunidade: +10 pp por tipo.">Resist 5 / Imun 10 — 0</span></h2>
      <div class="resist-grid" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(240px,1fr)); gap:1.2rem 2rem; margin-bottom:1.6rem;">
        <div>
          <h4 style="margin:0 0 0.4rem;">Resistências</h4>
          <div class="checkbox-grid">
            {{ form.resistencias_dano }}
          </div>
        </div>
        <div>
          <h4 style="margin:0 0 0.4rem;">Imunidades</h4>
          <div class="checkbox-grid">
            {{ form.imunidades_dano }}
          </div>
        </div>
      </div>
      <style>
        .checkbox-grid ul { list-style: none; padding: 0; margin: 0; width: 100%; }
        .checkbox-grid li { margin-bottom: 0.35rem; }
        .checkbox-grid label { display: inline-flex; align-items: center; gap: 0.5rem; margin: 0; cursor: pointer; white-space: nowrap; }
        .checkbox-grid input[type="checkbox"] { margin: 0; flex-shrink: 0; cursor: pointer; }
      </style>

  <h2>Perícias <span id="badge-per" class="section-cost-badge" title="Cada ponto em Perícias custa +0,5 pp.">+0,5 pp — 0</span></h2>
      <div style="margin-bottom:0.8rem;">
        {{ form.especialidade_casting_ability.label_tag }} {{ form.especialidade_casting_ability }}
      </div>
      <div class="pericias-grid-4" style="display:grid; grid-template-columns:repeat(4, minmax(140px,1fr)); gap:1.4rem 2.2rem; justify-items:center; margin-bottom:2rem;">
        {% for campo in pericias_col1 %}
          {% if campo != 'combate_distancia' and campo != 'combate_corpo' %}
            {% with field=form|lookup:campo %}
              <div class="pericia-campo" style="display:flex; flex-direction:column; align-items:center;">
                <label style="font-weight:bold; margin-bottom:0.25rem;">{{ field.label }}</label>
                {{ field }}
                {% if field.errors %}<div style="color:red;">{{ field.errors }}</div>{% endif %}
              </div>
            {% endwith %}
          {% endif %}
        {% endfor %}
        {% for campo in pericias_col2 %}
          {% if campo != 'combate_distancia' and campo != 'combate_corpo' %}
            {% with field=form|lookup:campo %}
              <div class="pericia-campo" style="display:flex; flex-direction:column; align-items:center;">
                <label style="font-weight:bold; margin-bottom:0.25rem;">{{ field.label }}</label>
                {{ field }}
                {% if field.errors %}<div style="color:red;">{{ field.errors }}</div>{% endif %}
              </div>
            {% endwith %}
          {% endif %}
        {% endfor %}
      </div>
  <h2>Poderes <span id="badge-pod" class="section-cost-badge" title="Custo por poder = Nível × (1 + bônus de Tipo + bônus de Tipo Dano + Duração + Modo) + Bônus de Ataque. Bônus: Tipo: +1 (cura/aprimorar). Tipo Dano (apenas Dano): +0 (físico), +2 (ácido/gelo/fogo/raio/veneno), +3 (mental/trovão), +5 (necrótico/radiante). Duração: +1 (concentração), +2 (sustentado), +3 (reação). Modo: +1 (ranged), +2 (área), +3 (percepção). Bônus de Ataque: +0,5 pp por ponto (aditivo, por poder). Arrays: parte de Nível do grupo = maior base + (n−1); cada poder ainda soma seu próprio Bônus de Ataque.">Nivel x (1+Tipo+TipoDano+Duração+Modo) + Bônus Ataque — 0</span></h2>
      <!-- Empty form grid para JS clonar (opcional, se usar JS dinâmico igual editar) -->
      <div id="empty-poder-form" style="display:none;">
          <div class="poder-form poder-form-grid" style="border:1px solid #444; width:100%; position: relative;">
          <div class="campo-poder">{{ formset.empty_form.nome.label_tag }}{{ formset.empty_form.nome }}</div>
          <div class="campo-poder">{{ formset.empty_form.array.label_tag }}{{ formset.empty_form.array }}</div>
          <div class="campo-poder">{{ formset.empty_form.tipo.label_tag }}{{ formset.empty_form.tipo }}</div>
          <div class="campo-poder campo-tipo-dano">{{ formset.empty_form.tipo_dano.label_tag }}{{ formset.empty_form.tipo_dano }}</div>
          <div class="campo-poder campo-caminho-aflicao">{{ formset.empty_form.caminho_aflicao.label_tag }}{{ formset.empty_form.caminho_aflicao }}</div>
          <div class="campo-poder">{{ formset.empty_form.modo.label_tag }}{{ formset.empty_form.modo }}</div>
          <div class="campo-poder somar-forca-wrap span-2" title="Se marcado e for Dano Corpo a Corpo, o nível de efeito soma a Força.">
            <div class="somar-forca-left">
              <label for="{{ formset.empty_form.somar_forca_no_nivel.id_for_label }}">
                {{ formset.empty_form.somar_forca_no_nivel }} Somar Força ao Nível (melee)
              </label>
              <span class="info-tip" title="Se marcado e Dano melee: Nível Efetivo = Nível + Força. O limite usa o Nível Efetivo.">ⓘ</span>
            </div>
            <div class="somar-forca-right"><span class="label-total-dano">Total Dano:</span> <span class="valor-dano-total">0</span></div>
          </div>
          <div class="campo-poder">{{ formset.empty_form.duracao.label_tag }}{{ formset.empty_form.duracao }}</div>
          <div class="campo-poder campo-atributo-afetado">{{ formset.empty_form.casting_ability.label_tag }}{{ formset.empty_form.casting_ability }}</div>
          <div class="campo-poder">{{ formset.empty_form.nivel_efeito.label_tag }}{{ formset.empty_form.nivel_efeito }}</div>
          <div class="campo-poder">{{ formset.empty_form.charges.label_tag }}{{ formset.empty_form.charges }}</div>
          <div class="campo-poder">{{ formset.empty_form.bonus_ataque.label_tag }}{{ formset.empty_form.bonus_ataque }}</div>
          <div class="linha-ataque-info" style="grid-column:1/-1; font-size:0.7rem; display:flex; justify-content:space-between; align-items:center; margin-top:0.2rem; gap:1rem;">
            <span class="hint-bonus-ataque" style="text-align:left;" title="Corpo a Corpo: Luta + Bônus | À Distância: Destreza + Bônus | Limites: Base (Atk+NE) ≤ 2×NP • Com Charges (>0): (Atk+NE) ≤ (2×NP + ⌊NP/2⌋ − (Charges−1)) | Custo: cada ponto em Bônus de Ataque soma +0,5 pp (aditivo)">ⓘ Corpo a Corpo: Luta + Bônus | À Distância: Destreza + Bônus | Limites: Base (Atk+NE) ≤ 2×NP • Com Charges: (Atk+NE) ≤ (2×NP + ⌊NP/2⌋ − (Charges−1)) | Custo: Bônus Ataque +0,5 pp por ponto</span>
            <span style="white-space:nowrap;">Total Ataque: <span class="valor-ataque-total">0</span></span>
          </div>
          <div class="campo-poder">{{ formset.empty_form.defesa_ativa.label_tag }}{{ formset.empty_form.defesa_ativa }}</div>
          <div class="campo-poder">{{ formset.empty_form.defesa_passiva.label_tag }}{{ formset.empty_form.defesa_passiva }}</div>
          {# Campo de origem de item removido do bloco principal #}
          <div class="campo-poder">{{ formset.empty_form.vantagem_origem.label_tag }}{{ formset.empty_form.vantagem_origem }}</div>
          <div class="campo-poder linha-checkbox">{{ formset.empty_form.de_vantagem }} <label for="{{ formset.empty_form.de_vantagem.id_for_label }}">Poder de Vantagem?</label></div>
          <div class="campo-poder span-2">
            <div class="helptext">Ligação automática: poderes com mesmo nome, modo e duração serão ligados ao salvar.</div>
          </div>
          <div class="span-2" style="margin-top:0.4rem; text-align:right; display:flex; gap:0.7rem; justify-content:flex-end;">
            <span style="display:none;">{{ formset.empty_form.DELETE }}</span>
            <button type="button" class="btn btn-danger" onclick="removerPoderLinha(this)">Remover</button>
          </div>
        </div>
      </div>
      <div class="poder-form-outer">
        <div id="poderes-formset">
          {{ formset.management_form }}
          <div id="poderes-main-list" style="display: flex; flex-direction: column; gap: 1.5rem; align-items: center;">
            {% for form in formset %}
              {% if not form.instance.de_item %}
              <div class="poder-form poder-form-grid" style="border:1px solid #444; width:100%; position: relative;">
                <div class="campo-poder">{{ form.nome.label_tag }}{{ form.nome }}</div>
                <div class="campo-poder">{{ form.array.label_tag }}{{ form.array }}</div>
                <div class="campo-poder">{{ form.tipo.label_tag }}{{ form.tipo }}</div>
                <div class="campo-poder campo-tipo-dano">{{ form.tipo_dano.label_tag }}{{ form.tipo_dano }}</div>
                <div class="campo-poder campo-caminho-aflicao">{{ form.caminho_aflicao.label_tag }}{{ form.caminho_aflicao }}</div>
                <div class="campo-poder">{{ form.modo.label_tag }}{{ form.modo }}</div>
                <div class="campo-poder somar-forca-wrap span-2" title="Se marcado e for Dano Corpo a Corpo, o nível de efeito soma a Força.">
                  <div class="somar-forca-left">
                    <label for="{{ form.somar_forca_no_nivel.id_for_label }}">
                      {{ form.somar_forca_no_nivel }} Somar Força ao Nível (melee)
                    </label>
                    <span class="info-tip" title="Se marcado e Dano melee: Nível Efetivo = Nível + Força. O limite usa o Nível Efetivo.">ⓘ</span>
                  </div>
                  <div class="somar-forca-right"><span class="label-total-dano">Total Dano:</span> <span class="valor-dano-total">0</span></div>
                </div>
                <div class="campo-poder">{{ form.duracao.label_tag }}{{ form.duracao }}</div>
                <div class="campo-poder campo-atributo-afetado">{{ form.casting_ability.label_tag }}{{ form.casting_ability }}</div>
                <div class="campo-poder">{{ form.nivel_efeito.label_tag }}{{ form.nivel_efeito }}</div>
                <div class="campo-poder">{{ form.charges.label_tag }}{{ form.charges }}</div>
                <div class="campo-poder">{{ form.bonus_ataque.label_tag }}{{ form.bonus_ataque }}</div>
                <div class="linha-ataque-info" style="grid-column:1/-1; font-size:0.7rem; display:flex; justify-content:space-between; align-items:center; margin-top:0.2rem; gap:1rem;">
                  <span class="hint-bonus-ataque" style="text-align:left;" title="Corpo a Corpo: Luta + Bônus | À Distância: Destreza + Bônus | Limites: Base (Atk+NE) ≤ 2×NP • Com Charges (>0): (Atk+NE) ≤ (2×NP + ⌊NP/2⌋ − (Charges−1)) | Custo: cada ponto em Bônus de Ataque soma +0,5 pp (aditivo)">ⓘ Corpo a Corpo: Luta + Bônus | À Distância: Destreza + Bônus | Limites: Base (Atk+NE) ≤ 2×NP • Com Charges: (Atk+NE) ≤ (2×NP + ⌊NP/2⌋ − (Charges−1)) | Custo: Bônus Ataque +0,5 pp por ponto</span>
                  <span style="white-space:nowrap;">Total Ataque: <span class="valor-ataque-total">0</span></span>
                </div>
                <div class="campo-poder">{{ form.defesa_ativa.label_tag }}{{ form.defesa_ativa }}</div>
                <div class="campo-poder">{{ form.defesa_passiva.label_tag }}{{ form.defesa_passiva }}</div>
                {# Origem de Item removida do bloco principal de poderes #}
                <div class="campo-poder">{{ form.vantagem_origem.label_tag }}{{ form.vantagem_origem }}</div>
                <div class="campo-poder linha-checkbox">{{ form.de_vantagem }} <label for="{{ form.de_vantagem.id_for_label }}">Poder de Vantagem?</label></div>
                <!-- detalhe do custo por poder (preenchido via JS) -->
                <div class="poder-custo-detalhe" style="grid-column:1 / -1; text-align:right; font-size:0.85rem; color:#cfcfe1; opacity:0.95; padding-top:0.2rem;"></div>
                <div class="campo-poder span-2">
                  <div class="helptext">Ligação automática: poderes com mesmo nome, modo e duração serão ligados ao salvar.</div>
                </div>
              {% if form.DELETE %}
                <div class="span-2" style="margin-top:0.4rem; text-align: right; display: flex; align-items: center; gap: 0.7rem; justify-content: flex-end;">
                  <span style="display:none;">{{ form.DELETE }}</span>
                  <button type="button" class="btn btn-danger" onclick="removerPoderLinha(this)">Remover</button>
                </div>
              {% endif %}
            </div>
            {% endif %}
          {% endfor %}
          </div>
        </div>
      </div>
      <div style="margin-top:1.5rem; display:flex; gap:1rem; justify-content:center;">
        <button type="button" class="btn btn-danger" onclick="adicionarPoder()">Adicionar Poder</button>
        <button type="button" class="btn btn-danger" onclick="removerPoder()">Remover Último Poder</button>
      </div>
      <div class="inventario-largo">
        <h2>Inventário</h2>
        <div class="inventario-moedas-inline">Ouro: {{ inventario_form.ouro }} &nbsp; Dragon shard: {{ inventario_form.dragon_shard }}</div>
        <div class="inventario-filtros"> 
          <input type="text" id="busca-item" placeholder="Buscar por nome ou descrição...">
          <select id="filtro-raridade" style="min-width:140px;">
            <option value="">Todas raridades</option>
            <option>Common</option>
            <option>Uncommon</option>
            <option>Rare</option>
            <option>Very Rare</option>
            <option>Legendary</option>
            <option>Artifact</option>
            <option>None</option>
            <option>Unknown</option>
            <option>Unknown (Magic)</option>
            <option>Varies</option>
          </select>
          <select id="filtro-tipo" style="min-width:160px;">
            <option value="">Todos tipos</option>
            <option>Melee Weapon</option>
            <option>Ranged Weapon</option>
            <option>Light Armor</option>
            <option>Medium Armor</option>
            <option>Heavy Armor</option>
            <option>Shield</option>
            <option>Ammunition</option>
            <option>Rod</option>
            <option>Wondrous Item</option>
            <option>Trade Good</option>
            <option>Adventuring Gear</option>
            <option>Generic Variant</option>
            <option>Gaming Set</option>
            <option>Tool</option>
            <option>Artisan's Tools</option>
            <option>Instrument</option>
            <option>Spellcasting Focus</option>
            <option>Scroll</option>
            <option>Poison</option>
            <option>Food/Drink</option>
            <option>Explosive</option>
            <option>Ring</option>
            <option>Tack and Harness</option>
            <option>Mount</option>
            <option>Vehicle</option>
            <option>Ship</option>
            <option>Air Vehicle</option>
            <option>Tinker’s Tool (Bundle)</option>
            <option>Space Vehicle</option>
            <option>Idol/Relic</option>
            <option>Other</option>
            <option>martial Weapon, Melee Weapon</option>
            <option>martial Weapon, Ranged Weapon</option>
            <option>simple Weapon, Melee Weapon</option>
            <option>simple Weapon, Ranged Weapon</option>
          </select>
          <label class="check-inline">
            <input type="checkbox" id="filtro-possuido">
            Itens Obtidos
          </label>
        </div>
        <div class="inventario-tabela-wrapper">
          <table id="tabela-itens" class="table-scroll inventario-tabela" border="1">
            <thead>
              <tr>
                <th>Sel.</th>
                <th>Nome</th>
                <th>Tipo</th>
                <th>Raridade</th>
                <th>Descrição</th>
                <th>Preço</th>
              </tr>
            </thead>
            <tbody>
              {% for item in inventario_form.fields.itens.queryset %}
                <tr data-mods="{{ item.mods|tojson|escape }}">
                  <td>
                    <input type="checkbox" name="itens" value="{{ item.id }}"
                      {% if item.id in itens_possuido_ids %}checked{% endif %}>
                    {# Definições de poderes do item (ocultas) para sincronização automática) #}
                    <span class="item-powers-defs" style="display:none;">
                      {% for poder in item.poderes.all %}
                        <span class="item-power-def"
                              data-nome="{{ poder.nome|escape }}"
                              data-tipo="{{ poder.tipo }}"
                              data-modo="{{ poder.modo }}"
                              data-duracao="{{ poder.duracao }}"
                              data-nivel_efeito="{{ poder.nivel_efeito }}"
                              data-bonus_ataque="{{ poder.bonus_ataque }}"
                              data-somar_forca_no_nivel="{% if poder.somar_forca_no_nivel %}1{% else %}0{% endif %}"
                              data-defesa_ativa="{{ poder.defesa_ativa }}"
                              data-defesa_passiva="{{ poder.defesa_passiva }}"
                              data-casting_ability="{{ poder.casting_ability }}"
                              data-charges="{{ poder.charges|default:'' }}"
                              data-array="{{ poder.array|default:'' }}"></span>
                      {% endfor %}
                    </span>
                  </td>
                  <td class="nome-item">{{ item.nome }}</td>
                  <td class="tipo-item">{{ item.tipo }}</td>
                  <td class="raridade-item">{{ item.raridade }}</td>
                  <td class="descricao-item" style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:260px;" title="{{ item.descricao|striptags }}">{{ item.descricao|truncatechars:80 }}</td>
                  <td>{{ item.preco }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <!-- Painel: Efeitos dos Itens Selecionados -->
        <div id="painel-efeitos-itens" class="personagem-card" style="margin-top:1rem;">
          <h3 class="personagem-subtitle" style="margin-top:0">Efeitos dos Itens Selecionados</h3>
          <div id="efeitos-itens-conteudo" style="font-size:0.95rem; opacity:0.95;">
            <em>Nenhum item selecionado.</em>
          </div>
        </div>
      </div>
      <div id="rule-violations" class="form-rule-errors" style="display:none;">
        <strong>Corrija antes de salvar:</strong>
        <ul id="rule-violations-list"></ul>
      </div>
      <div style="margin-top:2rem; text-align:center;">
        <input type="submit" value="Salvar" class="btn" id="submit-personagem">
      </div>
    </div>
  </form>
</div>

<script>
// ---- Cálculo Dinâmico de Custos ----
document.addEventListener('DOMContentLoaded', function() {
  // Helpers: efetivo nível de efeito (soma Força quando habilitado) e toggler do checkbox
  function nivelEfeitoEfetivoPorDiv(div){
    const tipoEl = div.querySelector('[name$="-tipo"]');
    const modoEl = div.querySelector('[name$="-modo"]');
    const somaForcaEl = div.querySelector('[name$="-somar_forca_no_nivel"]');
    const nivelEl = div.querySelector('[name$="-nivel_efeito"]');
    let n = 0; if(nivelEl){ const v=parseFloat((nivelEl.value||'').toString().replace(',','.')); n = isNaN(v)?0:Math.abs(v); }
    if(tipoEl && modoEl && somaForcaEl && somaForcaEl.checked && (tipoEl.value==='dano') && (modoEl.value==='melee')){
      const forcaEl = document.getElementById('id_forca');
      const f = forcaEl ? parseFloat((forcaEl.value||'').toString().replace(',','.'))||0 : 0;
      n += Math.abs(f);
    }
    return n;
  }
  function toggleSomarForca(div){
    const tipoEl = div.querySelector('[name$="-tipo"]');
    const modoEl = div.querySelector('[name$="-modo"]');
    const wrap = div.querySelector('.somar-forca-wrap');
    if(!wrap) return;
    const show = tipoEl && modoEl && tipoEl.value==='dano' && modoEl.value==='melee';
    wrap.style.display = show ? '' : 'none';
  }
  // Expor globalmente para outros scripts
  window.nivelEfeitoEfetivoPorDiv = nivelEfeitoEfetivoPorDiv;
  window.toggleSomarForcaPoder = toggleSomarForca;
  // Mostrar/esconder "Atributo Afetado" apenas quando Tipo = Aprimorar/Reduzir
  function toggleAtributoAfetado(div){
    if(!div) return;
    const tipoEl = div.querySelector('[name$="-tipo"]');
    const wrap = div.querySelector('.campo-atributo-afetado');
    if(!wrap) return;
    const show = tipoEl && tipoEl.value === 'aprimorar';
    wrap.style.display = show ? '' : 'none';
  }
  window.toggleAtributoAfetado = toggleAtributoAfetado;
  const camposCaracteristicas = ['forca','vigor','destreza','agilidade','luta','inteligencia','prontidao','presenca'];
  const camposDefesas = ['aparar','esquivar','fortitude','vontade','resistencia'];
  const camposPericias = ['acrobacias','atletismo','combate_distancia','combate_corpo','enganacao','especialidade','furtividade','intimidacao','intuicao','investigacao','percepcao','persuasao','prestidigitacao','tecnologia','tratamento','veiculos','historia','sobrevivencia','arcana','religiao'];

  function val(id){
    const el = document.getElementById('id_'+id);
    if(!el) return 0;
    const v = parseFloat(el.value.replace(',', '.'));
    return isNaN(v)?0:v;
  }

  function custoPoderDiv(div){
    function sel(name){ return div.querySelector('[name$="-'+name+'"]'); }
    // Ignora custo para poderes de item ou de vantagem
    const chItem = div.querySelector('input[type="checkbox"][name$="-de_item"]');
    const chVant = div.querySelector('input[type="checkbox"][name$="-de_vantagem"]');
    if ((chItem && chItem.checked) || (chVant && chVant.checked)) return 0;
    const nivelInput = sel('nivel_efeito');
    if(!nivelInput) return 0;
    let n = parseFloat(nivelInput.value)||0;
    n = Math.abs(n); // usa módulo para permitir negativos contarem positivamente
    if(n===0) return 0;
    const tipo = (sel('tipo')?.value)||'';
    const dur = (sel('duracao')?.value)||'';
    const modo = (sel('modo')?.value)||'';
    const tipoDano = (sel('tipo_dano')?.value)||'';
    const tipoBonus = (tipo==='cura'||tipo==='aprimorar')?1:0;
    const durBonus = dur==='concentracao'?1:(dur==='sustentado'?2:(dur==='reacao'?3:0));
    const modoBonus = modo==='ranged'?1:(modo==='area'?2:(modo==='percepcao'?3:0));
    const mult = 1 + tipoBonus + durBonus + modoBonus;
    // tipo_dano: Físico +0, Ácido/Gelo/Fogo/Raio/Veneno +2, Mental/Trovão +3, Necrótico/Radiante +5 (aditivo)
    let tipoDanoBonus = 0;
    if (tipo === 'dano' && tipoDano) {
      const mapaTipoDano = {
        'acido': 2, 'gelo': 2, 'fogo': 2, 'raio': 2, 'veneno': 2,
        'mental': 3, 'trovao': 3,
        'necrotico': 5, 'radiante': 5,
        'fisico': 0
      };
      tipoDanoBonus = mapaTipoDano[tipoDano.toLowerCase()] || 0;
    }
    return n * mult + tipoDanoBonus; // parte base (nível × mult) + tipo_dano (aditivo)
  }
  function custoBonusAtaque(div){
    const el = div.querySelector('[name$="-bonus_ataque"]');
    if(!el) return 0;
    const v = parseFloat((el.value||'').toString().replace(',','.'));
    const b = isNaN(v)?0:Math.abs(v);
    const chItem = div.querySelector('input[type="checkbox"][name$="-de_item"]');
    const chVant = div.querySelector('input[type="checkbox"][name$="-de_vantagem"]');
    if ((chItem && chItem.checked) || (chVant && chVant.checked)) return 0;
    return b * 0.5; // +0,5 pp por ponto de bônus de ataque (aditivo)
  }

  // Validar que um tipo de dano não pode ser resistente E imune simultaneamente
  function validarResistenciaImunidade() {
    const resistenciasCheckboxes = document.querySelectorAll('input[name="resistencias_dano"][type="checkbox"]');
    const imunidadesCheckboxes = document.querySelectorAll('input[name="imunidades_dano"][type="checkbox"]');
    
    // Desabilitar um se o outro está marcado
    resistenciasCheckboxes.forEach(cb => {
      const immCb = Array.from(imunidadesCheckboxes).find(i => i.value === cb.value);
      if (immCb && immCb.checked && cb.checked) {
        cb.checked = false;
      }
      cb.disabled = immCb && immCb.checked;
    });
    imunidadesCheckboxes.forEach(cb => {
      const resCb = Array.from(resistenciasCheckboxes).find(r => r.value === cb.value);
      if (resCb && resCb.checked && cb.checked) {
        cb.checked = false;
      }
      cb.disabled = resCb && resCb.checked;
    });
  }

  function atualizarCustos(){
    const custoCarac = camposCaracteristicas.reduce((s,c)=>s+val(c),0)*2;
    const custoDef = camposDefesas.reduce((s,c)=>s+val(c),0)*1;
    const custoPer = camposPericias.reduce((s,c)=>s+val(c),0)*0.5;
    // Vantagens: cada checkbox marcado = 1
    const custoVant = document.querySelectorAll('input[type="checkbox"][name="vantagens"]:checked').length * 1;
    // Resistências: 5 pp por tipo marcado
    const custoRes = document.querySelectorAll('input[type="checkbox"][name="resistencias_dano"]:checked').length * 5;
    // Imunidades: 10 pp por tipo marcado
    const custoImun = document.querySelectorAll('input[type="checkbox"][name="imunidades_dano"]:checked').length * 10;
    // Poderes: agrupar por Array (nome) e aplicar regra de custo
  const grupos = new Map(); // armazena apenas bases (nível)
  const gruposBonus = new Map(); // soma de bônus de ataque por array
  const individuais = []; // bases sem array
  let bonusSemArray = 0; // bônus de ataque somado dos poderes sem array
  document.querySelectorAll('#poderes-main-list .poder-form').forEach(div=>{
      const del = div.querySelector('input[type="checkbox"][name$="-DELETE"]');
      if(del && del.checked) return; // ignorar deletados
      if(div.style.display==='none') return;
      const chItem = div.querySelector('input[type="checkbox"][name$="-de_item"]');
      const chVant = div.querySelector('input[type="checkbox"][name$="-de_vantagem"]');
      if ((chItem && chItem.checked) || (chVant && chVant.checked)) return;
    const base = custoPoderDiv(div);
    // Atualiza visibilidade do checkbox de Somar Força
    toggleSomarForca(div);
    // Atualiza visibilidade do campo Atributo Afetado
    toggleAtributoAfetado(div);
    toggleSomarForca(div);
      const bAtk = custoBonusAtaque(div);
      const arrName = (div.querySelector('[name$="-array"]')?.value || '').trim().toLowerCase();
      if (arrName) {
        if (!grupos.has(arrName)) grupos.set(arrName, []);
        grupos.get(arrName).push(base);
        gruposBonus.set(arrName, (gruposBonus.get(arrName)||0) + bAtk);
      } else {
        individuais.push(base);
        bonusSemArray += bAtk;
      }
    });
    let custoPod = individuais.reduce((a,b)=>a+b,0) + bonusSemArray;
    let temArray = false;
    grupos.forEach((bases, nome)=>{
      if (!bases || bases.length===0) return;
      const n = bases.length;
      const maxBase = Math.max.apply(null, bases);
      custoPod += maxBase + Math.max(0, n - 1); // parte de nível
      custoPod += (gruposBonus.get(nome)||0); // soma dos bônus de ataque de todos os membros
      temArray = true;
    });
    const total = custoCarac + custoDef + custoPer + custoVant + custoRes + custoImun + custoPod;
    document.getElementById('custo-caracteristicas').textContent = custoCarac;
    document.getElementById('custo-defesas').textContent = custoDef;
    // Exibe .5 com .5, senão inteiro
    function fmt(x){ return (Math.round(x*10)%10===0)?x: x.toFixed(1).replace('.0',''); }
    document.getElementById('custo-pericias').textContent = fmt(custoPer);
    document.getElementById('custo-vantagens').textContent = custoVant;
    document.getElementById('custo-poderes').textContent = custoPod;
    document.getElementById('custo-total').textContent = fmt(total);
    // Badges de seção
    const bCar = document.getElementById('badge-carac'); if (bCar){ bCar.textContent = '+2 pp — ' + custoCarac; bCar.title = 'Cada ponto em Características custa +2 pp. Total atual: '+custoCarac; }
    const bDef = document.getElementById('badge-def'); if (bDef){ bDef.textContent = '+1 pp — ' + custoDef; bDef.title = 'Cada ponto em Defesas custa +1 pp. Total atual: '+custoDef; }
    const bPer = document.getElementById('badge-per'); if (bPer){ bPer.textContent = '+0,5 pp — ' + fmt(custoPer); bPer.title = 'Cada ponto em Perícias custa +0,5 pp. Total atual: '+fmt(custoPer); }
    const bVan = document.getElementById('badge-vant'); if (bVan){ bVan.textContent = '+1 pp — ' + custoVant; bVan.title = 'Cada vantagem selecionada custa +1 pp. Total atual: '+custoVant; }
    const bRes = document.getElementById('badge-res'); if (bRes){ const custoResImun = custoRes + custoImun; bRes.textContent = 'Resist 5 / Imun 10 — ' + custoResImun; bRes.title = 'Resistência: +5 pp por tipo. Imunidade: +10 pp por tipo. Total atual: '+custoResImun; }
    const bPod = document.getElementById('badge-pod');
    if (bPod){
      const baseTxt = 'Nivel x (1+Tipo+TipoDano+Duração+Modo) + Bônus Ataque';
      bPod.textContent = (temArray? baseTxt + ' + Arrays' : baseTxt) + ' — ' + custoPod;
      bPod.title = 'Custo por poder = Nível × (1 + bônus de Tipo + bônus de Tipo Dano + Duração + Modo) + Bônus de Ataque. Bônus: Tipo: +1 (cura/aprimorar). Tipo Dano (apenas Dano): +0 (físico), +2 (ácido/gelo/fogo/raio/veneno), +3 (mental/trovão), +5 (necrótico/radiante). Duração: +1 (concentração), +2 (sustentado), +3 (reação). Modo: +1 (ranged), +2 (área), +3 (percepção). Bônus de Ataque: +0,5 pp por ponto (aditivo, por poder). ' + (temArray ? 'Arrays: parte de Nível = maior base + (n−1); cada poder ainda soma seu próprio Bônus de Ataque. ' : '') + 'Total atual: ' + custoPod;
    }
  }
  // Torna acessível globalmente para outros scripts (unificador final)
  window.atualizarCustos = atualizarCustos;

  // Observers
  const watchSelectors = []
    .concat(camposCaracteristicas.map(c=>'#id_'+c))
    .concat(camposDefesas.map(c=>'#id_'+c))
    .concat(camposPericias.map(c=>'#id_'+c))
    .concat(['input[type="checkbox"][name="vantagens"]'])
    .concat(['input[type="checkbox"][name="resistencias_dano"]'])
    .concat(['input[type="checkbox"][name="imunidades_dano"]']);
  function addListeners(){
    watchSelectors.forEach(sel=>{
      document.querySelectorAll(sel).forEach(el=>{
        el.addEventListener('input', atualizarCustos);
        el.addEventListener('change', atualizarCustos);
      });
    });
    // Campos de poder (incluindo tipo_dano)
  document.querySelectorAll('#poderes-main-list .poder-form select, #poderes-main-list .poder-form input').forEach(el=>{
      el.addEventListener('input', atualizarCustos);
      el.addEventListener('change', atualizarCustos);
    });
    // Garantir que tipo_dano dispara atualização
    document.querySelectorAll('#poderes-main-list .poder-form [name$="-tipo_dano"]').forEach(el=>{
      el.addEventListener('change', atualizarCustos);
      // Chama updateBadges se já estiver disponível (definido mais abaixo)
      el.addEventListener('change', function(){ if(typeof window.updateBadges === 'function') window.updateBadges(); });
    });
    // Validar resistência/imunidade
    document.querySelectorAll('input[type="checkbox"][name="resistencias_dano"], input[type="checkbox"][name="imunidades_dano"]').forEach(cb => {
      cb.addEventListener('change', validarResistenciaImunidade);
    });
  }
  addListeners();
  validarResistenciaImunidade();
  // Reaplicar listeners ao adicionar poder
  const originalAdicionar = window.adicionarPoder;
  window.adicionarPoder = function(){
    if (typeof originalAdicionar === 'function') originalAdicionar();
    // Dar tempo para DOM inserir
    setTimeout(()=>{
      const last = document.querySelector('.poder-form:last-child');
      if(last){
        last.querySelectorAll('select, input').forEach(el=>{
          el.addEventListener('input', atualizarCustos);
          el.addEventListener('change', atualizarCustos);
        });
      }
      atualizarCustos();
    },50);
  };
  const originalRemover = window.removerPoderLinha;
  window.removerPoderLinha = function(btn){
    originalRemover(btn);
    atualizarCustos();
  }
  const originalRemoverUltimo = window.removerPoder;
  window.removerPoder = function(){
    originalRemoverUltimo();
    atualizarCustos();
  }
  atualizarCustos();
});
</script>
{# JS antigo de sincronizar poderes de item removido: os itens agora só afetam custos/defesas via mods #}
<script>
// Painel de Resumo: características, defesas, perícias e poderes concedidos pelos itens marcados
document.addEventListener('DOMContentLoaded', function(){
  function parseRawMods(tr){
    try {
      let txt = tr.getAttribute('data-mods') || '{}';
      txt = txt.replace(/&quot;/g,'"').replace(/&#34;/g,'"').replace(/&#39;|&apos;/g,"'").replace(/&amp;/g,'&');
      let obj = JSON.parse(txt);
      if (typeof obj === 'string') {
        try { obj = JSON.parse(obj); } catch(e) { /* ignore */ }
      }
      return obj || {};
    } catch(_) { return {}; }
  }
  function normKey(k){ return (k||'').toString().trim().toLowerCase(); }
  function mapKey(k){
    const n = normKey(k);
    const aliases = {
      // Características (EN -> PT)
      'strength':'forca','stamina':'vigor','dexterity':'destreza','agility':'agilidade','fighting':'luta','intellect':'inteligencia','awareness':'prontidao','presence':'presenca',
      // Abreviações comuns
      'str':'forca','sta':'vigor','dex':'destreza','agi':'agilidade','fgt':'luta','int':'inteligencia','awe':'prontidao','pre':'presenca','prs':'presenca',
      // Abreviações PT
      'for':'forca','vig':'vigor','des':'destreza','lut':'luta','pro':'prontidao',
      // Defesas
      'dodge':'esquivar','parry':'aparar','toughness':'resistencia','will':'vontade','willpower':'vontade',
      // Classe de Armadura (mapeada como composto)
      'ac':'ac','ca':'ac','armor_class':'ac','armorclass':'ac','classe_de_armadura':'ac',
      // PT-BR com acentos e variações
      'força':'forca','inteligência':'inteligencia','prontidão':'prontidao','presença':'presenca','resistência':'resistencia','esquiva':'esquivar'
    };
    if (aliases[n]) return aliases[n];
    // Heurística: tenta mapear por tokens (ex.: "Dexterity (Archery)")
    const tokens = n.split(/[^a-záàâãéèêíïóôõöúüç]+/i).filter(Boolean);
    for (const t of tokens){
      if (aliases[t]) return aliases[t];
    }
    return n;
  }
  function normalizeMods(raw){
    const out = { caracteristicas:{}, defesas:{}, pericias:{} };
    if (!raw || typeof raw !== 'object') return out;

    const secAlias = {
      // English -> PT
      'defense':'defesas','defenses':'defesas','saves':'defesas','saving_throws':'defesas',
      'skills':'pericias','skill':'pericias',
      'abilities':'caracteristicas','ability':'caracteristicas','attributes':'caracteristicas','stats':'caracteristicas',
      // Common wrappers
      'mods':'mods','modifiers':'mods','effects':'mods','bonuses':'mods','bonus':'mods',
      // PT variants
      'defesa':'defesas','perícia':'pericias','perícias':'pericias','característica':'caracteristicas','características':'caracteristicas'
    };
    const defKeys = new Set(['esquivar','aparar','fortitude','vontade','resistencia']);
    const perKeys = new Set(['acrobacias','atletismo','combate_distancia','combate_corpo','enganacao','especialidade','furtividade','intimidacao','intuicao','investigacao','percepcao','persuasao','prestidigitacao','tecnologia','tratamento','veiculos','historia','sobrevivencia','arcana','religiao']);

    function addTo(bucket, key, val){ if(!Number.isFinite(val) || val===0) return; bucket[key] = (bucket[key]||0)+val; }
    function addComposite(key, val){
      // AC/CA afeta Esquivar e Aparar simultaneamente
      if(key==='ac'){ addTo(out.defesas, 'esquivar', val); addTo(out.defesas, 'aparar', val); return true; }
      return false;
    }

    // Depth-first traversal: propagate a hint for current section bucket if we hit known section-aliases
    function walk(node, hint){
      if (node==null) return;
      // Arrays: iterate elements
      if (Array.isArray(node)){ node.forEach(el => walk(el, hint)); return; }
      if (typeof node !== 'object') return;
      Object.keys(node).forEach(key => {
        const val = node[key];
        const mk = mapKey(key);
        const sec = secAlias[mk] || mk;
        // Numeric direct leaf
        const num = parseFloat(val);
        if (Number.isFinite(num)){
          if (addComposite(mk, num)) return;
          if (defKeys.has(mk) || hint==='defesas') addTo(out.defesas, mk, num);
          else if (perKeys.has(mk) || hint==='pericias') addTo(out.pericias, mk, num);
          else addTo(out.caracteristicas, mk, num);
          return;
        }
        // Object leaf with (ability|stat|key|name) + (value|bonus|amount|mod|modifier)
        if (val && typeof val === 'object' && !Array.isArray(val)){
          const nameKey = ['ability','stat','key','name','atributo','caracteristica','defense','skill'].find(k=>k in val);
          const valueKey = ['value','bonus','amount','mod','modifier','valor'].find(k=>k in val);
          if (nameKey && valueKey){
            const mkName = mapKey(String(val[nameKey]));
            const vnum = parseFloat(val[valueKey]);
            if (Number.isFinite(vnum)){
              if (addComposite(mkName, vnum)) return;
              if (defKeys.has(mkName) || mk==='defense' || mk==='defenses') addTo(out.defesas, mkName, vnum);
              else if (perKeys.has(mkName) || mk==='skill' || mk==='skills') addTo(out.pericias, mkName, vnum);
              else addTo(out.caracteristicas, mkName, vnum);
              return;
            }
          }
          // Recurse with new hint on recognized sections
          let nextHint = hint;
          if (sec==='defesas' || sec==='pericias' || sec==='caracteristicas') nextHint = sec;
          walk(val, nextHint);
          return;
        }
        // Arrays as children
        if (Array.isArray(val)) { walk(val, sec==='defesas'||sec==='pericias'||sec==='caracteristicas'? sec : hint); return; }
      });
    }

    walk(raw, undefined);
    return out;
  }
  function cap(s){ try { return (s||'').charAt(0).toUpperCase()+String(s||'').slice(1); } catch(_) { return s; } }
  function listFrom(obj, keys){
    const parts=[]; if(!obj) return parts;
    const seen=new Set();
    (keys||[]).forEach(k=>{ const v=parseFloat(obj[k]); if(Number.isFinite(v) && v!==0){ parts.push((v>0?'+':'')+v+' '+cap(k)); seen.add(k); } });
    // include any other numeric keys present to avoid missing effects due to unexpected names/aliases
    Object.keys(obj).forEach(k=>{ if(seen.has(k)) return; const v=parseFloat(obj[k]); if(Number.isFinite(v) && v!==0){ parts.push((v>0?'+':'')+v+' '+cap(k)); } });
    return parts;
  }
  function poderesFromRow(tr){ return Array.from(tr.querySelectorAll('.item-power-def')).map(s => (s.getAttribute('data-nome')||'').trim()).filter(Boolean); }
  function renderPainel(){
    const alvo = document.getElementById('efeitos-itens-conteudo'); if(!alvo) return;
    const linhas = Array.from(document.querySelectorAll('#tabela-itens tbody tr'));
    const selecionados = linhas.filter(tr => tr.querySelector('input[type="checkbox"][name="itens"]')?.checked);
    if(selecionados.length===0){ alvo.innerHTML = '<em>Nenhum item selecionado.</em>'; return; }
    const grupos = {caracteristicas:['forca','vigor','destreza','agilidade','luta','inteligencia','prontidao','presenca'], defesas:['aparar','esquivar','fortitude','vontade','resistencia']};
    const pericias = ['acrobacias','atletismo','combate_distancia','combate_corpo','enganacao','especialidade','furtividade','intimidacao','intuicao','investigacao','percepcao','persuasao','prestidigitacao','tecnologia','tratamento','veiculos','historia','sobrevivencia','arcana','religiao'];
    const frag = document.createDocumentFragment();
    selecionados.forEach(tr => {
      const nome = (tr.querySelector('.nome-item')?.textContent||'Item').trim();
      const mods = normalizeMods(parseRawMods(tr));
      let car = listFrom(mods.caracteristicas||{}, grupos.caracteristicas);
      let def = listFrom(mods.defesas||{}, grupos.defesas);
      const per = listFrom(mods.pericias||{}, pericias);
      const pods = poderesFromRow(tr);
      // Sem fallbacks específicos por item — tudo vem de mods normalizados
      const box = document.createElement('div'); box.className='efeito-item-box'; box.style.margin='8px 0';
      const h = document.createElement('div'); h.style.fontWeight='600'; h.textContent=nome; box.appendChild(h);
      const ul=document.createElement('ul'); ul.style.margin='6px 0 0'; ul.style.paddingLeft='18px';
      if(car.length){ const li=document.createElement('li'); li.textContent='Características: '+car.join(', '); ul.appendChild(li); }
      if(def.length){ const li=document.createElement('li'); li.textContent='Defesas: '+def.join(', '); ul.appendChild(li); }
      if(per.length){ const li=document.createElement('li'); li.textContent='Perícias: '+(per.length>10? per.slice(0,10).join(', ')+` e +${per.length-10}` : per.join(', ')); ul.appendChild(li); }
      if(pods.length){ const li=document.createElement('li'); li.textContent='Poderes: '+pods.join(', '); ul.appendChild(li); }
      if(!ul.children.length){ const li=document.createElement('li'); li.innerHTML='<em>Sem efeitos diretos.</em>'; ul.appendChild(li); }
      box.appendChild(ul); frag.appendChild(box);
    });
    alvo.innerHTML=''; alvo.appendChild(frag);
  }
  document.getElementById('tabela-itens')?.addEventListener('change', function(ev){ if(ev.target && ev.target.matches('input[type="checkbox"][name="itens"]')) renderPainel(); });
  const _oldSync = window.atualizarCustos; window.atualizarCustos = function(){ if(typeof _oldSync==='function') _oldSync(); renderPainel(); };
  setTimeout(renderPainel, 60);
});
</script>
<!-- Cálculo de Ataque Total com Bônus compartilhado entre poderes ligados (nome+modo+duração) -->
<script>
(function(){
  function n(el){ if(!el) return 0; const v=parseFloat((el.value||'').toString().replace(',','.')); return isNaN(v)?0:v; }
  function kind(modoEl){
    let v=(modoEl?.value||'').toLowerCase();
    const t=(modoEl && modoEl.options && modoEl.options[modoEl.selectedIndex])? (modoEl.options[modoEl.selectedIndex].textContent||'').toLowerCase() : '';
    if(v.includes('melee')||t.includes('corpo')) return 'melee';
    if(v.includes('ranged')||t.includes('dist')) return 'ranged';
    return 'other';
  }
  function norm(s){ return (s||'').toString().trim().toLowerCase(); }
  function maxBonusFor(nome, mk, dur){
    let m=0;
  document.querySelectorAll('#poderes-main-list .poder-form').forEach(div=>{
      if(div.style.display==='none') return;
      const del=div.querySelector('input[type="checkbox"][name$="-DELETE"]'); if(del&&del.checked) return;
      const nEl=div.querySelector('[name$="-nome"]'); const mEl=div.querySelector('[name$="-modo"]'); const dEl=div.querySelector('[name$="-duracao"]'); const bEl=div.querySelector('[name$="-bonus_ataque"]');
      if(!nEl||!mEl||!dEl||!bEl) return;
      if(norm(nEl.value)===nome && kind(mEl)===mk && norm(dEl.value)===dur){ const v=parseFloat((bEl.value||'').toString().replace(',','.')); if(!isNaN(v)) m=Math.max(m, Math.abs(v)); }
    });
    return m;
  }
  function recalcAtaques(){
    const luta = n(document.getElementById('id_luta'));
    const des = n(document.getElementById('id_destreza'));
    const np  = Math.abs(n(document.getElementById('id_nivel_poder')));
    const baseLimite = 2 * np;
    const maxCharges = Math.floor(np/2);
    let viol=false;
    const arrCharges = new Map();
  document.querySelectorAll('#poderes-main-list .poder-form').forEach(div=>{
      if(div.style.display==='none') return;
      const modoEl = div.querySelector('[name$="-modo"]');
      const bonusEl = div.querySelector('[name$="-bonus_ataque"]');
      const nivelEfEl = div.querySelector('[name$="-nivel_efeito"]');
      const nomeEl = div.querySelector('[name$="-nome"]');
      const durEl = div.querySelector('[name$="-duracao"]');
      const chargesEl = div.querySelector('[name$="-charges"]');
  const totalSpan = div.querySelector('.linha-ataque-info .valor-ataque-total');
  const danoSpan = div.querySelector('.somar-forca-wrap .valor-dano-total');
      if(!modoEl || !bonusEl || !nivelEfEl || !totalSpan || !nomeEl || !durEl) return;
      const mk = kind(modoEl);
      let baseAttr = 0; if(mk==='melee') baseAttr = luta; else if(mk==='ranged') baseAttr = des;
      const useBonus = (mk==='other') ? n(bonusEl) : maxBonusFor(norm(nomeEl.value), mk, norm(durEl.value));
      const ataqueTotal = baseAttr + useBonus;
      totalSpan.textContent = ataqueTotal;
      // Atualiza Total Dano (nível efetivo) quando tipo é Dano
      if(danoSpan){
        let nEf = Math.abs(n(nivelEfEl));
        const tipoEl = div.querySelector('[name$="-tipo"]');
        if(tipoEl && tipoEl.value==='dano'){
          try { nEf = window.nivelEfeitoEfetivoPorDiv(div); } catch(e) { /* fallback fica no valor simples */ }
        }
        danoSpan.textContent = nEf;
      }
  // Cap check: (Bônus de Ataque usado + Nível de Efeito efetivo) ≤ 2×NP
  let nivelEf = 0;
  const somaForcaEl = div.querySelector('[name$="-somar_forca_no_nivel"]');
  if(somaForcaEl){ try { nivelEf = window.nivelEfeitoEfetivoPorDiv(div); } catch(e){ nivelEf = Math.abs(n(nivelEfEl)); } }
  else { nivelEf = Math.abs(n(nivelEfEl)); }
  const bonusUsado = useBonus; // já é o maior bônus compartilhado se aplicável
  // Charges ajustam o limite
  let charges = 0; if(chargesEl){ const cv = parseInt((chargesEl.value||'').toString(), 10); charges = isNaN(cv)?0:Math.max(0, cv); }
  // Contagem por array para validar no fim
  const arrName = (div.querySelector('[name$="-array"]')?.value || '').trim().toLowerCase();
  if (arrName && charges > 0){ arrCharges.set(arrName, (arrCharges.get(arrName)||0) + 1); }
  const cap = charges > 0 ? (baseLimite + maxCharges - (charges - 1)) : baseLimite;
  if((bonusUsado + nivelEf) > cap){ totalSpan.classList.add('violacao-ataque'); viol=true; } else { totalSpan.classList.remove('violacao-ataque'); }
  // Hard cap de charges por poder
  if (charges > maxCharges){ totalSpan.classList.add('violacao-ataque'); viol = true; }
    });
    // Regra: no máximo 1 poder com charges>0 por Array
    let violChargesArr = false;
    arrCharges.forEach((cnt) => { if (cnt > 1) violChargesArr = true; });
    const submitBtn = document.getElementById('submit-personagem');
    const box = document.getElementById('rule-violations');
    const list = document.getElementById('rule-violations-list');
    if(submitBtn && box && list){
      list.innerHTML = '';
      const messages = [];
      if(document.querySelector('.violacao-limite')){
        messages.push('Defesas excedendo os limites de 2×NP.');
      }
      if(viol){
        messages.push('Pelo menos um poder com Ataque Total + Nível de Efeito acima do limite permitido.');
      }
      if(violChargesArr){
        messages.push('Mais de um poder com Charges (>0) no mesmo Array.');
      }
      if(messages.length){
        submitBtn.disabled = true;
        submitBtn.title = 'Corrija os problemas listados acima para salvar.';
        box.style.display = '';
        messages.forEach(function(m){
          var li = document.createElement('li');
          li.textContent = m;
          list.appendChild(li);
        });
      } else {
        submitBtn.disabled = false;
        submitBtn.title = '';
        box.style.display = 'none';
      }
    }
  }
  window.recalcAtaquesSimples = recalcAtaques;
  document.addEventListener('input', ev=>{ if(ev.target.closest('#poderes-main-list .poder-form') || ['id_luta','id_destreza','id_nivel_poder','id_forca'].includes(ev.target.id)) { try{ window.toggleSomarForcaPoder(ev.target.closest('.poder-form')); }catch(e){} recalcAtaques(); } });
  document.addEventListener('change', ev=>{ if(ev.target.closest('#poderes-main-list .poder-form') || ['id_luta','id_destreza','id_nivel_poder','id_forca'].includes(ev.target.id)) { const div = ev.target.closest('.poder-form'); if(div){ try{ window.toggleSomarForcaPoder(div); }catch(e){} try{ window.toggleAtributoAfetado(div); }catch(e){} } recalcAtaques(); } });
  const oldAdd = window.adicionarPoder; window.adicionarPoder = function(){ if(oldAdd) oldAdd(); setTimeout(recalcAtaques, 80); };
  const oldRem = window.removerPoderLinha; window.removerPoderLinha = function(btn){ if(oldRem) oldRem(btn); setTimeout(recalcAtaques, 40); };
  const oldRemUlt = window.removerPoder; window.removerPoder = function(){ if(oldRemUlt) oldRemUlt(); setTimeout(recalcAtaques, 40); };
  setTimeout(recalcAtaques, 120);
})();
</script>
<script>
// ---- Totais de Defesas (valor + atributo + bônus de Itens) e verificação de limites ----
document.addEventListener('DOMContentLoaded', function(){
  const assoc = {
    aparar: 'luta',
    esquivar: 'agilidade',
    resistencia: 'vigor',
    vontade: 'prontidao',
    fortitude: 'vigor'
  };
  function num(id){ const el=document.getElementById('id_'+id); if(!el) return 0; const v=parseFloat((el.value||'').toString().replace(',','.')); return isNaN(v)?0:v; }
  function sumItemMods(){
    // Usa o normalizador robusto do painel (inclui aliases como AC/CA)
    const agg = { caracteristicas:{}, defesas:{}, pericias:{} };
    function addAll(dst, src){ Object.keys(src||{}).forEach(k=>{ const v=parseFloat(src[k]); if(!isNaN(v)) dst[k]=(dst[k]||0)+v; }); }
    document.querySelectorAll('#tabela-itens tbody tr').forEach(tr=>{
      const cb = tr.querySelector('input[type="checkbox"][name="itens"]');
      if(!cb || !cb.checked) return;
      let raw={}; try{ raw = JSON.parse(tr.getAttribute('data-mods')||'{}')||{}; }catch(_){ raw={}; }
      try{
        const norm = (typeof normalizeMods==='function') ? normalizeMods(raw) : {caracteristicas:{},defesas:{},pericias:{}};
        addAll(agg.caracteristicas, norm.caracteristicas);
        addAll(agg.defesas, norm.defesas);
        addAll(agg.pericias, norm.pericias);
      }catch(e){ /* ignore */ }
    });
    return agg;
  }
  function updateTotais(){
    const mods = sumItemMods();
    Object.keys(assoc).forEach(def => {
      const extra = (mods.defesas && typeof mods.defesas[def] !== 'undefined') ? parseFloat(mods.defesas[def])||0 : 0;
      const total = num(def) + num(assoc[def]) + extra;
      const span = document.getElementById('total_'+def);
      if(span){ span.textContent = total; span.title = extra ? ('Inclui +'+extra+' de itens') : ''; }
    });
    verificarLimites(mods);
  }
  function marcar(id, ok){ const el=document.getElementById(id); if(!el) return; if(ok){ el.classList.remove('violacao-limite'); } else { el.classList.add('violacao-limite'); } }
  function verificarLimites(mods){
    mods = mods || {defesas:{}};
    const np = num('nivel_poder');
    const limite = 2 * np;
    const esquivarTot = num('esquivar') + num('agilidade') + (parseFloat(mods.defesas?.esquivar)||0);
    const apararTot = num('aparar') + num('luta') + (parseFloat(mods.defesas?.aparar)||0);
    const resistenciaTot = num('resistencia') + num('vigor') + (parseFloat(mods.defesas?.resistencia)||0);
    const fortitudeTot = num('fortitude') + num('vigor') + (parseFloat(mods.defesas?.fortitude)||0);
    const vontadeTot = num('vontade') + num('prontidao') + (parseFloat(mods.defesas?.vontade)||0);
    marcar('total_esquivar', (esquivarTot + resistenciaTot) <= limite);
    marcar('total_resistencia', (esquivarTot + resistenciaTot) <= limite && (apararTot + resistenciaTot) <= limite);
    marcar('total_aparar', (apararTot + resistenciaTot) <= limite);
    marcar('total_fortitude', (fortitudeTot + vontadeTot) <= limite);
    marcar('total_vontade', (fortitudeTot + vontadeTot) <= limite);
    // Impede submit se houver violação
    const violacao = document.querySelector('.violacao-limite');
    const submitBtn = document.querySelector('form input[type="submit"]');
    if(submitBtn){ submitBtn.disabled = !!violacao; submitBtn.title = violacao? 'Corrija limites (defesas/poderes) para salvar.' : ''; }
  }
  const campos = ['nivel_poder','aparar','esquivar','resistencia','vontade','fortitude','luta','agilidade','vigor','prontidao'];
  campos.forEach(c=>{ const el=document.getElementById('id_'+c); if(el){ el.addEventListener('input', updateTotais); el.addEventListener('change', updateTotais); }});
  // Recalcular também quando itens são marcados/desmarcados
  document.querySelectorAll('#tabela-itens tbody input[type="checkbox"][name="itens"]').forEach(cb=>{ cb.addEventListener('change', updateTotais); });
  document.getElementById('tabela-itens')?.addEventListener('change', function(ev){ if(ev.target && ev.target.matches('input[type="checkbox"][name="itens"]')) updateTotais(); });
  // Recalcular também quando custos atualizam
  const oldAtualizar = window.atualizarCustos;
  window.atualizarCustos = function(){ if(typeof oldAtualizar==='function') oldAtualizar(); updateTotais(); };
  updateTotais();
});
</script>
<style>
.violacao-limite { color:#ff6161; font-weight:700; }
.violacao-ataque { color:#ffb347; font-weight:700; }
.defesa-total { font-size:0.75rem; opacity:0.9; margin-top:0.25rem; }
</style>
<script>
function adicionarPoder() {
  const formsetDiv = document.getElementById('poderes-formset');
  const poderesContainer = formsetDiv.querySelector('div[style*="flex-direction: column"]');
  const totalFormsInput = document.getElementById('id_poder_set-TOTAL_FORMS');
  if (!totalFormsInput) {
    console.error('TOTAL_FORMS não encontrado.');
    return;
  }
  const formIdx = parseInt(totalFormsInput.value);
  // Clona o bloco oculto do empty_form já estruturado
  const emptyDiv = document.getElementById('empty-poder-form').firstElementChild.cloneNode(true);
  // Substitui todos os __prefix__ pelo novo índice
  emptyDiv.innerHTML = emptyDiv.innerHTML.replace(/__prefix__/g, formIdx);
  if (poderesContainer) {
    poderesContainer.appendChild(emptyDiv);
  } else {
    formsetDiv.appendChild(emptyDiv);
  }
  totalFormsInput.value = formIdx + 1;
  if (typeof window.atualizarCamposOrigem === 'function') {
    try { window.atualizarCamposOrigem(emptyDiv); } catch(e) { /* noop */ }
  }
}
</script>

<script>
// Remove uma linha específica (botão dentro do bloco)
function removerPoderLinha(botao) {
  const formDiv = botao.closest('.poder-form');
  if (!formDiv) return;
  const deleteCheckbox = formDiv.querySelector('input[type="checkbox"][name$="-DELETE"]');
  const totalFormsInput = document.getElementById('id_poder_set-TOTAL_FORMS');
  if (!totalFormsInput) return;

  if (deleteCheckbox) {
    // Form existente: marca para deletar e esconde
    deleteCheckbox.checked = true;
    formDiv.style.display = 'none';
  } else {
    // Form recém adicionado (sem checkbox DELETE): remove e reindexa
    formDiv.remove();
    reindexarPoderes();
  }
  function reindexarPoderes() {
    const forms = document.querySelectorAll('#poderes-formset .poder-form');
    forms.forEach((div, idx) => {
      // Atualiza atributos name/id/for que contenham o índice
      div.querySelectorAll('[name]').forEach(el => {
        if (el.name.includes('poder_set-')) {
          el.name = el.name.replace(/poder_set-(\d+)-/, 'poder_set-' + idx + '-');
        }
      });
      div.querySelectorAll('[id]').forEach(el => {
        if (el.id.includes('poder_set-')) {
          el.id = el.id.replace(/poder_set-(\d+)-/, 'poder_set-' + idx + '-');
        }
      });
      div.querySelectorAll('label[for]').forEach(label => {
        if (label.htmlFor && label.htmlFor.includes('poder_set-')) {
          label.htmlFor = label.htmlFor.replace(/poder_set-(\d+)-/, 'poder_set-' + idx + '-');
        }
      });
    });
    totalFormsInput.value = forms.length;
  }
}
</script>

<!-- Adicione/ajuste este script no final do seu template criar_personagem.html ou editar_personagem.html -->
<script>
function removerPoder() {
  const formsetDiv = document.getElementById('poderes-formset');
  const totalFormsInput = document.getElementById('id_poder_set-TOTAL_FORMS');
  const poderForms = formsetDiv.querySelectorAll('#poderes-main-list .poder-form, .poder-item-outer .poder-form');
  const formCount = parseInt(totalFormsInput.value);

  if (formCount > 0) {
    const lastForm = poderForms[poderForms.length - 1];

    const deleteCheckbox = lastForm.querySelector('input[type="checkbox"][name$="DELETE"]');
    if (deleteCheckbox) {
      deleteCheckbox.checked = true;

      lastForm.style.display = 'none';
    } else {

      formsetDiv.removeChild(lastForm);
      totalFormsInput.value = formCount - 1;
    }
  }
}
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const busca = document.getElementById('busca-item');
  const filtroPossuido = document.getElementById('filtro-possuido');
  const filtroRaridade = document.getElementById('filtro-raridade');
  const filtroTipo = document.getElementById('filtro-tipo');
  const linhas = document.querySelectorAll('#tabela-itens tbody tr');
  function filtrar() {
    const texto = busca.value.toLowerCase();
    const soPossuido = filtroPossuido.checked;
    const raridadeSel = (filtroRaridade.value || '').toLowerCase();
    const tipoSel = (filtroTipo.value || '').toLowerCase();
    linhas.forEach(tr => {
      const nome = tr.querySelector('.nome-item').textContent.toLowerCase();
      const desc = (tr.querySelector('.descricao-item')?.textContent || '').toLowerCase();
      const rar = (tr.querySelector('.raridade-item')?.textContent || '').toLowerCase();
      const tipo = (tr.querySelector('.tipo-item')?.textContent || '').toLowerCase();
      const checkbox = tr.querySelector('input[type="checkbox"][name="itens"]');
      const possuido = checkbox && checkbox.checked;
      const matchTexto = !texto || nome.includes(texto) || desc.includes(texto);
      const matchRaridade = !raridadeSel || rar === raridadeSel;
      const matchTipo = !tipoSel || tipo === tipoSel;
      const matchPossuido = !soPossuido || possuido;
      const mostrar = matchTexto && matchRaridade && matchTipo && matchPossuido;
      tr.style.display = mostrar ? '' : 'none';
    });
  }
  [busca, filtroPossuido, filtroRaridade, filtroTipo].forEach(el => el.addEventListener('input', filtrar));
  filtroPossuido.addEventListener('change', filtrar);
  filtroRaridade.addEventListener('change', filtrar);
  filtroTipo.addEventListener('change', filtrar);
  filtrar();
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const busca = document.getElementById('busca-vantagem');
  const filtroSelecionada = document.getElementById('filtro-vantagem-selecionada');
  const linhas = document.querySelectorAll('#tabela-vantagens tbody tr');

  function filtrar() {
    const texto = busca.value.toLowerCase();
    const soSelecionada = filtroSelecionada.checked;

    linhas.forEach(tr => {
      const nome = tr.querySelector('.nome-vantagem').textContent.toLowerCase();
      const checkbox = tr.querySelector('input[type="checkbox"][name="vantagens"]');
      const selecionada = checkbox && checkbox.checked;

      const matchNome = nome.includes(texto);
      const matchSelecionada = !soSelecionada || selecionada;

      if (matchNome && matchSelecionada) {
        tr.style.display = '';
      } else {
        tr.style.display = 'none';
      }
    });
  }

  busca.addEventListener('input', filtrar);
  filtroSelecionada.addEventListener('change', filtrar);
  linhas.forEach(tr => {
    const checkbox = tr.querySelector('input[type="checkbox"][name="vantagens"]');
    if (checkbox) checkbox.addEventListener('change', filtrar);
  });
  filtrar();
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  function atualizarCamposOrigem(poderForm) {
    const deItem = poderForm.querySelector('input[type="checkbox"][name$="de_item"]');
    const deVantagem = poderForm.querySelector('input[type="checkbox"][name$="de_vantagem"]');
    // const itemOrigem = poderForm.querySelector('select[name$="item_origem"]');
    // const vantagemOrigem = poderForm.querySelector('select[name$="vantagem_origem"]');
    // const itemOrigemDiv = itemOrigem ? itemOrigem.parentElement : null;
    // const vantagemOrigemDiv = vantagemOrigem ? vantagemOrigem.parentElement : null;

    // REMOVA OU COMENTE AS LINHAS ABAIXO:
    // if (deItem && itemOrigemDiv) {
    //   itemOrigemDiv.style.display = deItem.checked ? '' : 'none';
    // }
    // if (deVantagem && vantagemOrigemDiv) {
    //   vantagemOrigemDiv.style.display = deVantagem.checked ? '' : 'none';
    // }

    // Impede marcar ambos ao mesmo tempo
    if (deItem && deVantagem) {
      deItem.addEventListener('change', function() {
        if (deItem.checked) deVantagem.checked = false;
      });
      deVantagem.addEventListener('change', function() {
        if (deVantagem.checked) deItem.checked = false;
      });
    }
  }

  // Exporta globalmente para uso após inserções dinâmicas
  window.atualizarCamposOrigem = atualizarCamposOrigem;

  document.querySelectorAll('#poderes-main-list .poder-form').forEach(function(poderForm) {
    try { atualizarCamposOrigem(poderForm); } catch(e){}
    const deItem = poderForm.querySelector('input[type="checkbox"][name$="de_item"]');
    const deVantagem = poderForm.querySelector('input[type="checkbox"][name$="de_vantagem"]');
    if (deItem) deItem.addEventListener('change', function() { if (typeof window.atualizarCamposOrigem === 'function') window.atualizarCamposOrigem(poderForm); });
    if (deVantagem) deVantagem.addEventListener('change', function() { if (typeof window.atualizarCamposOrigem === 'function') window.atualizarCamposOrigem(poderForm); });
  });
});
</script>
<script>
// Mostrar "Caminho de Aflição" apenas quando Tipo == Aflição (criar personagem)
document.addEventListener('DOMContentLoaded', function() {
  function atualizarCaminhoAflicao(div){
    if (!div) return;
    const tipoEl = div.querySelector('[name$="-tipo"]');
    const wrap = div.querySelector('.campo-caminho-aflicao');
    if (!wrap) return;
    const v = (tipoEl && (tipoEl.value || '') || '').toLowerCase();
    wrap.style.display = v === 'aflicao' ? '' : 'none';
  }
  window.atualizarCaminhoAflicao = atualizarCaminhoAflicao;
  function toggleTipoDano(div){
    if (!div) return;
    const tipoEl = div.querySelector('[name$="-tipo"]');
    const wrap = div.querySelector('.campo-tipo-dano');
    if (!wrap) return;
    const v = (tipoEl && (tipoEl.value || '') || '').toLowerCase();
    wrap.style.display = v === 'dano' ? '' : 'none';
  }
  window.toggleTipoDano = toggleTipoDano;
  function bind(scope){
    (scope || document).querySelectorAll('#poderes-main-list .poder-form [name$="-tipo"]').forEach(el=>{
      if (el.dataset.caminhoBound) return;
      el.addEventListener('change', function(){
        const div = el.closest('.poder-form');
        atualizarCaminhoAflicao(div);
        toggleTipoDano(div);
      });
      el.addEventListener('input', function(){
        const div = el.closest('.poder-form');
        atualizarCaminhoAflicao(div);
        toggleTipoDano(div);
      });
      el.dataset.caminhoBound = '1';
    });
    (scope || document).querySelectorAll('#poderes-main-list .poder-form').forEach(div=>{
      atualizarCaminhoAflicao(div);
      toggleTipoDano(div);
    });
  }
  bind(document);
  const oldAdd = window.adicionarPoder;
  window.adicionarPoder = function(){ if (typeof oldAdd === 'function') oldAdd(); setTimeout(()=>bind(document),60); };
});
</script>
<script>
// Badge de custo por poder (criar personagem) com lógica de Array
document.addEventListener('DOMContentLoaded', function(){
  function isDeletedOrHidden(div){
    const del = div.querySelector('input[type="checkbox"][name$="-DELETE"]');
    if (del && del.checked) return true;
    if (div.style.display === 'none') return true;
    return false;
  }
  function isItemOuVant(div){
    const chItem = div.querySelector('input[type="checkbox"][name$="-de_item"]');
    const chVant = div.querySelector('input[type="checkbox"][name$="-de_vantagem"]');
    return (chItem && chItem.checked) || (chVant && chVant.checked);
  }
  function baseDoPoder(div){
    if (isItemOuVant(div)) return 0;
    const sel = n => div.querySelector('[name$="-'+n+'"]');
    const nivelInput = sel('nivel_efeito');
    if (!nivelInput) return 0;
    let n = parseFloat((nivelInput.value||'').toString().replace(',', '.'))||0;
    n = Math.abs(n);
    if (n === 0) return 0;
    const tipo = (sel('tipo')?.value)||'';
    const dur = (sel('duracao')?.value)||'';
    const modo = (sel('modo')?.value)||'';
    const tipoBonus = (tipo==='cura'||tipo==='aprimorar')?1:0;
    const durBonus = dur==='concentracao'?1:(dur==='sustentado'?2:(dur==='reacao'?3:0));
    const modoBonus = modo==='ranged'?1:(modo==='area'?2:(modo==='percepcao'?3:0));
    // tipo_dano é aditivo (não entra no multiplicador)
    const tipoDano = (sel('tipo_dano')?.value||'').toLowerCase();
    const custoTipoDano = { fisico:0, acido:2, gelo:2, fogo:2, raio:2, veneno:2, mental:3, trovao:3, necrotico:5, radiante:5 };
    const tipoDanoBonus = tipo === 'dano' ? (custoTipoDano[tipoDano] || 0) : 0;
    return n * (1 + tipoBonus + durBonus + modoBonus) + tipoDanoBonus;
  }
  function breakdown(div){
    // Calcula n e bônus individuais para tooltip
    const sel = n => div.querySelector('[name$="-'+n+'"]');
    const nivelInput = sel('nivel_efeito');
    let n = 0; if (nivelInput){ n = parseFloat((nivelInput.value||'').toString().replace(',', '.'))||0; }
    n = Math.abs(n);
    const tipo = (sel('tipo')?.value)||'';
    const dur = (sel('duracao')?.value)||'';
    const modo = (sel('modo')?.value)||'';
    const tipoDano = (sel('tipo_dano')?.value)||'';
    const tipoBonus = (tipo==='cura'||tipo==='aprimorar')?1:0;
    const durBonus = dur==='concentracao'?1:(dur==='sustentado'?2:0);
    const modoBonus = modo==='ranged'?1:(modo==='area'?2:(modo==='percepcao'?3:0));
    const mult = 1 + tipoBonus + durBonus + modoBonus;
    // tipo_dano: Físico +0, Ácido/Gelo/Fogo/Raio/Veneno +2, Mental/Trovão +3, Necrótico/Radiante +5 (aditivo)
    let tipoDanoBonus = 0;
    if (tipo === 'dano' && tipoDano) {
      const mapaTipoDano = {
        'acido': 2, 'gelo': 2, 'fogo': 2, 'raio': 2, 'veneno': 2,
        'mental': 3, 'trovao': 3,
        'necrotico': 5, 'radiante': 5,
        'fisico': 0
      };
      tipoDanoBonus = mapaTipoDano[tipoDano.toLowerCase()] || 0;
    }
    const base = (n||0) * mult + tipoDanoBonus;
    // bonus de ataque para detalhamento
    const elBA = div.querySelector('[name$="-bonus_ataque"]');
    let bAtk = 0; if(elBA){ const v=parseFloat((elBA.value||'').toString().replace(',','.')); bAtk = isNaN(v)?0:Math.abs(v); }
    return { n, tipoBonus, durBonus, modoBonus, mult, base, bAtk, tipoDanoBonus };
  }
  function ensureBadge(div){
    let b = div.querySelector('.poder-custo-badge');
    if (!b){ b = document.createElement('span'); b.className = 'poder-custo-badge'; div.appendChild(b); }
    return b;
  }
  function setDetalhe(div, texto){
    let det = div.querySelector('.poder-custo-detalhe');
    if (!det){
      det = document.createElement('div');
      det.className = 'poder-custo-detalhe';
      det.style.gridColumn = '1 / -1';
      det.style.textAlign = 'right';
      det.style.fontSize = '0.85rem';
      det.style.color = '#cfcfe1';
      det.style.opacity = '0.95';
      det.style.paddingTop = '0.2rem';
      div.appendChild(det);
    }
    det.textContent = texto;
  }
  function updateBadges(){
  const forms = Array.from(document.querySelectorAll('#poderes-main-list .poder-form'));
    const grupos = new Map();
    const infos = [];
    forms.forEach(div => {
      if (isDeletedOrHidden(div)) return;
      const arr = (div.querySelector('[name$="-array"]')?.value||'').trim().toLowerCase();
      const base = baseDoPoder(div);
      const brk = breakdown(div);
      const excluido = isItemOuVant(div);
      const info = {div, arr, base, excluido, brk};
      infos.push(info);
      if (!excluido && arr){ if (!grupos.has(arr)) grupos.set(arr, []); grupos.get(arr).push(info); }
    });
    const lideres = new Map();
    grupos.forEach((lista, arr) => {
      let maxBase = -Infinity, lider = null;
      lista.forEach(info => { if (info.base > maxBase){ maxBase = info.base; lider = info; } });
      lideres.set(arr, {lider, maxBase, n: lista.length});
    });
    infos.forEach(info => {
      const {div, arr, base, excluido, brk} = info;
      const badge = ensureBadge(div);
      if (excluido){
        badge.textContent = 'Custo: 0';
        badge.title = 'Este poder não conta custo (Item/Vantagem).';
        setDetalhe(div, 'Item/Vantagem: custo 0');
        return;
      }
      if (!arr){
        const bonusCusto = (brk.bAtk||0) * 0.5;
        const total = base + bonusCusto;
        badge.textContent = 'Custo: ' + total;
        badge.title = `Base = Nível ${brk.n} × (1 + Tipo ${brk.tipoBonus} + Duração ${brk.durBonus} + Modo ${brk.modoBonus}) + Tipo Dano ${brk.tipoDanoBonus||0} = ${base}. Bônus de Ataque = ${brk.bAtk||0} × 0,5 = ${bonusCusto} (aditivo). Total: ${total}`;
        setDetalhe(div, `Sem array • Base: ${brk.n} × (1 + ${brk.tipoBonus}+${brk.durBonus}+${brk.modoBonus}) + Tipo Dano ${brk.tipoDanoBonus||0} = ${base} • Bônus Atk: ${brk.bAtk||0} × 0,5 = ${bonusCusto} • Total: ${total}`);
        return;
      }
      const meta = lideres.get(arr);
      if (!meta){
        badge.textContent = 'Custo: ' + base;
        badge.title = `Array vazio; usando base. Base = Nível ${brk.n} × (1 + ${brk.tipoBonus}+${brk.durBonus}+${brk.modoBonus}) + Tipo Dano ${brk.tipoDanoBonus||0} = ${base}`;
        setDetalhe(div, `Array (sem líder) • Base: ${brk.n} × (1 + ${brk.tipoBonus}+${brk.durBonus}+${brk.modoBonus}) + Tipo Dano ${brk.tipoDanoBonus||0} = ${base}`);
        return;
      }
      const contrib = (meta.lider === info) ? meta.maxBase : 1;
      const bonusCusto = (brk.bAtk||0) * 0.5;
      const total = contrib + bonusCusto;
      badge.textContent = 'Custo: ' + total;
      badge.title = `Array "${arr}": grupo = ${meta.maxBase} + (${meta.n}-1). Contribuição deste poder: ${contrib}. Base = Nível ${brk.n} × (1 + Tipo ${brk.tipoBonus} + Duração ${brk.durBonus} + Modo ${brk.modoBonus}) + Tipo Dano ${brk.tipoDanoBonus||0} = ${base}. Bônus de Ataque = ${brk.bAtk||0} × 0,5 = ${bonusCusto} (aditivo). Total: ${total}`;
      const papel = (meta.lider === info) ? 'Líder' : 'Membro';
      setDetalhe(div, `Array: ${arr} • ${papel} • Contrib.: ${contrib} • Base: ${brk.n} × (1 + ${brk.tipoBonus}+${brk.durBonus}+${brk.modoBonus}) + Tipo Dano ${brk.tipoDanoBonus||0} = ${base} • Bônus Atk: ${brk.bAtk||0} × 0,5 = ${bonusCusto} • Total: ${total}`);
    });
  }
  // Disponibiliza globalmente para o unificador final
  window.updateBadges = updateBadges;
  function bind(scope){ (scope||document).querySelectorAll('#poderes-main-list .poder-form select, #poderes-main-list .poder-form input').forEach(el => { el.addEventListener('input', updateBadges); el.addEventListener('change', updateBadges); }); }
  const oldAdd = window.adicionarPoder; window.adicionarPoder = function(){ oldAdd(); setTimeout(()=>{ bind(document); updateBadges(); }, 50); };
  const oldRemLinha = window.removerPoderLinha; window.removerPoderLinha = function(btn){ oldRemLinha(btn); setTimeout(updateBadges, 10); };
  const oldRem = window.removerPoder; window.removerPoder = function(){ oldRem(); setTimeout(updateBadges, 10); };
  bind(document);
  updateBadges();
});
</script>
<!-- Unificador final: garante que ao adicionar Poder recalculamos custos E badges -->
<script>
(function(){
  if(window._addPoderUnified) return; // evita dupla aplicação
  window._addPoderUnified = true;
  const prev = window.adicionarPoder;
  window.adicionarPoder = function(){
    if (typeof prev === 'function') prev();
    // Aguarda inserção do DOM e então recalcula tudo
    setTimeout(function(){
      if (typeof atualizarCustos === 'function') { try { atualizarCustos(); } catch(e) { /* noop */ } }
      if (typeof updateBadges === 'function') { try { updateBadges(); } catch(e) { /* noop */ } }
    }, 60);
  };
})();
</script>
{% endblock %}
<!-- Fallback delegado: garante recalculo em qualquer mudança nos campos de poderes -->
<script>
(function(){
  if(window._poderDelegatedRecalc) return; // evita duplicar
  window._poderDelegatedRecalc = true;
  function recalc(){
    if(typeof window.atualizarCustos === 'function'){ try{ window.atualizarCustos(); }catch(e){} }
    if(typeof window.updateBadges === 'function'){ try{ window.updateBadges(); }catch(e){} }
    if(typeof window.atualizarAtaques === 'function'){ try{ window.atualizarAtaques(); }catch(e){} }
  }
  document.addEventListener('input', function(ev){ if(ev.target && ev.target.closest('#poderes-main-list .poder-form')) recalc(); });
  document.addEventListener('change', function(ev){ if(ev.target && ev.target.closest('#poderes-main-list .poder-form')) recalc(); });
})();
</script>
<script>
// ---- Ataque Total (Luta/Destreza + Bônus) e Limite (Ataque Total + Nível de Efeito <= 2×NP) ----
document.addEventListener('DOMContentLoaded', function(){
  // Dinâmica de max para Charges: max = floor(NP/2), min=1; desabilita quando max<1
  function updateChargesMax(){
    const npEl = document.getElementById('id_nivel_poder');
    const np = npEl ? parseInt((npEl.value||'').toString(), 10) : 0;
    const maxCharges = Math.floor(Math.max(0, isNaN(np)?0:np) / 2);
  document.querySelectorAll('#poderes-main-list .poder-form [name$="-charges"]').forEach(inp=>{
      if(!inp) return;
      inp.setAttribute('min','1');
      inp.setAttribute('step','1');
      if (maxCharges >= 1){
        inp.removeAttribute('disabled');
        inp.setAttribute('max', String(maxCharges));
        const v = parseInt((inp.value||'').toString(), 10);
        if(!isNaN(v) && v > maxCharges){ inp.value = String(maxCharges); }
      } else {
        // NP/2 < 1: sem charges possíveis; limpa e desabilita para evitar números inválidos
        inp.value = '';
        inp.setAttribute('max','0');
        inp.setAttribute('disabled','disabled');
        inp.title = 'Charges indisponível para o NP atual (NP/2 < 1).';
      }
    });
  }
  // Expor global para outros scripts poderem chamar após adicionar/remover poderes
  window._updateChargesMax = updateChargesMax;
  function numFrom(el){
    if(!el) return 0; const v=parseFloat((el.value||'').toString().replace(',','.')); return isNaN(v)?0:v;
  }
  function getAttr(nome){ return document.getElementById('id_'+nome); }
  const lutaEl = getAttr('luta');
  const desEl = getAttr('destreza');
  const npEl = getAttr('nivel_poder');

  function processarLinha(div){
    const modo = div.querySelector('[name$="-modo"]');
    const bonus = div.querySelector('[name$="-bonus_ataque"]');
    const nivelEf = div.querySelector('[name$="-nivel_efeito"]');
    const chargesEl = div.querySelector('[name$="-charges"]');
    const totalSpan = div.querySelector('.valor-ataque-total');
    if(!modo || !bonus || !nivelEf || !totalSpan) return {viol:false};
    // Detecta modo (valor ou texto) para maior robustez
    let modoVal = (modo.value||'').toLowerCase();
    if(!modoVal && modo.options && modo.selectedIndex>=0){
      modoVal = (modo.options[modo.selectedIndex].value||'').toLowerCase();
    }
    // Alguns casos: label pode conter 'Corpo' ou 'Dist' mesmo que value não seja 'melee'/'ranged'
    let baseAttr;
    if(modoVal.includes('melee') || modoVal.includes('corpo')) baseAttr = numFrom(lutaEl);
    else if(modoVal.includes('ranged') || modoVal.includes('dist')) baseAttr = numFrom(desEl);
    else {
      // fallback: tenta texto da opção selecionada
      const optText = (modo.options && modo.options[modo.selectedIndex]) ? modo.options[modo.selectedIndex].textContent.toLowerCase() : '';
      if(optText.includes('corpo')) baseAttr = numFrom(lutaEl); else if(optText.includes('dist')) baseAttr = numFrom(desEl); else baseAttr = 0;
    }
    const bonusVal = numFrom(bonus);
    const ataqueTotal = baseAttr + bonusVal;
    totalSpan.textContent = ataqueTotal;
    let nivelEfeito = Math.abs(numFrom(nivelEf));
    const np = Math.abs(numFrom(npEl));
    const baseLimite = 2 * np;
    const maxCharges = Math.floor(np/2);
    let charges = 0; if (chargesEl){ const cv = parseInt((chargesEl.value||'').toString(), 10); charges = isNaN(cv)?0:Math.max(0, cv); }
    const cap = charges > 0 ? (baseLimite + maxCharges - (charges - 1)) : baseLimite;
    const viol = (ataqueTotal + nivelEfeito) > cap || (charges > maxCharges);
    totalSpan.classList.toggle('violacao-ataque', viol);
    return {viol};
  }
  function atualizarAtaques(){
    let algumaViol=false;
    // Verificação global de: no máximo 1 poder com charges>0 por Array
    const arrCharges = new Map();
  document.querySelectorAll('#poderes-main-list .poder-form').forEach(div=>{
      const del=div.querySelector('input[type="checkbox"][name$="-DELETE"]');
      if(del && del.checked) return;
      const r=processarLinha(div); if(r.viol) algumaViol=true;
      const arrName = (div.querySelector('[name$="-array"]')?.value || '').trim().toLowerCase();
      const chargesEl = div.querySelector('[name$="-charges"]');
      let charges = 0; if (chargesEl){ const cv = parseInt((chargesEl.value||'').toString(), 10); charges = isNaN(cv)?0:Math.max(0, cv); }
      if (arrName && charges > 0){ arrCharges.set(arrName, (arrCharges.get(arrName)||0) + 1); }
    });
    let violChargesArr = false; arrCharges.forEach(cnt => { if (cnt > 1) violChargesArr = true; });
    const submitBtn = document.querySelector('form input[type="submit"]');
    if(submitBtn){
      const temViolDef = !!document.querySelector('.violacao-limite');
      const temViolAtk = algumaViol || violChargesArr;
      if(temViolDef || temViolAtk){
        submitBtn.disabled = true;
        submitBtn.title = 'Corrija limites (defesas/poderes/charges) para salvar.';
      } else {
        submitBtn.disabled = false; submitBtn.title='';
      }
    }
  }
  window.atualizarAtaques = atualizarAtaques;
  // Integrar ao fluxo de atualização unificada
  const oldAtualizar = window.atualizarCustos;
  window.atualizarCustos = function(){ if(typeof oldAtualizar==='function') oldAtualizar(); atualizarAtaques(); };
  // Listeners diretos nos campos relevantes de cada poder
  function bindAtaqueListeners(scope){
  (scope||document).querySelectorAll('#poderes-main-list .poder-form').forEach(div=>{
      div.querySelectorAll('[name$="-modo"],[name$="-bonus_ataque"],[name$="-nivel_efeito"]').forEach(el=>{
        el.addEventListener('input', atualizarAtaques);
        el.addEventListener('change', atualizarAtaques);
      });
    });
  }
  bindAtaqueListeners(document);
  // Listeners para atributos base que influenciam ataque total
  ['luta','destreza','nivel_poder'].forEach(c=>{
    const el=document.getElementById('id_'+c); if(el){ el.addEventListener('input', atualizarAtaques); el.addEventListener('change', atualizarAtaques); }
  });
  // Rebind ao adicionar poder
  const oldAddPoder = window.adicionarPoder;
  window.adicionarPoder = function(){
    if(typeof oldAddPoder==='function') oldAddPoder();
    setTimeout(()=>{ bindAtaqueListeners(document); atualizarAtaques(); }, 80);
  };
  // Rebind ao remover linha (já recalcula depois)
  const oldRemLinha = window.removerPoderLinha;
  window.removerPoderLinha = function(btn){ if(typeof oldRemLinha==='function') oldRemLinha(btn); setTimeout(atualizarAtaques, 40); };
  // Rebind remover último
  const oldRemUlt = window.removerPoder;
  window.removerPoder = function(){ if(typeof oldRemUlt==='function') oldRemUlt(); setTimeout(atualizarAtaques, 40); };
  // Chamada inicial (delay para garantir preenchimento do formset renderizado)
  setTimeout(atualizarAtaques, 30);
  atualizarAtaques();
  updateChargesMax();
  // Ponte unificada caso scripts antigos chamem somente atualizarCustos
  if(!window.recalcularTudo){
    window.recalcularTudo = function(){
      if(typeof window.atualizarCustos === 'function') try{ window.atualizarCustos(); }catch(e){}
      if(typeof window.updateBadges === 'function') try{ window.updateBadges(); }catch(e){}
      if(typeof window.atualizarAtaques === 'function') try{ window.atualizarAtaques(); }catch(e){}
      if(typeof window._updateChargesMax === 'function') try{ window._updateChargesMax(); }catch(e){}
    };
  }
  // Atualizar dinamicamente quando NP muda
  const npElCharges = document.getElementById('id_nivel_poder');
  if (npElCharges){ npElCharges.addEventListener('input', updateChargesMax); npElCharges.addEventListener('change', updateChargesMax); }
  // Rebind ao adicionar/remover poderes
  const _oldAdd = window.adicionarPoder;
  window.adicionarPoder = function(){ if(typeof _oldAdd==='function') _oldAdd(); setTimeout(()=>{ updateChargesMax(); }, 60); };
  const _oldRem = window.removerPoderLinha;
  window.removerPoderLinha = function(btn){ if(typeof _oldRem==='function') _oldRem(btn); setTimeout(updateChargesMax, 40); };
  const _oldRemUlt = window.removerPoder;
  window.removerPoder = function(){ if(typeof _oldRemUlt==='function') _oldRemUlt(); setTimeout(updateChargesMax, 40); };
});
</script>
