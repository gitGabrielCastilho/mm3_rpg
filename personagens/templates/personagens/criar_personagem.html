{% extends 'base.html' %}
{% load static %}
{% load filtros %}

{% block content %}
  <h1>Criar Personagem</h1>
  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    
    <div>{{ form.nome.label_tag }} {{ form.nome }}</div>
    <div>{{ form.nivel_poder.label_tag }} {{ form.nivel_poder }}</div>

  <div>
    {{ form.foto.label_tag }} {{ form.foto }}
    {% if form.foto.value %}
      <br>
      <img src="{{ form.foto.value.url }}" alt="Foto atual" style="max-width:100px;">
    {% endif %}
  </div>

    <h2>Características</h2>
{% for campo in caracteristicas %}
  <div>
    {% with field=form|lookup:campo %}
      {{ field.label_tag }} {{ field }}
      {% if field.errors %}
        <div style="color:red;">{{ field.errors }}</div>
      {% endif %}
    {% endwith %}
  </div>
{% endfor %}

    <h2>Defesas</h2>
{% for campo in defesas %}
  <div>
    {% with field=form|lookup:campo %}
      {{ field.label_tag }} {{ field }}
      {% if field.errors %}
        <div style="color:red;">{{ field.errors }}</div>
      {% endif %}
    {% endwith %}
  </div>
{% endfor %}


    <h2>Perícias</h2>
<div>
  {{ form.especialidade_casting_ability.label_tag }} {{ form.especialidade_casting_ability }}
</div>

{% for campo in pericias %}
  <div>
    {% with field=form|lookup:campo %}
      {{ field.label_tag }} {{ field }}
      {% if field.errors %}
        <div style="color:red;">{{ field.errors }}</div>
      {% endif %}
    {% endwith %}
  </div>
{% endfor %}

    <h2>Poderes</h2>
<div id="poderes-formset">
  {{ formset.management_form }}
  {% for form in formset %}
    <div class="poder-form">
      {% for field in form.visible_fields %}
        {{ field.label_tag }} {{ field }}
      {% endfor %}
      {% if form.instance.pk %}{{ form.DELETE }} Remover{% endif %}
    </div>
  {% endfor %}
</div>

{% if form.non_field_errors %}
  <div style="color: red; margin-bottom: 1em;">
    {% for error in form.non_field_errors %}
      <div>{{ error }}</div>
    {% endfor %}
  </div>
{% endif %}

{% if formset.non_form_errors %}
  <div style="color: red; margin-bottom: 1em;">
    {% for error in formset.non_form_errors %}
      <div>{{ error }}</div>
    {% endfor %}
  </div>
{% endif %}

    <button type="button" onclick="adicionarPoder()">Adicionar Poder</button>
    <button type="button" onclick="removerPoder()">Remover Último Poder</button>
    <br><br>
<h2>Inventário</h2>
<div>
  Ouro: {{ inventario_form.ouro }}
</div>
<div>
  Dragon shard: {{ inventario_form.dragon_shard }}
</div>
<input type="text" id="busca-item" placeholder="Buscar por nome...">
<select id="filtro-raridade">
  <option value="">Todas as raridades</option>
  <option value="common">Comum</option>
  <option value="uncommon">Incomum</option>
  <option value="rare">Rara</option>
  <option value="very rare">Muito Rara</option>
  <option value="legendary">Lendária</option>
</select>
<div style="max-height: 350px; overflow-y: auto;">
  <table id="tabela-itens" border="1" style="width:100%;">
    <thead>
      <tr>
        <th>Selecionar</th>
        <th>Nome</th>
        <th>Tipo</th>
        <th>Raridade</th>
        <th>Descrição</th>
        <th>Preço</th>
      </tr>
    </thead>
    <tbody>
      {% for item in inventario_form.fields.itens.queryset %}
        <tr>
          <td>
            <input type="checkbox" name="itens" value="{{ item.id }}"
              {% if item in inventario_form.instance.itens.all %}checked{% endif %}>
          </td>
          <td class="nome-item">{{ item.nome }}</td>
          <td>{{ item.tipo }}</td>
          <td class="raridade-item">{{ item.raridade }}</td>
          <td>{{ item.descricao }}</td>
          <td>{{ item.preco }}</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

   <br><br>
    <input type="submit" value="Salvar">


  </form>

<script>
function adicionarPoder() {
  const formsetDiv = document.getElementById('poderes-formset');
  const totalFormsInput = document.getElementById('id_poder_set-TOTAL_FORMS');

  if (!totalFormsInput) {
    console.error('TOTAL_FORMS não encontrado.');
    return;
  }

  const formIdx = parseInt(totalFormsInput.value);
  const emptyFormHtml = `{{ formset.empty_form.as_p|escapejs }}`;
  const newFormHtml = emptyFormHtml.replace(/__prefix__/g, formIdx);

  const wrapper = document.createElement('div');
  wrapper.classList.add('poder-form'); // <-- Adicione esta linha!
  wrapper.innerHTML = newFormHtml;
  formsetDiv.appendChild(wrapper);

  totalFormsInput.value = formIdx + 1;
}
</script>

<!-- Adicione/ajuste este script no final do seu template criar_personagem.html ou editar_personagem.html -->
<script>
function removerPoder() {
  const formsetDiv = document.getElementById('poderes-formset');
  const totalFormsInput = document.getElementById('id_poder_set-TOTAL_FORMS');
  const poderForms = formsetDiv.querySelectorAll('.poder-form');
  const formCount = parseInt(totalFormsInput.value);

  if (formCount > 0) {
    const lastForm = poderForms[poderForms.length - 1];

    const deleteCheckbox = lastForm.querySelector('input[type="checkbox"][name$="DELETE"]');
    if (deleteCheckbox) {
      deleteCheckbox.checked = true;

      lastForm.style.display = 'none';
    } else {

      formsetDiv.removeChild(lastForm);
      totalFormsInput.value = formCount - 1;
    }
  }
}
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const busca = document.getElementById('busca-item');
  const filtro = document.getElementById('filtro-raridade');
  const linhas = document.querySelectorAll('#tabela-itens tbody tr');

  function filtrar() {
    const texto = busca.value.toLowerCase();
    const raridade = filtro.value.toLowerCase();
    let mostrados = 0;
    linhas.forEach(tr => {
      const nome = tr.querySelector('.nome-item').textContent.toLowerCase();
      const rar = tr.querySelector('.raridade-item').textContent.toLowerCase();
      const matchNome = nome.includes(texto);
      const matchRaridade = !raridade || rar === raridade;
      if (matchNome && matchRaridade) {
        tr.style.display = '';
      } else {
        tr.style.display = 'none';
      }
    });
  }

  busca.addEventListener('input', filtrar);
  filtro.addEventListener('change', filtrar);
  filtrar(); // mostrar só os 10 primeiros ao carregar
});
</script>
{% endblock %}
