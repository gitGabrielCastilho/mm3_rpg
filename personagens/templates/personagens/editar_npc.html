{% extends 'base.html' %}
{% load static %}
{% load filtros %}

{% block content %}
<div class="personagem-form-center">
  <h1 class="personagem-form-title">Editar NPC</h1>
  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    {% if form.non_field_errors or form.errors or formset.non_form_errors %}
      <div style="background:#2b1b1b; border:1px solid #a33; color:#f5cccc; padding:10px; margin-bottom:12px;">
        <strong>Erros no formulário:</strong>
        <ul style="margin:6px 0 0 18px;">
          {% for e in form.non_field_errors %}<li>{{ e }}</li>{% endfor %}
          {% for e in formset.non_form_errors %}<li>{{ e }}</li>{% endfor %}
          {% for name, errs in form.errors.items %}
            {% for e in errs %}<li>{{ name }}: {{ e }}</li>{% endfor %}
          {% endfor %}
        </ul>
      </div>
    {% endif %}

    <div class="personagem-form-fields">
      <div id="painel-custos" style="background:#1e1e28; border:1px solid #444; padding:0.8rem 1rem; margin-bottom:1.2rem; font-size:0.95rem; line-height:1.3;">
        <strong>Custos (dinâmico):</strong>
        <div style="display:flex; flex-wrap:wrap; gap:1rem; margin-top:0.4rem;">
          <span>Características: <span id="custo-caracteristicas">0</span></span>
          <span>Defesas: <span id="custo-defesas">0</span></span>
          <span>Perícias: <span id="custo-pericias">0</span></span>
          <span>Resist/Imun: <span id="custo-resistencias">0</span></span>
          <span>Poderes: <span id="custo-poderes">0</span></span>
          <span style="font-weight:bold;">Total: <span id="custo-total">0</span></span>
        </div>
      </div>

      <div class="linha-topo" style="display:flex; gap:2rem; flex-wrap:wrap; align-items:flex-start;">
        <div class="campo-nome" style="flex:1 1 200px; min-width:180px;">
          {{ form.nome.label_tag }} {{ form.nome }}
        </div>
        <div class="campo-foto" style="flex:2 1 320px; min-width:260px;">
          {{ form.foto.label_tag }} {{ form.foto }}
          {% if form.instance.foto %}
            <br>
            <img src="{{ form.instance.foto.url }}" alt="Foto atual" style="max-width:100px; margin-top:0.4rem;">
          {% endif %}
        </div>
        <div class="campo-np" style="flex:1 1 160px; min-width:140px;">
          {{ form.nivel_poder.label_tag }} {{ form.nivel_poder }}
        </div>
        <div class="campo-campanga" style="flex:0 1 160px; min-width:140px; align-self:center;">
          <label for="id_campanga" style="display:inline-block; margin-right:0.4rem;">Campanga?</label>
          {{ form.campanga }}
        </div>
      </div>

      <h2>Características <span id="badge-carac" class="section-cost-badge" title="Cada ponto em Características custa +2 pp.">+2 pp — 0</span></h2>
      <div class="caracteristicas-grid espacamento-campos" style="display:grid; grid-template-columns:repeat(4, minmax(110px,1fr)); gap:1.5rem 2.5rem; justify-items:center;">
        <div class="campo-carac">{{ form.forca.label_tag }} {{ form.forca }}</div>
        <div class="campo-carac">{{ form.vigor.label_tag }} {{ form.vigor }}</div>
        <div class="campo-carac">{{ form.destreza.label_tag }} {{ form.destreza }}</div>
        <div class="campo-carac">{{ form.prontidao.label_tag }} {{ form.prontidao }}</div>
        <div class="campo-carac">{{ form.presenca.label_tag }} {{ form.presenca }}</div>
        <div class="campo-carac">{{ form.inteligencia.label_tag }} {{ form.inteligencia }}</div>
        <div class="campo-carac">{{ form.luta.label_tag }} {{ form.luta }}</div>
        <div class="campo-carac">{{ form.agilidade.label_tag }} {{ form.agilidade }}</div>
      </div>

      <h2>Defesas <span id="badge-def" class="section-cost-badge" title="Cada ponto em Defesas custa +1 pp.">+1 pp — 0</span></h2>
      <div class="defesas-grid" style="display:grid; grid-template-columns:repeat(3, minmax(170px,1fr)); gap:1.8rem 3rem; justify-items:center; margin-bottom:2rem;">
        <div class="campo-def">
          <label for="id_aparar">Aparar <small>(Luta)</small></label>
          {{ form.aparar }}
          <div class="defesa-total" data-defesa="aparar">Total: <span class="valor-total" id="total_aparar">0</span></div>
        </div>
        <div class="campo-def">
          <label for="id_esquivar">Esquivar <small>(Agilidade)</small></label>
          {{ form.esquivar }}
          <div class="defesa-total" data-defesa="esquivar">Total: <span class="valor-total" id="total_esquivar">0</span></div>
        </div>
        <div class="campo-def">
          <label for="id_resistencia">Resistência <small>(Vigor)</small></label>
          {{ form.resistencia }}
          <div class="defesa-total" data-defesa="resistencia">Total: <span class="valor-total" id="total_resistencia">0</span></div>
        </div>
        <div class="campo-def">
          <label for="id_vontade">Vontade <small>(Prontidão)</small></label>
          {{ form.vontade }}
          <div class="defesa-total" data-defesa="vontade">Total: <span class="valor-total" id="total_vontade">0</span></div>
        </div>
        <div class="campo-def">
          <label for="id_fortitude">Fortitude <small>(Vigor)</small></label>
          {{ form.fortitude }}
          <div class="defesa-total" data-defesa="fortitude">Total: <span class="valor-total" id="total_fortitude">0</span></div>
        </div>
        <div></div>
      </div>

  <h2>Resistências e Imunidades <span id="badge-res" class="section-cost-badge" title="Resistência: +5 pp por tipo. Imunidade: +10 pp por tipo.">Resist 5 / Imun 10 — 0</span></h2>
      <div style="margin-bottom:1.6rem; display: flex; justify-content: center;">
        <div style="display: grid; grid-template-columns: auto auto auto; gap: 0.8rem 2rem; align-items: center;">
          <div style="font-weight: bold; text-align: center;">Tipo de Dano</div>
          <div style="font-weight: bold; text-align: center;">Resistência</div>
          <div style="font-weight: bold; text-align: center;">Imunidade</div>
          {% for choice_value, choice_label in form.resistencias_dano.field.choices %}
            <label style="margin: 0; cursor: pointer; text-align: center;">{{ choice_label }}</label>
            <div style="text-align: center;">
              <input type="checkbox" name="resistencias_dano" value="{{ choice_value }}" id="id_resistencias_dano_{{ forloop.counter0 }}" {% if choice_value in form.resistencias_dano.value %}checked{% endif %}>
            </div>
            <div style="text-align: center;">
              <input type="checkbox" name="imunidades_dano" value="{{ choice_value }}" id="id_imunidades_dano_{{ forloop.counter0 }}" {% if choice_value in form.imunidades_dano.value %}checked{% endif %}>
            </div>
          {% endfor %}
        </div>
      </div>

      <h2>Perícias <span id="badge-per" class="section-cost-badge" title="Cada ponto em Perícias custa +0,5 pp.">+0,5 pp — 0</span></h2>
      <div>
        {{ form.especialidade_casting_ability.label_tag }} {{ form.especialidade_casting_ability }}
      </div>
      <div class="pericias-grid-4" style="display:grid; grid-template-columns:repeat(4, minmax(140px,1fr)); gap:1.4rem 2.2rem; justify-items:center; margin-bottom:2rem;">
        {% for campo in pericias_col1 %}
          {% if campo != 'combate_distancia' and campo != 'combate_corpo' %}
            {% with field=form|lookup:campo %}
              <div class="pericia-campo" style="display:flex; flex-direction:column; align-items:center;">
                <label style="font-weight:bold; margin-bottom:0.25rem;">{{ field.label }}</label>
                {{ field }}
              </div>
            {% endwith %}
          {% endif %}
        {% endfor %}
        {% for campo in pericias_col2 %}
          {% if campo != 'combate_distancia' and campo != 'combate_corpo' %}
            {% with field=form|lookup:campo %}
              <div class="pericia-campo" style="display:flex; flex-direction:column; align-items:center;">
                <label style="font-weight:bold; margin-bottom:0.25rem;">{{ field.label }}</label>
                {{ field }}
              </div>
            {% endwith %}
          {% endif %}
        {% endfor %}
      </div>

  <h2>Poderes <span id="badge-pod" class="section-cost-badge" title="Custo por poder = Nível × (1 + bônus de Tipo + bônus de Tipo Dano + Duração + Modo) + Bônus de Ataque. Bônus: Tipo: +1 (cura/aprimorar). Tipo Dano (apenas Dano): +0 (físico), +2 (ácido/gelo/fogo/raio/veneno), +3 (mental/trovão), +5 (necrótico/radiante). Duração: +1 (concentração), +2 (sustentado), +3 (reação). Modo: +1 (ranged), +2 (área), +3 (percepção). Bônus de Ataque: +0,5 pp por ponto (aditivo, por poder). Arrays: parte de Nível do grupo = maior base + (n−1); cada poder ainda soma seu próprio Bônus de Ataque.">Nivel x (1+Tipo+TipoDano+Duração+Modo) + Bônus Ataque — 0</span></h2>
      <div id="empty-poder-form" style="display:none;">
        <div class="poder-form poder-form-grid" style="border:1px solid #444; width:100%; position: relative;">
          <div class="campo-poder">{{ formset.empty_form.nome.label_tag }}{{ formset.empty_form.nome }}</div>
          <div class="campo-poder">{{ formset.empty_form.array.label_tag }}{{ formset.empty_form.array }}</div>
          <div class="campo-poder">{{ formset.empty_form.tipo.label_tag }}{{ formset.empty_form.tipo }}</div>
          <div class="campo-poder">{{ formset.empty_form.modo.label_tag }}{{ formset.empty_form.modo }}</div>
          <div class="campo-poder">{{ formset.empty_form.duracao.label_tag }}{{ formset.empty_form.duracao }}</div>
          <div class="campo-poder campo-atributo-afetado">{{ formset.empty_form.casting_ability.label_tag }}{{ formset.empty_form.casting_ability }}</div>
          <div class="campo-poder">{{ formset.empty_form.nivel_efeito.label_tag }}{{ formset.empty_form.nivel_efeito }}</div>
          <div class="campo-poder somar-forca-wrap" title="Se marcado e for Dano Corpo a Corpo, o nível de efeito soma a Força.">
            <label for="{{ formset.empty_form.somar_forca_no_nivel.id_for_label }}">
              {{ formset.empty_form.somar_forca_no_nivel }} Somar Força ao Nível (melee)
            </label>
          </div>
          <div class="campo-poder">{{ formset.empty_form.bonus_ataque.label_tag }}{{ formset.empty_form.bonus_ataque }}</div>
          <div class="linha-ataque-info" style="grid-column:1/-1; font-size:0.7rem; display:flex; justify-content:space-between; align-items:center; margin-top:0.2rem; gap:1rem;">
            <span class="hint-bonus-ataque" style="text-align:left;" title="Corpo a Corpo: Luta + Bônus | À Distância: Destreza + Bônus | Limite referência (Ataque Total + Nível de Efeito) ≤ 2×NP (NPC não bloqueia) | Custo: cada ponto em Bônus de Ataque soma +0,5 pp (aditivo)">ⓘ Corpo a Corpo: Luta + Bônus | À Distância: Destreza + Bônus | Limite ref 2×NP | Custo: Bônus Ataque +0,5 pp por ponto</span>
            <span style="white-space:nowrap;">Total Ataque: <span class="valor-ataque-total">0</span></span>
          </div>
          <div class="campo-poder">{{ formset.empty_form.defesa_ativa.label_tag }}{{ formset.empty_form.defesa_ativa }}</div>
          <div class="campo-poder">{{ formset.empty_form.defesa_passiva.label_tag }}{{ formset.empty_form.defesa_passiva }}</div>
          <div class="campo-poder span-2">
            <div class="helptext">Ligação automática: poderes com mesmo nome, modo e duração serão ligados ao salvar.</div>
          </div>
          <div class="span-2" style="margin-top:0.4rem; text-align:right; display:flex; gap:0.7rem; justify-content:flex-end;">
            <span style="display:none;">{{ formset.empty_form.DELETE }}</span>
            <button type="button" class="btn btn-danger" onclick="removerPoderLinha(this)">Remover</button>
          </div>
        </div>
      </div>

      <div class="poder-form-outer">
        <div id="poderes-formset">
          {{ formset.management_form }}
          <div style="display: flex; flex-direction: column; gap: 1.5rem; align-items: center;">
            {% for form in formset %}
              <div class="poder-form poder-form-grid" style="border:1px solid #444; width:100%; position: relative;">
                <div style="display:none;">
                  {% for h in form.hidden_fields %}{{ h }}{% endfor %}
                  {% if form.instance.pk %}<input type="hidden" name="{{ form.prefix }}-id" value="{{ form.instance.pk }}">{% endif %}
                  {{ form.DELETE }}
                </div>
                <div class="campo-poder">{{ form.nome.label_tag }}{{ form.nome }}</div>
                <div class="campo-poder">{{ form.array.label_tag }}{{ form.array }}</div>
                <div class="campo-poder">{{ form.tipo.label_tag }}{{ form.tipo }}</div>
                <div class="campo-poder campo-tipo-dano">{{ form.tipo_dano.label_tag }}{{ form.tipo_dano }}</div>
                <div class="campo-poder campo-caminho-aflicao">{{ form.caminho_aflicao.label_tag }}{{ form.caminho_aflicao }}</div>
                <div class="campo-poder">{{ form.modo.label_tag }}{{ form.modo }}</div>
                <div class="campo-poder somar-forca-wrap span-2" title="Se marcado e for Dano Corpo a Corpo, o nível de efeito soma a Força.">
                  <label for="{{ form.somar_forca_no_nivel.id_for_label }}">
                    {{ form.somar_forca_no_nivel }} Somar Força ao Nível (melee)
                    <span class="info-tip" title="Se marcado e Dano melee: Nível Efetivo = Nível + Força. O limite usa o Nível Efetivo.">ⓘ</span>
                  </label>
                </div>
                <div class="campo-poder">{{ form.duracao.label_tag }}{{ form.duracao }}</div>
                <div class="campo-poder campo-atributo-afetado">{{ form.casting_ability.label_tag }}{{ form.casting_ability }}</div>
                <div class="campo-poder">{{ form.nivel_efeito.label_tag }}{{ form.nivel_efeito }}</div>
                <div class="campo-poder">{{ form.bonus_ataque.label_tag }}{{ form.bonus_ataque }}</div>
                <div class="linha-ataque-info" style="grid-column:1/-1; font-size:0.7rem; display:flex; justify-content:space-between; align-items:center; margin-top:0.2rem; gap:1rem;">
                  <span class="hint-bonus-ataque" style="text-align:left;" title="Corpo a Corpo: Luta + Bônus | À Distância: Destreza + Bônus | Limite referência (Ataque Total + Nível de Efeito) ≤ 2×NP (NPC não bloqueia) | Custo: cada ponto em Bônus de Ataque soma +0,5 pp (aditivo)">ⓘ Corpo a Corpo: Luta + Bônus | À Distância: Destreza + Bônus | Limite ref 2×NP | Custo: Bônus Ataque +0,5 pp por ponto</span>
                  <span style="white-space:nowrap;">Total Ataque: <span class="valor-ataque-total">0</span></span>
                </div>
                <div class="campo-poder">{{ form.defesa_ativa.label_tag }}{{ form.defesa_ativa }}</div>
                <div class="campo-poder">{{ form.defesa_passiva.label_tag }}{{ form.defesa_passiva }}</div>
                <div class="poder-custo-detalhe" style="grid-column:1 / -1; text-align:right; font-size:0.85rem; color:#cfcfe1; opacity:0.95; padding-top:0.2rem;"></div>
                <div class="campo-poder span-2">
                  <div class="helptext">Ligação automática: poderes com mesmo nome, modo e duração serão ligados ao salvar.</div>
                </div>
                {% if form.DELETE %}
                  <div class="span-2" style="margin-top:0.4rem; text-align: right; display: flex; align-items: center; gap: 0.7rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-danger" onclick="removerPoderLinha(this)">Remover</button>
                  </div>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        </div>
      </div>

      <div style="margin-top:1.5rem; display:flex; gap:1rem; justify-content:center;">
        <button type="button" class="btn btn-danger" onclick="adicionarPoder()">Adicionar Poder</button>
        <button type="button" class="btn btn-danger" onclick="removerPoder()">Remover Último Poder</button>
      </div>

      <div id="npc-rule-violations" class="form-rule-errors" style="display:none; margin-top:1.5rem;">
        <strong>Avisos de referência de regras (não bloqueiam salvar):</strong>
        <ul id="npc-rule-violations-list"></ul>
      </div>

      <div style="margin-top:2rem; text-align:center;">
        <input type="submit" value="Salvar NPC" class="btn" id="submit-npc">
        <a href="{% url 'listar_npcs' %}" class="btn" style="margin-left:0.6rem;">Voltar</a>
      </div>
    </div>
  </form>
</div>

<script>
// ---- Cálculo Dinâmico de Custos (Editar NPC) ----
document.addEventListener('DOMContentLoaded', function() {
  const camposCaracteristicas = ['forca','vigor','destreza','agilidade','luta','inteligencia','prontidao','presenca'];
  const camposDefesas = ['aparar','esquivar','fortitude','vontade','resistencia'];
  const camposPericias = ['acrobacias','atletismo','combate_distancia','combate_corpo','enganacao','especialidade','furtividade','intimidacao','intuicao','investigacao','percepcao','persuasao','prestidigitacao','tecnologia','tratamento','veiculos','historia','sobrevivencia','arcana','religiao'];
  function val(id){ const el=document.getElementById('id_'+id); if(!el) return 0; const v=parseFloat((el.value||'').toString().replace(',', '.')); return isNaN(v)?0:v; }
  function custoPoderDiv(div){ function sel(n){ return div.querySelector('[name$="-'+n+'"]'); }
    const chItem = div.querySelector('input[type="checkbox"][name$="-de_item"]');
    const chVant = div.querySelector('input[type="checkbox"][name$="-de_vantagem"]');
    if ((chItem && chItem.checked) || (chVant && chVant.checked)) return 0;
    let n=parseFloat((sel('nivel_efeito')?.value)||0)||0; n=Math.abs(n); if(n===0) return 0;
    const tipo=(sel('tipo')?.value)||''; const dur=(sel('duracao')?.value)||''; const modo=(sel('modo')?.value)||'';
    const tipoDano = (sel('tipo_dano')?.value)||'';
    const tipoB=(tipo==='cura'||tipo==='aprimorar')?1:0;
    const mapaTipoDano = {
      'acido': 2, 'gelo': 2, 'fogo': 2, 'raio': 2, 'veneno': 2,
      'mental': 3, 'trovao': 3,
      'necrotico': 5, 'radiante': 5,
      'fisico': 0
    };
    let tipoDanoB = 0;
    if (tipo === 'dano' && tipoDano) {
      tipoDanoB = mapaTipoDano[tipoDano.toLowerCase()] || 0;
    }
    const durB=dur==='concentracao'?1:(dur==='sustentado'?2:0); const modoB=modo==='ranged'?1:(modo==='area'?2:(modo==='percepcao'?3:0));
    return n*(1+tipoB+durB+modoB) + tipoDanoB;
  }
  
  // Validar que um tipo de dano não pode ser resistente E imune simultaneamente
  function validarResistenciaImunidade() {
    const resistenciasCheckboxes = document.querySelectorAll('input[name="resistencias_dano"][type="checkbox"]');
    const imunidadesCheckboxes = document.querySelectorAll('input[name="imunidades_dano"][type="checkbox"]');
    
    // Desabilitar um se o outro está marcado
    resistenciasCheckboxes.forEach(cb => {
      const immCb = Array.from(imunidadesCheckboxes).find(i => i.value === cb.value);
      if (immCb && immCb.checked && cb.checked) {
        cb.checked = false;
      }
      cb.disabled = immCb && immCb.checked;
    });
    imunidadesCheckboxes.forEach(cb => {
      const resCb = Array.from(resistenciasCheckboxes).find(r => r.value === cb.value);
      if (resCb && resCb.checked && cb.checked) {
        cb.checked = false;
      }
      cb.disabled = resCb && resCb.checked;
    });
  }
  
  function custoBonusAtaque(div){
    const el = div.querySelector('[name$="-bonus_ataque"]'); if(!el) return 0;
    const v=parseFloat((el.value||'').toString().replace(',','.')); const b = isNaN(v)?0:Math.abs(v);
    const chItem = div.querySelector('input[type="checkbox"][name$="-de_item"]');
    const chVant = div.querySelector('input[type="checkbox"][name$="-de_vantagem"]');
    if ((chItem && chItem.checked) || (chVant && chVant.checked)) return 0; return b * 0.5;
  }
  function atualizar(){
    const custoCarac=camposCaracteristicas.reduce((s,c)=>s+val(c),0)*2;
    const custoDef=camposDefesas.reduce((s,c)=>s+val(c),0);
    const custoPer=camposPericias.reduce((s,c)=>s+val(c),0)*0.5;
    const resCount = document.querySelectorAll('input[name="resistencias_dano"]:checked').length;
    const imuCount = document.querySelectorAll('input[name="imunidades_dano"]:checked').length;
    const custoRes = resCount * 5 + imuCount * 10;
    const grupos=new Map(); const gruposBonus=new Map(); const individuais=[]; let bonusSemArray=0;
    document.querySelectorAll('.poder-form').forEach(div=>{
      const del=div.querySelector('input[name$="-DELETE"]'); if(del&&del.checked) return; if(div.style.display==='none') return;
      const chItem = div.querySelector('input[type="checkbox"][name$="-de_item"]');
      const chVant = div.querySelector('input[type="checkbox"][name$="-de_vantagem"]');
      if ((chItem && chItem.checked) || (chVant && chVant.checked)) return;
      const base=custoPoderDiv(div); const bAtk=custoBonusAtaque(div);
      const arr=(div.querySelector('[name$="-array"]')?.value||'').trim().toLowerCase();
      if(arr){ if(!grupos.has(arr)) grupos.set(arr, []); grupos.get(arr).push(base); gruposBonus.set(arr,(gruposBonus.get(arr)||0)+bAtk);} else { individuais.push(base); bonusSemArray+=bAtk; }
    });
    let custoPod=individuais.reduce((a,b)=>a+b,0) + bonusSemArray;
    let temArray=false;
    grupos.forEach((bases,nome)=>{ if(!bases||bases.length===0) return; const n=bases.length; const maxBase=Math.max.apply(null,bases); custoPod += maxBase + Math.max(0, n-1); custoPod += (gruposBonus.get(nome)||0); temArray=true; });
    const total=custoCarac+custoDef+custoPer+custoPod+custoRes;
    function fmt(x){ return (Math.round(x*10)%10===0)?x: x.toFixed(1).replace('.0',''); }
    document.getElementById('custo-caracteristicas').textContent=custoCarac;
    document.getElementById('custo-defesas').textContent=custoDef;
    document.getElementById('custo-pericias').textContent=fmt(custoPer);
    const elRes = document.getElementById('custo-resistencias'); if(elRes) elRes.textContent = custoRes;
    document.getElementById('custo-poderes').textContent=custoPod;
    document.getElementById('custo-total').textContent=fmt(total);
    const bCar=document.getElementById('badge-carac'); if(bCar){ bCar.textContent = '+2 pp — '+custoCarac; bCar.title='Cada ponto em Características custa +2 pp. Total atual: '+custoCarac; }
    const bDef=document.getElementById('badge-def'); if(bDef){ bDef.textContent = '+1 pp — '+custoDef; bDef.title='Cada ponto em Defesas custa +1 pp. Total atual: '+custoDef; }
    const bPer=document.getElementById('badge-per'); if(bPer){ bPer.textContent = '+0,5 pp — '+fmt(custoPer); bPer.title='Cada ponto em Perícias custa +0,5 pp. Total atual: '+fmt(custoPer); }
    const bRes=document.getElementById('badge-res'); if(bRes){ bRes.textContent = 'Resist 5 / Imun 10 — '+custoRes; bRes.title='Resistência a dano custa 5 pp por tipo; Imunidade custa 10 pp por tipo. Total atual: '+custoRes; }
  const bPod=document.getElementById('badge-pod'); if(bPod){ const labelBase='Nivel x (1+Tipo+TipoDano+Duração+Modo) + Bônus Ataque'; bPod.textContent=(temArray?labelBase+' + Arrays':labelBase)+' — '+custoPod; bPod.title='Custo por poder = Nível × (1 + bônus de Tipo + bônus de Tipo Dano + Duração + Modo) + Bônus de Ataque. Bônus: Tipo: +1 (cura/aprimorar). Tipo Dano (apenas Dano): +0 (físico), +2 (ácido/gelo/fogo/raio/veneno), +3 (mental/trovão), +5 (necrótico/radiante). Duração: +1 (concentração), +2 (sustentado), +3 (reação). Modo: +1 (ranged), +2 (área), +3 (percepção). Bônus de Ataque: +0,5 pp por ponto (aditivo, por poder). '+(temArray?'Arrays: parte de Nível = maior base + (n−1); cada poder ainda soma seu próprio Bônus de Ataque. ':'')+'Total atual: '+custoPod; }
  }
  ;[].concat(camposCaracteristicas,camposDefesas,camposPericias).forEach(id=>{ const el=document.getElementById('id_'+id); if(el){ el.addEventListener('input',atualizar); el.addEventListener('change',atualizar);} });
  document.querySelectorAll('input[name="resistencias_dano"], input[name="imunidades_dano"]').forEach(el=>{
    el.addEventListener('change', validarResistenciaImunidade);
    el.addEventListener('change', atualizar);
  });
  function bind(div){ div.querySelectorAll('select,input').forEach(el=>{ el.addEventListener('input',atualizar); el.addEventListener('change',atualizar); }); }
  document.querySelectorAll('.poder-form').forEach(div=>bind(div));
  // Garantir que tipo_dano dispara atualização (incluindo badges individuais)
  document.querySelectorAll('.poder-form [name$="-tipo_dano"]').forEach(el=>{
    el.addEventListener('change', atualizar);
    el.addEventListener('change', updateBadges);
  });
  const oldAdd=window.adicionarPoder; window.adicionarPoder=function(){ if(typeof oldAdd==='function') oldAdd(); setTimeout(()=>{ const last=document.querySelector('.poder-form:last-child'); if(last){ bind(last); atualizar(); } },50); };
  const oldRemLinha=window.removerPoderLinha; window.removerPoderLinha=function(btn){ if(typeof oldRemLinha==='function') oldRemLinha(btn); atualizar(); };
  const oldRem=window.removerPoder; window.removerPoder=function(){ if(typeof oldRem==='function') oldRem(); atualizar(); };
  atualizar();
  validarResistenciaImunidade();
});

function adicionarPoder() {
  const formsetDiv = document.getElementById('poderes-formset');
  const poderesContainer = formsetDiv.querySelector('div[style*="flex-direction: column"]');
  const totalFormsInput = document.getElementById('id_poder_set-TOTAL_FORMS');
  if (!totalFormsInput) return;
  const formIdx = parseInt(totalFormsInput.value);
  const emptyDiv = document.getElementById('empty-poder-form').firstElementChild.cloneNode(true);
  emptyDiv.innerHTML = emptyDiv.innerHTML.replace(/__prefix__/g, formIdx);
  if (poderesContainer) poderesContainer.appendChild(emptyDiv);
  else formsetDiv.appendChild(emptyDiv);
  totalFormsInput.value = formIdx + 1;
}
function removerPoderLinha(botao) {
  const formDiv = botao.closest('.poder-form');
  if (!formDiv) return;
  const deleteCheckbox = formDiv.querySelector('input[type="checkbox"][name$="-DELETE"]');
  const totalFormsInput = document.getElementById('id_poder_set-TOTAL_FORMS');
  if (!totalFormsInput) return;
  if (deleteCheckbox) {
    deleteCheckbox.checked = true;
    formDiv.style.display = 'none';
  } else {
    formDiv.remove();
    const forms = document.querySelectorAll('#poderes-formset .poder-form');
    forms.forEach((div, idx) => {
      div.querySelectorAll('[name]').forEach(el => {
        if (el.name.includes('poder_set-')) {
          el.name = el.name.replace(/poder_set-(\d+)-/, 'poder_set-' + idx + '-');
        }
      });
      div.querySelectorAll('[id]').forEach(el => {
        if (el.id.includes('poder_set-')) {
          el.id = el.id.replace(/poder_set-(\d+)-/, 'poder_set-' + idx + '-');
        }
      });
      div.querySelectorAll('label[for]').forEach(label => {
        if (label.htmlFor && label.htmlFor.includes('poder_set-')) {
          label.htmlFor = label.htmlFor.replace(/poder_set-(\d+)-/, 'poder_set-' + idx + '-');
        }
      });
    });
    totalFormsInput.value = forms.length;
  }
}
function removerPoder() {
  const formsetDiv = document.getElementById('poderes-formset');
  const totalFormsInput = document.getElementById('id_poder_set-TOTAL_FORMS');
  const poderForms = formsetDiv.querySelectorAll('.poder-form');
  const formCount = parseInt(totalFormsInput.value);
  if (formCount > 0) {
    const lastForm = poderForms[poderForms.length - 1];
    const deleteCheckbox = lastForm.querySelector('input[type="checkbox"][name$="DELETE"]');
    if (deleteCheckbox) {
      deleteCheckbox.checked = true;
      lastForm.style.display = 'none';
    } else {
      formsetDiv.removeChild(lastForm);
      totalFormsInput.value = formCount - 1;
    }
  }
}
</script>

<script>
// Badge de custo por poder (NPC) com lógica de Array
(function(){
  function isDeletedOrHidden(div){ const del = div.querySelector('input[type="checkbox"][name$="-DELETE"]'); if (del && del.checked) return true; if (div.style.display === 'none') return true; return false; }
  function isItemOuVant(div){ const chItem = div.querySelector('input[type="checkbox"][name$="-de_item"]'); const chVant = div.querySelector('input[type="checkbox"][name$="-de_vantagem"]'); return (chItem && chItem.checked) || (chVant && chVant.checked); }
  function baseDoPoder(div){ if (isItemOuVant(div)) return 0; const sel = n => div.querySelector('[name$="-'+n+'"]'); const nivelInput = sel('nivel_efeito'); if (!nivelInput) return 0; let n = parseFloat((nivelInput.value||'').toString().replace(',', '.'))||0; n = Math.abs(n); if (n === 0) return 0; const tipo = (sel('tipo')?.value)||''; const dur = (sel('duracao')?.value)||''; const modo = (sel('modo')?.value)||''; const tipoDano = (sel('tipo_dano')?.value||'fisico').toLowerCase(); const custoTipoDano = { fisico:0, acido:2, gelo:2, fogo:2, raio:2, veneno:2, mental:3, trovao:3, necrotico:5, radiante:5 }; const extraDano = tipo === 'dano' ? (custoTipoDano[tipoDano]||0) : 0; const tipoBonus = (tipo==='cura'||tipo==='aprimorar')?1:0; const durBonus = dur==='concentracao'?1:(dur==='sustentado'?2:(dur==='reacao'?3:0)); const modoBonus = modo==='ranged'?1:(modo==='area'?2:(modo==='percepcao'?3:0)); return n * (1 + tipoBonus + durBonus + modoBonus) + extraDano; }
  function breakdown(div){ const sel = n => div.querySelector('[name$="-'+n+'"]'); const nivelInput = sel('nivel_efeito'); let n = 0; if (nivelInput){ n = parseFloat((nivelInput.value||'').toString().replace(',', '.'))||0; } n = Math.abs(n); const tipo = (sel('tipo')?.value)||''; const dur = (sel('duracao')?.value)||''; const modo = (sel('modo')?.value)||''; const tipoDano = (sel('tipo_dano')?.value||'fisico').toLowerCase(); const custoTipoDano = { fisico:0, acido:2, gelo:2, fogo:2, raio:2, veneno:2, mental:3, trovao:3, necrotico:5, radiante:5 }; const extraDano = tipo === 'dano' ? (custoTipoDano[tipoDano]||0) : 0; const tipoBonus = (tipo==='cura'||tipo==='aprimorar')?1:0; const durBonus = dur==='concentracao'?1:(dur==='sustentado'?2:(dur==='reacao'?3:0)); const modoBonus = modo==='ranged'?1:(modo==='area'?2:(modo==='percepcao'?3:0)); const mult = 1 + tipoBonus + durBonus + modoBonus; const base = (n||0) * mult + extraDano; const elBA = div.querySelector('[name$="-bonus_ataque"]'); let bAtk = 0; if(elBA){ const v=parseFloat((elBA.value||'').toString().replace(',','.')); bAtk = isNaN(v)?0:Math.abs(v); } return { n, tipoBonus, durBonus, modoBonus, mult, base, bAtk, extraDano }; }
  function ensureBadge(div){ let b = div.querySelector('.poder-custo-badge'); if (!b){ b = document.createElement('span'); b.className = 'poder-custo-badge'; div.appendChild(b); } return b; }
  function setDetalhe(div, texto){ let det = div.querySelector('.poder-custo-detalhe'); if (!det){ det = document.createElement('div'); det.className = 'poder-custo-detalhe'; det.style.gridColumn = '1 / -1'; det.style.textAlign = 'right'; det.style.fontSize = '0.85rem'; det.style.color = '#cfcfe1'; det.style.opacity = '0.95'; det.style.paddingTop = '0.2rem'; div.appendChild(det); } det.textContent = texto; }
  function updateBadges(){ const forms = Array.from(document.querySelectorAll('.poder-form')); const grupos = new Map(); const infos = []; forms.forEach(div => { if (isDeletedOrHidden(div)) return; const arr = (div.querySelector('[name$="-array"]')?.value||'').trim().toLowerCase(); const base = baseDoPoder(div); const brk = breakdown(div); const excluido = isItemOuVant(div); const info = {div, arr, base, excluido, brk}; infos.push(info); if (!excluido && arr){ if (!grupos.has(arr)) grupos.set(arr, []); grupos.get(arr).push(info); } }); const lideres = new Map(); grupos.forEach((lista, arr) => { let maxBase = -Infinity, lider = null; lista.forEach(info => { if (info.base > maxBase){ maxBase = info.base; lider = info; } }); lideres.set(arr, {lider, maxBase, n: lista.length}); }); infos.forEach(info => { const {div, arr, base, excluido, brk} = info; const badge = ensureBadge(div); if (excluido){ badge.textContent = 'Custo: 0'; badge.title = 'Este poder não conta custo (Item/Vantagem).'; setDetalhe(div, 'Item/Vantagem: custo 0'); return; } if (!arr){ const total = base + ((brk.bAtk||0)*0.5); badge.textContent = 'Custo: ' + total; badge.title = `Base = Nível ${brk.n} × (1 + Tipo ${brk.tipoBonus} + Duração ${brk.durBonus} + Modo ${brk.modoBonus}) + Tipo Dano ${brk.extraDano||0} = ${base}. Bônus de Ataque = ${(brk.bAtk||0)*0.5} (aditivo). Total: ${total}`; setDetalhe(div, `Sem array • Base: ${brk.n} × (1 + ${brk.tipoBonus}+${brk.durBonus}+${brk.modoBonus}) + Tipo Dano ${brk.extraDano||0} = ${base} • Bônus Atk: ${(brk.bAtk||0)*0.5} • Total: ${total}`); return; } const meta = lideres.get(arr); if (!meta){ badge.textContent = 'Custo: ' + base; badge.title = `Array vazio; usando base. Base = Nível ${brk.n} × (1 + ${brk.tipoBonus}+${brk.durBonus}+${brk.modoBonus}) + Tipo Dano ${brk.extraDano||0} = ${base}`; setDetalhe(div, `Array (sem líder) • Base: ${brk.n} × (1 + ${brk.tipoBonus}+${brk.durBonus}+${brk.modoBonus}) + Tipo Dano ${brk.extraDano||0} = ${base}`); return; } const contrib = (meta.lider === info) ? meta.maxBase : 1; const total = contrib + ((brk.bAtk||0)*0.5); badge.textContent = 'Custo: ' + total; badge.title = `Array "${arr}": grupo = ${meta.maxBase} + (${meta.n}-1). Contribuição deste poder: ${contrib}. Base = Nível ${brk.n} × (1 + Tipo ${brk.tipoBonus} + Duração ${brk.durBonus} + Modo ${brk.modoBonus}) + Tipo Dano ${brk.extraDano||0} = ${base}. Bônus de Ataque = ${(brk.bAtk||0)*0.5} (aditivo). Total: ${total}`; const papel = (meta.lider === info) ? 'Líder' : 'Membro'; setDetalhe(div, `Array: ${arr} • ${papel} • Contrib.: ${contrib} • Base: ${brk.n} × (1 + ${brk.tipoBonus}+${brk.durBonus}+${brk.modoBonus}) + Tipo Dano ${brk.extraDano||0} = ${base} • Bônus Atk: ${(brk.bAtk||0)*0.5} • Total: ${total}`); }); }
  function bind(scope){ (scope||document).querySelectorAll('.poder-form select, .poder-form input').forEach(el => { el.addEventListener('input', updateBadges); el.addEventListener('change', updateBadges); }); }
  document.addEventListener('DOMContentLoaded', function(){ bind(document); updateBadges(); });
  // Expor para o unificador
  window.updateBadges = updateBadges;
})();
</script>

<script>
// Unificador final: recalcula custos/badges após adicionar Poder (NPC editar)
(function(){
  if(window._addPoderUnified) return; window._addPoderUnified = true;
  const prev = window.adicionarPoder;
  window.adicionarPoder = function(){ if (typeof prev === 'function') prev(); setTimeout(function(){ if (typeof window.atualizar === 'function') { try { window.atualizar(); } catch(e){} } if (typeof window.updateBadges === 'function') { try { window.updateBadges(); } catch(e){} } }, 60); };
})();
</script>

<style>
.defesa-total { font-size:0.75rem; opacity:0.9; margin-top:0.25rem; }
.violacao-ataque{ color:#ffb347; font-weight:700; }
</style>
<script>
// Totais de Defesas (Editar NPC) - sem limites
(function(){
  const assoc = { aparar:'luta', esquivar:'agilidade', resistencia:'vigor', vontade:'prontidao', fortitude:'vigor' };
  function num(id){ const el=document.getElementById('id_'+id); if(!el) return 0; const v=parseFloat((el.value||'').toString().replace(',','.')); return isNaN(v)?0:v; }
  function update(){ Object.keys(assoc).forEach(def=>{ const span=document.getElementById('total_'+def); if(span) span.textContent = num(def)+num(assoc[def]); }); }
  document.addEventListener('DOMContentLoaded', function(){
    const campos = ['aparar','esquivar','resistencia','vontade','fortitude','luta','agilidade','vigor','prontidao'];
    campos.forEach(c=>{ const el=document.getElementById('id_'+c); if(el){ el.addEventListener('input', update); el.addEventListener('change', update); }});
    // Hookar a função atualizar de custos, se existir
    if(typeof window.atualizar === 'function'){
      const old = window.atualizar; window.atualizar = function(){ old(); update(); };
    }
    update();
  });
})();
</script>

<script>
// Ataque Total (NPC editar) - usa maior Bônus entre poderes ligados (nome+modo+duração); sem bloqueio
(function(){
  function num(el){ if(!el) return 0; const v=parseFloat((el.value||'').toString().replace(',','.')); return isNaN(v)?0:v; }
  function kind(modoEl){ let v=(modoEl?.value||'').toLowerCase(); const t=(modoEl && modoEl.options && modoEl.options[modoEl.selectedIndex])? (modoEl.options[modoEl.selectedIndex].textContent||'').toLowerCase() : ''; if(v.includes('melee')||t.includes('corpo')) return 'melee'; if(v.includes('ranged')||t.includes('dist')) return 'ranged'; return 'other'; }
  function norm(s){ return (s||'').toString().trim().toLowerCase(); }
  function maxBonus(nome, mk, dur){ let m=0; document.querySelectorAll('.poder-form').forEach(div=>{ if(div.style.display==='none') return; const del=div.querySelector('input[name$="-DELETE"]'); if(del&&del.checked) return; const nEl=div.querySelector('[name$="-nome"]'); const mEl=div.querySelector('[name$="-modo"]'); const dEl=div.querySelector('[name$="-duracao"]'); const bEl=div.querySelector('[name$="-bonus_ataque"]'); if(!nEl||!mEl||!dEl||!bEl) return; if(norm(nEl.value)===nome && kind(mEl)===mk && norm(dEl.value)===dur){ const v=parseFloat((bEl.value||'').toString().replace(',','.')); if(!isNaN(v)) m=Math.max(m, Math.abs(v)); } }); return m; }
  function efetivoNivel(div){ const tipo=div.querySelector('[name$="-tipo"]'); const modo=div.querySelector('[name$="-modo"]'); const soma=div.querySelector('[name$="-somar_forca_no_nivel"]'); const nivel=div.querySelector('[name$="-nivel_efeito"]'); let n=0; if(nivel){ const v=parseFloat((nivel.value||'').toString().replace(',','.')); n=isNaN(v)?0:Math.abs(v);} if(tipo&&modo&&soma&&soma.checked && tipo.value==='dano' && modo.value==='melee'){ const fEl=document.getElementById('id_forca'); const f=fEl?parseFloat((fEl.value||'').toString().replace(',','.'))||0:0; n += Math.abs(f);} return n; }
  function toggleSomarForca(div){ const tipo=div.querySelector('[name$="-tipo"]'); const modo=div.querySelector('[name$="-modo"]'); const wrap=div.querySelector('.somar-forca-wrap'); if(!wrap) return; wrap.style.display = (tipo&&modo&&tipo.value==='dano'&&modo.value==='melee')? '' : 'none'; }
  function toggleAtributoAfetado(div){ if(!div) return; const tipoEl=div.querySelector('[name$="-tipo"]'); const wrap=div.querySelector('.campo-atributo-afetado'); if(!wrap) return; const show=tipoEl && tipoEl.value==='aprimorar'; wrap.style.display = show ? '' : 'none'; }
  function atualizarCaminhoAflicao(div){
    if (!div) return;
    const tipoEl = div.querySelector('[name$="-tipo"]');
    const wrap = div.querySelector('.campo-caminho-aflicao');
    if (!wrap) return;
    const v = (tipoEl && (tipoEl.value || '') || '').toLowerCase();
    wrap.style.display = v === 'aflicao' ? '' : 'none';
  }
  window.atualizarCaminhoAflicao = atualizarCaminhoAflicao;
  function toggleTipoDano(div){
    if (!div) return;
    const tipoEl = div.querySelector('[name$="-tipo"]');
    const wrap = div.querySelector('.campo-tipo-dano');
    if (!wrap) return;
    const v = (tipoEl && (tipoEl.value || '') || '').toLowerCase();
    wrap.style.display = v === 'dano' ? '' : 'none';
  }
  window.toggleTipoDano = toggleTipoDano;
  function atualizar(){
    let temViol = false;
    document.querySelectorAll('.poder-form').forEach(div=>{
      const modo=div.querySelector('[name$="-modo"]'); const bonus=div.querySelector('[name$="-bonus_ataque"]'); const nivel=div.querySelector('[name$="-nivel_efeito"]'); const nome=div.querySelector('[name$="-nome"]'); const dur=div.querySelector('[name$="-duracao"]'); const span=div.querySelector('.linha-ataque-info .valor-ataque-total'); const danoSpan=div.querySelector('.somar-forca-wrap .valor-dano-total'); if(!modo||!bonus||!nivel||!span||!nome||!dur) return; const mk=kind(modo); toggleSomarForca(div); toggleAtributoAfetado(div); atualizarCaminhoAflicao(div); toggleTipoDano(div); let base=0; const luta=document.getElementById('id_luta'); const des=document.getElementById('id_destreza'); if(mk==='melee') base=num(luta); else if(mk==='ranged') base=num(des); const useB=(mk==='other')? num(bonus) : maxBonus(norm(nome.value), mk, norm(dur.value)); const atk=base+useB; span.textContent=atk; if(danoSpan){ let nEf=Math.abs(num(nivel)); const tipo=div.querySelector('[name$="-tipo"]'); if(tipo && tipo.value==='dano'){ nEf = efetivoNivel(div); } danoSpan.textContent=nEf; } const np=document.getElementById('id_nivel_poder'); const limite=2*Math.abs(num(np)); const viol=(useB+efetivoNivel(div))>limite; span.classList.toggle('violacao-ataque',viol); if(viol) temViol = true; });

    const box = document.getElementById('npc-rule-violations');
    const list = document.getElementById('npc-rule-violations-list');
    const submitBtn = document.getElementById('submit-npc');
    if (box && list) {
      list.innerHTML = '';
      if (temViol) {
        const li = document.createElement('li');
        li.textContent = 'Há poderes com Ataque Total + Nível de Efeito acima da referência de 2×NP (valores em laranja).';
        list.appendChild(li);
        box.style.display = '';
      } else {
        box.style.display = 'none';
      }
    }
    if (submitBtn) submitBtn.disabled = false;
  }
  document.addEventListener('DOMContentLoaded', function(){ ['luta','destreza','nivel_poder','forca'].forEach(id=>{ const el=document.getElementById('id_'+id); if(el){ el.addEventListener('input',atualizar); el.addEventListener('change',atualizar);} }); function bind(){ document.querySelectorAll('.poder-form [name$="-modo"], .poder-form [name$="-bonus_ataque"], .poder-form [name$="-nivel_efeito"], .poder-form [name$="-nome"], .poder-form [name$="-duracao"], .poder-form [name$="-tipo"], .poder-form [name$="-somar_forca_no_nivel"]').forEach(el=>{ el.addEventListener('input',atualizar); el.addEventListener('change',atualizar); }); } bind(); document.querySelectorAll('.poder-form').forEach(div=>{ toggleAtributoAfetado(div); atualizarCaminhoAflicao(div); toggleTipoDano(div); }); const oldAdd=window.adicionarPoder; window.adicionarPoder=function(){ if(oldAdd) oldAdd(); setTimeout(()=>{ bind(); atualizar(); },80); }; const oldRem=window.removerPoderLinha; window.removerPoderLinha=function(btn){ if(oldRem) oldRem(btn); setTimeout(atualizar,40); }; const oldRemUlt=window.removerPoder; window.removerPoder=function(){ if(oldRemUlt) oldRemUlt(); setTimeout(atualizar,40); }; setTimeout(atualizar,60); atualizar(); });
})();
</script>
{% endblock %}
