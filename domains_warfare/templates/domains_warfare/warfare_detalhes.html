{% extends 'base.html' %}
{% load static %}

{% block content %}
<div id="warfare-content" class="combate-detalhes-center" data-is-gm="{% if is_gm %}true{% else %}false{% endif %}">
  <!-- Topo: info de turno + ações globais -->
  <div class="turno-topbar combate-card">
    <div class="turno-topbar-row">
      <div class="turno-topbar-info">
        <strong>Combate Warfare:</strong> {{ combate.nome }}
        {% if turno_ativo %}
        <span style="margin-left: 20px;"><strong>Turno:</strong> <span id="turno-ativo-nome">{{ turno_ativo.unit_atacante.nome }} ({{ turno_ativo.unit_atacante.domain.nome }})</span></span>
        {% else %}
        <span style="margin-left: 20px;"><strong>Sem turno ativo</strong></span>
        {% endif %}
      </div>
      <div class="turno-topbar-actions">
        {% if combate.ativo and is_gm %}
        <form method="post" action="{% url 'warfare_finalizar' combate.id %}" class="inline-form">
          {% csrf_token %}
          <button type="submit" class="btn btn-sm btn-danger" formnovalidate>Finalizar Combate</button>
        </form>
        {% endif %}
        <a href="{% url 'warfare_listar' %}" class="btn btn-sm">Voltar</a>
      </div>
    </div>
  </div>

  <!-- Grid: Histórico (esquerda) + Mapa (centro) -->
  <div class="combate-layout-grid" style="grid-template-columns: 1fr 2fr;">
    
    <!-- Coluna esquerda: Histórico de Ações -->
    <div class="combate-col-left">
      <div class="mapa-header-row">
        <h3 class="combate-section-title" style="margin:0">Histórico de Ações</h3>
      </div>
      <div id="historico-card" class="combate-card" style="max-height: 600px; overflow-y: auto;">
        <ul class="turnos-list">
          {% for turno in turnos %}
          <li class="turno-item" data-turno-id="{{ turno.id }}">
            <div class="turno-header">
              <strong>{{ turno.unit_atacante.nome }}</strong> 
              <span style="color: #888;">({{ turno.unit_atacante.domain.nome }})</span>
              <span class="turno-data">{{ turno.criado_em|date:"H:i" }}</span>
            </div>
            <div class="turno-desc">
              {% if turno.unit_alvo %}
              Atacou <strong>{{ turno.unit_alvo.nome }}</strong> ({{ turno.unit_alvo.domain.nome }})
              <br>
              {% if turno.sucesso_ataque %}
              ✓ Ataque: {{ turno.roll_ataque }} vs DEF
              {% if turno.sucesso_poder %}
              → ✓ Poder vs RES → <span style="color: #d33;">1 dano</span>
              {% else %}
              → ✗ Poder resistido
              {% endif %}
              {% else %}
              ✗ Ataque falhou: {{ turno.roll_ataque }} vs DEF
              {% endif %}
              {% if turno.roll_moral %}
              <br>Moral: {{ turno.roll_moral }}
              {% endif %}
              {% endif %}
            </div>
          </li>
          {% empty %}
          <li class="turno-item vazio"><em>Nenhuma ação registrada ainda.</em></li>
          {% endfor %}
        </ul>
      </div>
    </div>

    <!-- Coluna central: Mapa expandido -->
    <div class="combate-col-right">
      <div class="mapa-header-row">
        <h3 class="combate-section-title" style="margin:0">Mapa de Warfare</h3>
      </div>
      <div class="combate-card mapa-expandido">
        {% if mapa_ativo %}
        <div class="mapa-wrapper">
          <div id="mapa-area-{{ mapa_ativo.id }}" class="mapa-area" data-scale="1">
            <div class="mapa-canvas">
              <img src="{{ mapa_ativo.imagem.url }}" alt="{{ mapa_ativo.nome }}" class="mapa-img" draggable="false">
              
              {% for posicao in posicoes %}
              <div id="token-{{ posicao.id }}" 
                   class="mapa-token token-fallback"
                   style="left:{{ posicao.x }}px; top:{{ posicao.y }}px; width:60px; height:60px; background: #1e88e5; border: 2px solid #fff; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 10px; text-align: center; line-height: 1.2;"
                   draggable="true"
                   title="{{ posicao.unit.nome }} ({{ posicao.unit.domain.nome }})">
                {{ posicao.unit.nome|slice:":10" }}
              </div>
              {% endfor %}
            </div>
          </div>
          <div class="mapa-zoom" style="margin-top: 10px;">
            <button type="button" class="btn btn-sm" onclick="zoomMap(-0.1)">−</button>
            <button type="button" class="btn btn-sm" onclick="resetZoom()">Reset</button>
            <button type="button" class="btn btn-sm" onclick="zoomMap(0.1)">+</button>
          </div>
        </div>
        {% else %}
        <div style="text-align: center; color: #888;">
          <p>Nenhum mapa ativo.</p>
          {% if is_gm %}
          <p><em>GM pode adicionar mapas futuramente.</em></p>
          {% endif %}
        </div>
        {% endif %}
      </div>
    </div>

  </div>

  <!-- Participantes abaixo do mapa, em grade paralela -->
  <div class="participantes-section">
    <div class="mapa-header-row">
      <h3 class="combate-section-title" style="margin:0">Participantes</h3>
    </div>
    <div class="participantes-grid">
      {% for participante in participantes %}
      <div class="participante-domain-card">
        <div class="participante-header">
          <div class="participante-nome">{{ participante.domain.nome }} (Nível {{ participante.domain.level }})</div>
        </div>
        
        {% for unit_data in units_status %}
          {% if unit_data.domain.id == participante.domain.id %}
          <div class="unit-status-card" {% if unit_data.status.incapacitado %}style="opacity:0.5;"{% endif %}>
            <div class="unit-status-top">
              <strong class="unit-nome" {% if unit_data.status.incapacitado %}style="text-decoration: line-through; color: #666;"{% endif %}>{{ unit_data.unit.nome }}</strong>
              <span class="unit-size">Size: {{ unit_data.unit.size.nome }}</span>
            </div>

            <div class="unit-hp-row">
              <div class="unit-hp-labels">
                <span>HP: {{ unit_data.status.hp_atual }}/{{ unit_data.status.hp_maximo }}</span>
                <span class="unit-flags">
                  {% if unit_data.status.diminished %}<span class="badge-warning">⚠ Diminished</span>{% endif %}
                  {% if unit_data.status.incapacitado %}<span class="badge-danger">✗ Incapacitado</span>{% endif %}
                </span>
              </div>
              <div class="unit-hp-bar">
                <div class="unit-hp-fill {% if unit_data.status.hp_atual == 0 %}hp-zero{% elif unit_data.status.diminished %}hp-dim{% else %}hp-ok{% endif %}" style="width: {% widthratio unit_data.status.hp_atual unit_data.status.hp_maximo 100 %}%;"></div>
              </div>
            </div>

            <div class="unit-attrs">
              <span>ATQ: {{ unit_data.atributos.ataque }}</span>
              <span>POD: {{ unit_data.atributos.poder }}</span>
              <span>DEF: {{ unit_data.atributos.defesa }}</span>
              <span>RES: {{ unit_data.atributos.resistencia }}</span>
              <span>MOR: {{ unit_data.atributos.moral }}</span>
            </div>
          </div>
          {% endif %}
        {% endfor %}
      </div>
      {% empty %}
      <p style="color: #888; text-align: center; padding: 20px;"><em>Nenhum participante.</em></p>
      {% endfor %}
    </div>
  </div>
</div>

<style>
.combate-detalhes-center {
  max-width: 1800px;
  margin: 0 auto;
  padding: 20px;
}

.turno-topbar {
  margin-bottom: 20px;
}

.turno-topbar-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 10px;
}

.turno-topbar-info {
  flex: 1;
  min-width: 300px;
}

.turno-topbar-actions {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.combate-layout-grid {
  display: grid;
  gap: 20px;
  align-items: start;
}

.mapa-expandido {
  min-height: 520px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #1a1a1a;
}

.combate-card {
  background: #2a2a2a;
  border-radius: 8px;
  padding: 15px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}

.combate-section-title {
  color: #d4af37;
  font-size: 1.2em;
  margin-bottom: 10px;
}

.mapa-header-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.turnos-list {
  list-style: none;
  padding: 0;
  margin: 0;
}

.turno-item {
  padding: 10px;
  margin-bottom: 8px;
  background: #1a1a1a;
  border-radius: 4px;
  border-left: 3px solid #555;
}

.turno-item.vazio {
  text-align: center;
  color: #888;
  border-left: none;
}

.turno-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 6px;
  flex-wrap: wrap;
}

.turno-data {
  font-size: 12px;
  color: #888;
}

.turno-desc {
  font-size: 14px;
  color: #ccc;
  line-height: 1.6;
}

.inline-form {
  display: inline;
}

.btn {
  padding: 8px 16px;
  border-radius: 4px;
  border: none;
  background: #3a3a3a;
  color: #fff;
  cursor: pointer;
  font-size: 14px;
  transition: background 0.2s;
}

.btn:hover {
  background: #4a4a4a;
}

.btn-sm {
  padding: 6px 12px;
  font-size: 13px;
}

.btn-danger {
  background: #d33;
}

.btn-danger:hover {
  background: #b22;
}

.mapa-wrapper {
  position: relative;
}

.mapa-area {
  position: relative;
  overflow: hidden;
  border-radius: 8px;
}

.mapa-canvas {
  position: relative;
  width: 100%;
}

.mapa-img {
  display: block;
  width: 100%;
  height: auto;
}

.mapa-token {
  position: absolute;
  cursor: pointer;
  user-select: none;
  transition: transform 0.2s;
}

.mapa-token:hover {
  transform: scale(1.1);
  z-index: 10;
}

.mapa-zoom {
  display: flex;
  justify-content: center;
  gap: 8px;
}

.participantes-section {
  margin-top: 20px;
}

.participantes-grid {
  display: grid;
  gap: 15px;
  grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
}

.participante-domain-card {
  padding: 12px;
  background: #2a2a2a;
  border-radius: 10px;
  border: 1px solid #3a3a3a;
}

.participante-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.participante-nome {
  font-weight: bold;
  color: #d4af37;
}

.unit-status-card {
  margin-bottom: 10px;
  padding: 10px;
  background: #1a1a1a;
  border-radius: 6px;
  border: 1px solid #333;
}

.unit-status-top {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 6px;
}

.unit-nome {
  color: #fff;
}

.unit-size {
  font-size: 12px;
  color: #888;
}

.unit-hp-row {
  margin-bottom: 6px;
}

.unit-hp-labels {
  display: flex;
  justify-content: space-between;
  font-size: 11px;
  color: #ccc;
}

.unit-flags {
  display: flex;
  gap: 6px;
}

.badge-warning {
  color: #f9a825;
  font-size: 11px;
}

.badge-danger {
  color: #d33;
  font-size: 11px;
}

.unit-hp-bar {
  background: #333;
  height: 12px;
  border-radius: 6px;
  overflow: hidden;
  margin-top: 4px;
}

.unit-hp-fill {
  height: 100%;
  transition: width 0.3s;
}

.hp-zero { background: #666; }
.hp-dim { background: #f9a825; }
.hp-ok { background: #2e7d32; }

.unit-attrs {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  font-size: 11px;
  color: #aaa;
}

@media (max-width: 1200px) {
  .combate-layout-grid {
    grid-template-columns: 1fr !important;
  }
}
</style>

<script>
let currentZoom = 1;

function zoomMap(delta) {
  currentZoom = Math.max(0.5, Math.min(3, currentZoom + delta));
  const mapaArea = document.querySelector('.mapa-area');
  if (mapaArea) {
    mapaArea.style.transform = `scale(${currentZoom})`;
    mapaArea.style.transformOrigin = 'top left';
  }
}

function resetZoom() {
  currentZoom = 1;
  const mapaArea = document.querySelector('.mapa-area');
  if (mapaArea) {
    mapaArea.style.transform = 'scale(1)';
  }
}
</script>
{% endblock %}
