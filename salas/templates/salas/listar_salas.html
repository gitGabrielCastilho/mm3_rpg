{% extends 'base.html' %}
{% load filtros %}
{% block content %}
<div class="salas-center">
  <h2 class="salas-title">Salas DisponÃ­veis</h2>
  <form method="get" class="salas-filtro-form">
    <input type="text" name="q" placeholder="Buscar por nome, cÃ³digo ou dono" value="{{ query|default:'' }}">
    <button type="submit" class="btn">Buscar</button>
  </form>

  {% if user.is_authenticated and sala_atual %}
    <div class="sala-atual-card">
      <div class="sala-atual-header">
        <span class="badge badge-atual">Sala Atual</span>
        <strong class="sala-nome">{{ sala_atual.nome }}</strong>
        <span class="sala-codigo">({{ sala_atual.codigo }})</span>
      </div>
      <div class="sala-meta"><strong>Game Master:</strong> {{ sala_atual.game_master.username }}</div>
      <div class="sala-participantes">
        <strong>Participantes:</strong>
        <ul class="participantes-list">
          {% for participante in sala_atual.participantes.all %}
            {% get_perfil_de participante as perfil %}
              <li>
                <span class="participante-nome">{{ participante.username }}</span>
                {% if perfil and perfil.sala_atual and perfil.sala_atual.id == sala_atual.id %}
                  <span class="status-badge online">conectado</span>
                {% else %}
                  <span class="status-badge offline">offline</span>
                {% endif %}
                {% if sala_atual.game_master == participante %}
                  <span class="status-badge gm">GM</span>
                {% endif %}
              </li>
          {% empty %}
            <li><em>Nenhum participante ainda.</em></li>
          {% endfor %}
        </ul>
      </div>
      <form method="post" action="{% url 'sair_sala' %}" class="sala-acoes">
        {% csrf_token %}
        <button type="submit" class="btn btn-danger">Sair da sala</button>
      </form>
    </div>
  {% endif %}

  <ul class="salas-list">
    {% for sala in salas %}
      <li class="sala-item {% if sala_atual and sala_atual.id == sala.id %}atual{% endif %}">
        <div class="sala-item-main">
          <div class="sala-item-info">
            <strong class="sala-nome">{{ sala.nome }}</strong>
            <span class="sala-codigo">({{ sala.codigo }})</span>
            {% if sala.senha %}<span class="status-badge">ðŸ”’ com senha</span>{% endif %}
            <span class="sala-dono">Dono: {{ sala.criador.username|default:'-' }}</span>
            {% if sala_atual and sala_atual.id == sala.id %}
              <span class="status-badge atual">VocÃª estÃ¡ nesta sala</span>
            {% endif %}
          </div>
          {% if user.is_authenticated %}
            <div class="sala-item-acoes">
              {% if not sala_atual %}
                <a href="{% url 'entrar_sala' sala.id %}" class="btn btn-sm">Entrar</a>
              {% endif %}
              {% if sala.game_master == user %}
                <a href="{% url 'editar_senha_sala' sala.id %}" class="btn btn-sm">Editar senha</a>
                <form method="post" action="{% url 'excluir_sala' sala.id %}" onsubmit="return confirm('Excluir esta sala?')" class="inline-form">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-sm btn-danger">Excluir</button>
                </form>
              {% endif %}
            </div>
          {% endif %}
        </div>
      </li>
    {% empty %}
      <li class="sala-item vazio"><em>NÃ£o hÃ¡ salas disponÃ­veis.</em></li>
    {% endfor %}
  </ul>
</div>
{% endblock %}