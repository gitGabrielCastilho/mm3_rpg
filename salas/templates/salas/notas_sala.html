{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container" style="max-width: 900px; margin: 0 auto; padding: 16px;">
  <h2>Notas da Sessão – {{ sala.nome }} ({{ sala.codigo }})</h2>

  <div id="notas-lista" style="margin-top: 16px;">
  {% for nota in notas %}
    <div class="nota-item" data-id="{{ nota.id }}">
      <div class="nota-header">
        <strong>{{ nota.nome_usuario }}</strong>
        <small>{{ nota.criada_em|date:"d/m H:i" }}</small>
      </div>
      <div class="nota-body">
        <p class="nota-conteudo">{{ nota.conteudo|linebreaksbr }}</p>
        {% if nota.usuario_id == user.id %}
          <button type="button" class="btn btn-sm btn-secondary" onclick="abrirEdicaoNota({{ nota.id }})">Editar</button>
          <button type="button" class="btn btn-sm btn-danger" onclick="deletarNota({{ nota.id }})">Excluir</button>
        {% endif %}
      </div>
      <hr>
    </div>
  {% empty %}
    <p>Nenhuma nota ainda. Seja o primeiro a anotar!</p>
  {% endfor %}
  </div>

  <form id="form-nota" method="post" action="{% url 'criar_nota_sala' sala.id %}" style="margin-top: 16px;">
    {% csrf_token %}
    <textarea name="conteudo" id="id_conteudo" rows="6" class="form-control" style="width:100%; max-width:100%; min-width:100%; font-size:1.15rem;"
          placeholder="Escreva uma nota sobre a sessão..."></textarea>
    <button type="submit" class="btn btn-primary mt-2">Adicionar nota</button>
  </form>
</div>

{{ sala.id|json_script:"sala-id" }}

<script>
  const salaId = JSON.parse(document.getElementById('sala-id').textContent);
  const editarUrlTemplate = "{% url 'editar_nota_sala' sala.id 999999 %}";
  const deletarUrlTemplate = "{% url 'deletar_nota_sala' sala.id 999999 %}";

  const form = document.getElementById('form-nota');
  form.addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(form);
    fetch(form.action, {
      method: 'POST',
      headers: { 'X-Requested-With': 'XMLHttpRequest' },
      body: formData
    })
    .then(async (r) => {
      let data = null;
      try { data = await r.json(); } catch (e) {
        if (r.ok) { form.reset(); return; }
        throw e;
      }
      if (!data || !data.ok) {
        alert((data && data.erro) || 'Erro ao criar nota.');
        return;
      }
      form.reset();
      appendNota(data.nota);
    })
    .catch((err) => {
      console.error('Erro ao criar nota:', err);
      alert('Erro de comunicação ao criar nota.');
    });
  });

  const scheme = window.location.protocol === 'https:' ? 'wss' : 'ws';
  const wsUrl = `${scheme}://${window.location.host}/ws/sala/${salaId}/`;
  const socket = new WebSocket(wsUrl);

  socket.onmessage = function(e) {
    try {
      const msg = JSON.parse(e.data);
      if (msg.tipo === 'nota') {
        appendNota(msg);
      } else if (msg.tipo === 'nota_editada') {
        atualizarNota(msg);
      } else if (msg.tipo === 'nota_deletada') {
        removerNota(msg.id);
      }
    } catch (err) {
      console.error('Erro ao processar mensagem WS', err);
    }
  };

  function appendNota(nota) {
    const lista = document.getElementById('notas-lista');
    const div = document.createElement('div');
    div.className = 'nota-item';
    div.dataset.id = nota.id;
    div.innerHTML = `
      <div class="nota-header">
        <strong>${nota.nome_usuario}</strong>
        <small>${formatData(nota.criada_em)}</small>
      </div>
      <div class="nota-body">
        <p class="nota-conteudo">${escapeHtml(nota.conteudo).replace(/\n/g, '<br>')}</p>
        ${nota.usuario_id === {{ user.id|default:'0' }} ? `
          <button type="button" class="btn btn-sm btn-secondary" onclick="abrirEdicaoNota(${nota.id})">Editar</button>
          <button type="button" class="btn btn-sm btn-danger" onclick="deletarNota(${nota.id})">Excluir</button>
        ` : ''}
      </div>
      <hr>
    `;
    lista.appendChild(div);
  }

  function atualizarNota(nota) {
    const el = document.querySelector(`.nota-item[data-id="${nota.id}"] .nota-conteudo`);
    if (el) {
      el.innerHTML = escapeHtml(nota.conteudo).replace(/\n/g, '<br>');
    }
  }

  function removerNota(id) {
    const item = document.querySelector(`.nota-item[data-id="${id}"]`);
    if (item && item.parentNode) {
      item.parentNode.removeChild(item);
    }
  }

  function formatData(iso) {
    try {
      const d = new Date(iso);
      const dia = String(d.getDate()).padStart(2, '0');
      const mes = String(d.getMonth() + 1).padStart(2, '0');
      const hora = String(d.getHours()).padStart(2, '0');
      const min = String(d.getMinutes()).padStart(2, '0');
      return `${dia}/${mes} ${hora}:${min}`;
    } catch { return ''; }
  }

  function escapeHtml(text) {
    const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
    return text.replace(/[&<>"']/g, function(m) { return map[m]; });
  }

  // Modal de edição de nota
  function criarModalEdicaoNota(id, textoAtual) {
    let modal = document.getElementById('modal-editar-nota');
    if (modal) modal.remove();
    modal = document.createElement('div');
    modal.id = 'modal-editar-nota';
    modal.innerHTML = `
      <div class="modal-bg"></div>
      <div class="modal-content">
        <h3 style="margin-top:0">Editar nota</h3>
        <textarea id="modal-editar-textarea" rows="6" style="width:96%;max-width:96%;min-width:96%;font-size:1.1rem;margin-bottom:12px;box-sizing:border-box;">${textoAtual.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</textarea>
        <div style="text-align:right">
          <button id="modal-editar-cancelar" class="btn btn-secondary" type="button">Cancelar</button>
          <button id="modal-editar-salvar" class="btn btn-primary" type="button">Salvar</button>
        </div>
      </div>
    `;
    Object.assign(modal.style, {
      position: 'fixed', left:0, top:0, width:'100vw', height:'100vh', zIndex:10000
    });
    document.body.appendChild(modal);
    // Fundo escuro
    const bg = modal.querySelector('.modal-bg');
    Object.assign(bg.style, {
      position:'absolute',left:0,top:0,width:'100vw',height:'100vh',background:'rgba(0,0,0,0.5)'
    });
    // Conteúdo central
    const content = modal.querySelector('.modal-content');
    Object.assign(content.style, {
      position:'relative',margin:'60px auto',background:'#222',color:'#fff',borderRadius:'12px',padding:'24px',maxWidth:'480px',boxShadow:'0 4px 32px #0007',zIndex:10001
    });
    // Botões
    modal.querySelector('#modal-editar-cancelar').onclick = function(){ modal.remove(); };
    modal.querySelector('#modal-editar-salvar').onclick = function(){
      const novoTexto = modal.querySelector('#modal-editar-textarea').value;
      modal.remove();
      enviarEdicaoNota(id, novoTexto);
    };
  }

  function enviarEdicaoNota(id, novoTexto) {
    if (novoTexto === null) return;
    const formData = new FormData();
    formData.append('conteudo', novoTexto);
    const url = editarUrlTemplate.replace('999999', id);
    fetch(url, {
      method: 'POST',
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'X-CSRFToken': document.querySelector('input[name="csrfmiddlewaretoken"]').value,
      },
      body: formData,
    })
    .then(r => r.json())
    .then(data => {
      if (!data.ok) {
        alert(data.erro || 'Erro ao editar nota.');
      } else {
        // Atualiza imediatamente no DOM
        atualizarNota({id, conteudo: novoTexto});
      }
    })
    .catch(() => alert('Erro de comunicação ao editar nota.'));
  }

  window.abrirEdicaoNota = function(id) {
    const item = document.querySelector(`.nota-item[data-id="${id}"]`);
    if (!item) return;
    const conteudoEl = item.querySelector('.nota-conteudo');
    if (!conteudoEl) return;
    const textoAtual = conteudoEl.innerText || '';
    criarModalEdicaoNota(id, textoAtual);
  };

  window.deletarNota = function(id) {
    if (!confirm('Tem certeza que deseja excluir esta nota?')) return;
    const formData = new FormData();
    const url = deletarUrlTemplate.replace('999999', id);
    fetch(url, {
      method: 'POST',
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'X-CSRFToken': document.querySelector('input[name="csrfmiddlewaretoken"]').value,
      },
      body: formData,
    })
    .then(async (r) => {
      if (!r.ok) {
        console.error('Falha HTTP ao deletar nota:', r.status, url);
        alert('Erro ao deletar nota no servidor.');
        return;
      }
      let data = null;
      try { data = await r.json(); }
      catch (e) {
        console.warn('Resposta OK mas não-JSON ao deletar nota:', r.status, url);
        removerNota(id);
        return;
      }
      if (!data || !data.ok) {
        alert((data && data.erro) || 'Erro ao deletar nota.');
        return;
      }
      removerNota(id);
    })
    .catch((err) => {
      console.error('Erro de rede ao deletar nota:', err);
      alert('Erro de comunicação ao deletar nota.');
    });
  };
</script>
{% endblock %}
