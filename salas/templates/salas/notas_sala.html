{% extends "base.html" %}
{% load static %}

{% block content %}
<h2>Notas da Sessão – {{ sala.nome }} ({{ sala.codigo }})</h2>

<div id="notas-lista">
  {% for nota in notas %}
    <div class="nota-item" data-id="{{ nota.id }}">
      <div class="nota-header">
        <strong>{{ nota.nome_usuario }}</strong>
        <small>{{ nota.criada_em|date:"d/m H:i" }}</small>
      </div>
      <div class="nota-body">
        <p class="nota-conteudo">{{ nota.conteudo|linebreaksbr }}</p>
        {% if nota.usuario_id == user.id %}
          <button type="button" class="btn btn-sm btn-secondary" onclick="abrirEdicaoNota({{ nota.id }})">Editar</button>
          <button type="button" class="btn btn-sm btn-danger" onclick="deletarNota({{ nota.id }})">Excluir</button>
        {% endif %}
      </div>
      <hr>
    </div>
  {% empty %}
    <p>Nenhuma nota ainda. Seja o primeiro a anotar!</p>
  {% endfor %}
</div>

<form id="form-nota" method="post" action="{% url 'criar_nota_sala' sala.id %}">
  {% csrf_token %}
  <textarea name="conteudo" id="id_conteudo" rows="3" class="form-control"
            placeholder="Escreva uma nota sobre a sessão..."></textarea>
  <button type="submit" class="btn btn-primary mt-2">Adicionar nota</button>
</form>

{{ sala.id|json_script:"sala-id" }}

<script>
  const salaId = JSON.parse(document.getElementById('sala-id').textContent);
  // Usamos um placeholder fixo (999999) e substituímos pelo ID real da nota
  const editarUrlTemplate = "{% url 'editar_nota_sala' sala.id 999999 %}";
  const deletarUrlTemplate = "{% url 'deletar_nota_sala' sala.id 999999 %}";

  // AJAX para criar nota
  const form = document.getElementById('form-nota');
  form.addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(form);
    fetch(form.action, {
      method: 'POST',
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
      },
      body: formData
    })
    .then(r => r.json())
    .then(data => {
      if (!data.ok) {
        alert(data.erro || 'Erro ao criar nota.');
        return;
      }
      form.reset();
      // A nota também virá por WebSocket; opcionalmente poderíamos inserir aqui.
    })
    .catch(() => alert('Erro de comunicação ao criar nota.'));
  });

  // WebSocket para receber notas em tempo real
  const scheme = window.location.protocol === 'https:' ? 'wss' : 'ws';
  const wsUrl = `${scheme}://${window.location.host}/ws/sala/${salaId}/`;
  const socket = new WebSocket(wsUrl);

  socket.onmessage = function(e) {
    try {
      const msg = JSON.parse(e.data);
      if (msg.tipo === 'nota') {
        appendNota(msg);
      } else if (msg.tipo === 'nota_editada') {
        atualizarNota(msg);
      } else if (msg.tipo === 'nota_deletada') {
        removerNota(msg.id);
      }
    } catch (err) {
      console.error('Erro ao processar mensagem WS', err);
    }
  };

  function appendNota(nota) {
    const lista = document.getElementById('notas-lista');
    const div = document.createElement('div');
    div.className = 'nota-item';
    div.dataset.id = nota.id;
    div.innerHTML = `
      <div class="nota-header">
        <strong>${nota.nome_usuario}</strong>
        <small>${formatData(nota.criada_em)}</small>
      </div>
      <div class="nota-body">
        <p class="nota-conteudo">${escapeHtml(nota.conteudo).replace(/\n/g, '<br>')}</p>
        ${nota.usuario_id === {{ user.id|default:'0' }} ? `
          <button type="button" class="btn btn-sm btn-secondary" onclick="abrirEdicaoNota(${nota.id})">Editar</button>
          <button type="button" class="btn btn-sm btn-danger" onclick="deletarNota(${nota.id})">Excluir</button>
        ` : ''}
      </div>
      <hr>
    `;
    lista.appendChild(div);
  }

  function atualizarNota(nota) {
    const el = document.querySelector(`.nota-item[data-id="${nota.id}"] .nota-conteudo`);
    if (el) {
      el.innerHTML = escapeHtml(nota.conteudo).replace(/\n/g, '<br>');
    }
  }

  function removerNota(id) {
    const item = document.querySelector(`.nota-item[data-id="${id}"]`);
    if (item && item.parentNode) {
      item.parentNode.removeChild(item);
    }
  }

  function formatData(iso) {
    try {
      const d = new Date(iso);
      const dia = String(d.getDate()).padStart(2, '0');
      const mes = String(d.getMonth() + 1).padStart(2, '0');
      const hora = String(d.getHours()).padStart(2, '0');
      const min = String(d.getMinutes()).padStart(2, '0');
      return `${dia}/${mes} ${hora}:${min}`;
    } catch {
      return '';
    }
  }

  function escapeHtml(text) {
    const map = {
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, function(m) { return map[m]; });
  }

  window.abrirEdicaoNota = function(id) {
    const item = document.querySelector(`.nota-item[data-id="${id}"]`);
    if (!item) return;
    const conteudoEl = item.querySelector('.nota-conteudo');
    if (!conteudoEl) return;
    const textoAtual = conteudoEl.innerText || '';
    const novoTexto = prompt('Edite a nota:', textoAtual);
    if (novoTexto === null) return;
    const formData = new FormData();
    formData.append('conteudo', novoTexto);
    const url = editarUrlTemplate.replace('999999', id);
    fetch(url, {
      method: 'POST',
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'X-CSRFToken': document.querySelector('input[name="csrfmiddlewaretoken"]').value,
      },
      body: formData,
    })
    .then(r => r.json())
    .then(data => {
      if (!data.ok) {
        alert(data.erro || 'Erro ao editar nota.');
      }
    })
    .catch(() => alert('Erro de comunicação ao editar nota.'));
  };

  window.deletarNota = function(id) {
    if (!confirm('Tem certeza que deseja excluir esta nota?')) return;
    const formData = new FormData();
    const url = deletarUrlTemplate.replace('999999', id);
    fetch(url, {
      method: 'POST',
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'X-CSRFToken': document.querySelector('input[name="csrfmiddlewaretoken"]').value,
      },
      body: formData,
    })
    .then(async (r) => {
      let data = null;
      try {
        data = await r.json();
      } catch (e) {
        // Se não vier JSON mas a resposta for 2xx, assume sucesso
        if (r.ok) {
          removerNota(id);
          return;
        }
        throw e;
      }
      if (!data || !data.ok) {
        alert((data && data.erro) || 'Erro ao deletar nota.');
        return;
      }
      removerNota(id);
    })
    .catch((err) => {
      console.error('Erro ao deletar nota:', err);
      alert('Erro de comunicação ao deletar nota.');
    });
  };
</script>
{% endblock %}
