{# Template parcial para a tabela de participantes, reutilizável para AJAX #}
{% load filtros %}
{% load combate_extras %}
<table id="tabela-participantes">
  <tr>
    <th>Foto</th>
    <th>Nome</th>
    <th>Dano</th>
    <th>Aflição</th>
    <th>Ferimentos</th>
    <th>Ações</th>
    <th>Ficha</th>
  {% get_perfil as perfil %}
  {% if perfil and perfil.sala_atual and perfil.sala_atual.game_master == user %}
        <th>Remover</th>
      {% endif %}
  </tr>
  {% for p in participantes %}
    <tr>
      <td>
        {% if p.personagem.foto %}
          <img src="{{ p.personagem.foto.url }}" alt="Foto" style="max-width:60px; max-height:60px;">
        {% else %}
          <span>—</span>
        {% endif %}
      </td>
  <td>
    {{ p.display_nome|default:p.personagem.nome }}
    {% if p.personagem.is_npc and p.personagem.campanga %}
      <span class="badge-campanga" title="Campanga">C</span>
    {% endif %}
  </td>
      <td>{{ p.dano|dano_condicao }}</td>
      <td>{{ p.aflicao }}</td>
      <td>{{ p.ferimentos|default:0 }}</td>
      <td class="acoes-participante">
        {% if perfil and perfil.sala_atual and perfil.sala_atual.game_master == user or p.personagem.usuario == user %}
          <form method="post" action="{% url 'ajustar_buff_debuff' combate.id p.id %}" class="form-acao-participante" style="display:inline;">
            {% csrf_token %}
            <input type="hidden" name="valor" value="5">
            <button type="submit" class="btn-acao-mini btn-success" title="Adicionar +5 buff">+5</button>
          </form>
          <form method="post" action="{% url 'ajustar_buff_debuff' combate.id p.id %}" class="form-acao-participante" style="display:inline;">
            {% csrf_token %}
            <input type="hidden" name="valor" value="-5">
            <button type="submit" class="btn-acao-mini btn-danger" title="Adicionar -5 penalidade">-5</button>
          </form>
          <form method="post" action="{% url 'ajustar_aflicao' combate.id p.id %}" class="form-acao-participante" style="display:inline;">
            {% csrf_token %}
            <input type="hidden" name="valor" value="1">
            <button type="submit" class="btn-acao-mini" title="Adicionar +1 Aflição">Afl+</button>
          </form>
          <form method="post" action="{% url 'ajustar_aflicao' combate.id p.id %}" class="form-acao-participante" style="display:inline;">
            {% csrf_token %}
            <input type="hidden" name="valor" value="-1">
            <button type="submit" class="btn-acao-mini" title="Remover -1 Aflição">Afl-</button>
          </form>
          <form method="post" action="{% url 'remover_aflicoes' combate.id p.id %}" class="form-acao-participante" style="display:inline;">
            {% csrf_token %}
            <button type="submit" class="btn-acao-small btn-warning" title="Remover todas as aflições">Limpar Afl</button>
          </form>
          <form method="post" action="{% url 'descansar_participante' combate.id p.id %}" class="form-acao-participante" style="display:inline;">
            {% csrf_token %}
            <button type="submit" class="btn-acao-small btn-info" title="Recuperação completa" onclick="return confirm('Descansar {{ p.personagem.nome }}? Isso irá zerar dano, ferimentos e aflições.');">Descanso</button>
          </form>
        {% else %}
          <span style="color:#666;">—</span>
        {% endif %}
      </td>
      <td>
        {% if p.personagem.usuario == user %}
          <a href="{% url 'ficha_personagem' p.personagem.id %}" target="_blank" class="btn-link-ficha">Ver Ficha</a>
        {% endif %}
      </td>
  {% if perfil and perfil.sala_atual and perfil.sala_atual.game_master == user %}
          <td>
            <form method="post" action="{% url 'remover_participante' combate.id p.id %}" class="form-remover-participante">
              {% csrf_token %}
              <button type="submit" class="btn-remover-participante">Remover</button>
            </form>
          </td>
        {% endif %}
    </tr>
  {% endfor %}
</table>

<style>
.badge-campanga {
  display:inline-block;
  margin-left:6px;
  padding:2px 6px;
  border-radius:10px;
  background:#b3471f;
  color:#fff;
  font-size:0.75rem;
  font-weight:700;
  line-height:1;
}
</style>

