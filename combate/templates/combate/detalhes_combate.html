{% extends 'base.html' %}

{% block content %}
<div id="combate-content" class="combate-detalhes-center">
  <div id="combate-log" class="combate-log"></div>
  <h2 class="combate-subtitle">Controle do Combate</h2>
  {% if not turno_ativo and combate.ativo %}
    <form method="post" action="{% url 'iniciar_turno' combate.id %}" class="combate-inline-form">
      {% csrf_token %}
      <button type="submit" class="btn">Iniciar Turno</button>
    </form>
  {% endif %}
  {% if turno_ativo %}
    {% if personagens_disponiveis %}
      <h3 class="combate-section-title">Adicionar Personagem</h3>
      <form method="post" action="{% url 'adicionar_participante' combate.id %}" class="combate-flex-form">
        {% csrf_token %}
        <label for="novo_participante">Personagem:</label>
        <select name="personagem_id" id="novo_participante" required class="select-md">
          {% for personagem in personagens_disponiveis %}
            <option value="{{ personagem.id }}">{{ personagem.nome }} ({{ personagem.usuario.username }})</option>
          {% endfor %}
        </select>
        <button type="submit" class="btn btn-sm">Adicionar</button>
      </form>
    {% endif %}

    {% if turno_ativo %}
      <div class="turno-ativo-banner">
        <strong>Turno:</strong> {{ turno_ativo.personagem.nome }}
      </div>
    {% endif %}
    <h3 class="combate-section-title">Ações de
      <select id="personagem_acao" name="personagem_acao" form="form-ataque" class="select-md">
        {% if combate.sala.game_master == user %}
          {% for p in participantes %}
            <option value="{{ p.personagem.id }}">{{ p.personagem.nome }}</option>
          {% endfor %}
        {% else %}
          {% for p in participantes %}
            {% if p.personagem.usuario == user %}
              <option value="{{ p.personagem.id }}">{{ p.personagem.nome }}</option>
            {% endif %}
          {% endfor %}
        {% endif %}
      </select>
    </h3>

    <form method="post" action="{% url 'realizar_ataque' combate.id %}" id="form-ataque" class="combate-card ataque-card">
      {% csrf_token %}
      <input type="hidden" name="personagem_acao" id="personagem_acao_hidden" value="{{ participantes.0.personagem.id }}">

      <label for="alvo">Alvo(s):</label>
      <select id="alvo" name="alvo_id" multiple required size="4" class="multiselect-alvos">
        {% for p in participantes %}
          <option value="{{ p.personagem.id }}">{{ p.personagem.nome }}</option>
        {% endfor %}
      </select>

      <label for="poder">Poder:</label>
      <select name="poder_id" id="poder" required class="select-md">
        {% for poder in poderes_disponiveis %}
          <option value="{{ poder.id }}">{{ poder.nome }}</option>
        {% empty %}
          <option disabled>Nenhum poder disponível</option>
        {% endfor %}
      </select>

      <button type="submit" class="btn">Usar Poder</button>
    </form>

  <form method="post" action="{% url 'realizar_ataque' combate.id %}" id="form-pericia" class="combate-inline-form form-gap">
    {% csrf_token %}
    <input type="hidden" name="personagem_acao" id="personagem_acao_hidden_pericia" value="{{ participantes.0.personagem.id }}">
    <label for="pericia_rolar">Perícia:</label>
    <select name="pericia" id="pericia_rolar" required class="select-md">
      <option value="">-- Selecione uma perícia --</option>
      {% for pericia in pericias %}
        <option value="{{ pericia }}">{{ pericia|capfirst }}</option>
      {% endfor %}
    </select>
    <button type="submit" name="rolar_pericia" value="1" class="btn btn-sm">Rolar</button>
  </form>

  <form method="post" action="{% url 'realizar_ataque' combate.id %}" id="form-caracteristica" class="combate-inline-form form-gap">
    {% csrf_token %}
    <input type="hidden" name="personagem_acao" id="personagem_acao_hidden_caracteristica" value="{{ participantes.0.personagem.id }}">
    <label for="caracteristica_rolar">Característica:</label>
    <select name="caracteristica" id="caracteristica_rolar" required class="select-md">
      <option value="">-- Selecione uma característica --</option>
      {% for c in caracteristicas %}
        <option value="{{ c }}">{{ c|capfirst }}</option>
      {% endfor %}
    </select>
    <button type="submit" name="rolar_caracteristica" value="1" class="btn btn-sm">Rolar</button>
  </form>

  <form method="post" action="{% url 'realizar_ataque' combate.id %}" id="form-d20" class="combate-inline-form form-gap">
    {% csrf_token %}
    <input type="hidden" name="personagem_acao" id="personagem_acao_hidden_d20" value="{{ participantes.0.personagem.id }}">
    <button type="submit" name="rolar_d20" value="1" class="btn btn-sm">Rolar d20</button>
  </form>

  <script>
  // Sincroniza o personagem selecionado para todos os formulários de ação e recarrega poderes
  document.addEventListener('DOMContentLoaded', function() {
    var select = document.getElementById('personagem_acao');
    var poderSelect = document.getElementById('poder');
    function syncPersonagemAcao() {
      var val = select.value;
      document.getElementById('personagem_acao_hidden').value = val;
      document.getElementById('personagem_acao_hidden_pericia').value = val;
      document.getElementById('personagem_acao_hidden_caracteristica').value = val;
      document.getElementById('personagem_acao_hidden_d20').value = val;

      // AJAX para atualizar poderes
      fetch('/combate/poderes-personagem-ajax/?personagem_id=' + val)
        .then(resp => resp.json())
        .then(data => {
          if (poderSelect) {
            poderSelect.innerHTML = '';
            if (data.poderes && data.poderes.length > 0) {
              data.poderes.forEach(function(p) {
                var opt = document.createElement('option');
                opt.value = p.id;
                opt.textContent = p.nome;
                poderSelect.appendChild(opt);
              });
            } else {
              var opt = document.createElement('option');
              opt.disabled = true;
              opt.textContent = 'Nenhum poder disponível';
              poderSelect.appendChild(opt);
            }
          }
        });
    }
    select.addEventListener('change', syncPersonagemAcao);
    syncPersonagemAcao();
  });
  </script>

    <form method="post" action="{% url 'avancar_turno' combate.id %}" class="combate-inline-form">
      {% csrf_token %}
      <button type="submit" formnovalidate class="btn">Avançar Turno</button>
    </form>

    <form method="post" action="{% url 'finalizar_combate' combate.id %}" class="combate-inline-form">
      {% csrf_token %}
      <button type="submit" class="btn btn-danger" formnovalidate>Finalizar Combate</button>
    </form>
  {% endif %}

  <hr>
  <h3 class="combate-section-title">Histórico de Ataques</h3>
  <ul class="turnos-list">
    {% for turno in turnos %}
      <li class="turno-item {% if turno.ativo %}ativo{% endif %}">
        <div class="turno-header">
          <strong>Rodada {{ turno.ordem }}</strong>
          <span class="turno-data">{{ turno.criado_em|date:"d/m/Y H:i" }}</span>
          {% if turno.ativo %}<span class="status-badge atual">Ativo</span>{% endif %}
        </div>
        <div class="turno-desc">{{ turno.descricao|safe }}</div>
      </li>
    {% empty %}
      <li class="turno-item vazio"><em>Nenhum ataque registrado ainda.</em></li>
    {% endfor %}
  </ul>

  <h3 class="combate-section-title">Status dos Participantes</h3>
  {% include 'combate/_tabela_participantes.html' %}
  <h3 class="combate-section-title">Mapa do Combate</h3>

  {% if combate.mapas.all %}
    {% for mapa in combate.mapas.all %}
      <div id="mapa-area-{{ mapa.id }}" class="mapa-area">
        <img src="{{ mapa.imagem.url }}" alt="{{ mapa.nome }}" class="mapa-img">
        {% for posicao in posicoes %}
          {% if posicao.mapa.id == mapa.id %}
            {% if posicao.participante.personagem.foto %}
              <img src="{{ posicao.participante.personagem.foto.url }}"
                   id="token-{{ posicao.id }}"
                   class="mapa-token"
                   style="left:{{ posicao.x }}px; top:{{ posicao.y }}px;"
                   draggable="true"
                   ondragstart="drag(event, {{ posicao.id }})">
            {% else %}
              <div id="token-{{ posicao.id }}" class="mapa-token token-fallback"
                   style="left:{{ posicao.x }}px; top:{{ posicao.y }}px;"
                   draggable="true"
                   ondragstart="drag(event, {{ posicao.id }})">
                {{ posicao.participante.personagem.nome|slice:"0:2"|upper }}
              </div>
            {% endif %}
          {% endif %}
        {% endfor %}
        {% if combate.sala.game_master == user %}
        <form method="post" action="{% url 'remover_mapa' combate.id mapa.id %}" class="mapa-remover-form">
          {% csrf_token %}
          <button type="submit" class="btn btn-sm btn-danger">Remover Mapa</button>
        </form>
        {% endif %}
      </div>
    {% endfor %}
  {% endif %}

  {% if combate.sala.game_master == user %}
  <form method="post" enctype="multipart/form-data" action="{% url 'adicionar_mapa' combate.id %}" class="combate-card mapa-upload-form">
    {% csrf_token %}
    <label for="mapa_existente">Selecionar mapa existente:</label>
    <select name="mapa_existente" id="mapa_existente" class="select-md">
      <option value="">-- Escolha um mapa --</option>
      {% for mapa in mapas_globais %}
        <option value="{{ mapa.id }}">{{ mapa.nome }}</option>
      {% endfor %}
    </select>
    <button type="submit" name="usar_existente" value="1" class="btn btn-sm">Usar Selecionado</button>
    <hr>
    <strong>Ou envie um novo mapa:</strong>
    {{ form.as_p }}
    <button type="submit" class="btn">Adicionar Novo Mapa</button>
  </form>
  {% endif %}
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const combateId = '{{ combate.id }}';
    const wsScheme = window.location.protocol === 'https:' ? 'wss' : 'ws';
    const wsPath = `${wsScheme}://${window.location.host}/ws/combate/${combateId}/`;
    const combateSocket = new WebSocket(wsPath);


    combateSocket.onmessage = function(e) {
      // Recarrega toda a página ao receber mensagem WebSocket
      window.location.reload();
    };

    combateSocket.onclose = function(e) {
      console.warn('WebSocket fechado.');
    };

    window.enviarMensagemCombate = function(msg) {
      combateSocket.send(msg);
    };
  });

  function drag(event, id) {
    event.dataTransfer.setData("tokenId", id);
  }

  document.addEventListener("DOMContentLoaded", function() {
    document.querySelectorAll("[id^='mapa-area-']").forEach(function(mapaArea) {
      mapaArea.addEventListener("dragover", function(e) { e.preventDefault(); });
      mapaArea.addEventListener("drop", function(e) {
        e.preventDefault();
        const tokenId = e.dataTransfer.getData("tokenId");
        const rect = mapaArea.getBoundingClientRect();
        const x = e.clientX - rect.left - 20;
        const y = e.clientY - rect.top - 20;
        fetch(`/combate/atualizar-posicao-token/${tokenId}/`, {
          method: "POST",
          headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "Content-Type": "application/json"
          },
          body: JSON.stringify({x, y})
        }).then(() => {
          const token = document.getElementById("token-" + tokenId);
          token.style.left = x + "px";
          token.style.top = y + "px";
        });
      });
    });
  });
</script>

{% endblock %}

