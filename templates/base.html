<!DOCTYPE html>
<html lang="pt-br">
<head>
  {% load static %}
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Mutantes & Malfeitores</title>

  <link rel="icon" href="{% static 'img/dice_fav_icon.png' %}" type="image/png">
  <link rel="shortcut icon" href="{% static 'img/dice_fav_icon.png' %}">
  <link rel="stylesheet" href="{% static 'css/style.css' %}">
 </head>
<body>

<nav class="nav-bar">
  <div class="nav-group">
    <a href="/">Home</a>
    {% if user.is_authenticated %}
      <a href="{% url 'itens' %}">Itens</a>
      <div class="dropdown">
        <button class="dropbtn">Personagens ▾</button>
        <div class="dropdown-content">
          <a href="{% url 'listar_personagens' %}">Meus Personagens</a>
          <a href="{% url 'criar_personagem' %}">Criar Personagem</a>
        </div>
      </div>
      <div class="dropdown">
        <button class="dropbtn">Salas ▾</button>
        <div class="dropdown-content">
          <a href="{% url 'criar_sala' %}">Criar Sala</a>
          <a href="{% url 'listar_salas' %}">Minhas Salas</a>
        </div>
      </div>
      {% load filtros %}
      {% get_perfil as perfil %}
      {% if perfil %}
        {% if perfil.sala_atual %}
          {% if perfil.tipo == 'game_master' %}
          <div class="dropdown">
            <button class="dropbtn">NPCs ▾</button>
            <div class="dropdown-content">
              <a href="{% url 'listar_npcs' %}">Meus NPCs</a>
              <a href="{% url 'criar_npc' perfil.sala_atual.id %}">Criar NPC</a>
            </div>
          </div>
          {% endif %}
          <div class="dropdown">
            <button class="dropbtn">Combate & Mapas ▾</button>
            <div class="dropdown-content">
              {% if perfil.tipo == 'game_master' %}
                <a href="{% url 'criar_combate' perfil.sala_atual.id %}">Novo Combate</a>
                <a href="{% url 'listar_combates' perfil.sala_atual.id %}">Combates</a>
                <a href="{% url 'listar_mapas' %}">Meus Mapas</a>
                <a href="{% url 'adicionar_mapa_global' %}">Adicionar Mapa</a>
              {% else %}
                <a href="{% url 'listar_combates' perfil.sala_atual.id %}">Combates</a>
              {% endif %}
            </div>
          </div>
        {% endif %}
      {% endif %}
    {% else %}
      <a href="{% url 'login' %}">Login</a>
      <a href="{% url 'cadastrar_usuario' %}">Cadastro</a>
    {% endif %}
  </div>
  {% if user.is_authenticated %}
    <form action="{% url 'logout' %}" method="post" class="logout-form">
      {% csrf_token %}
      <button type="submit">Sair</button>
    </form>
  {% endif %}
</nav>

<script>
// Dropdown robusto: abre ao passar mouse ou focar, fecha ao sair
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.dropdown').forEach(function(drop) {
    let timeout;
    const menu = drop.querySelector('.dropdown-content');
    drop.addEventListener('mouseenter', function() {
      clearTimeout(timeout);
      menu.style.display = 'block';
    });
    drop.addEventListener('mouseleave', function() {
      timeout = setTimeout(() => { menu.style.display = 'none'; }, 120);
    });
    drop.querySelector('.dropbtn').addEventListener('focus', function() {
      menu.style.display = 'block';
    });
    drop.querySelector('.dropbtn').addEventListener('blur', function() {
      timeout = setTimeout(() => { menu.style.display = 'none'; }, 120);
    });
    menu.addEventListener('mouseenter', function() {
      clearTimeout(timeout);
      menu.style.display = 'block';
    });
    menu.addEventListener('mouseleave', function() {
      timeout = setTimeout(() => { menu.style.display = 'none'; }, 120);
    });
  });
});
</script>

{% if user.is_authenticated %}
{% get_perfil as perfil %}
{% if perfil and perfil.sala_atual %}
<aside class="sidebar closed" id="sidebar">
  <button id="sidebar-toggle" class="sidebar-toggle" onclick="toggleSidebar()" title="Abrir/Fechar participantes">
    <span id="sidebar-toggle-icon">⮜</span>
  </button>
  <h3 style="margin-top:0;">{{ perfil.sala_atual.nome|default:'Sala' }}</h3>
  <div style="margin-bottom: 8px;">
    <strong>Game Master:</strong> {{ perfil.sala_atual.game_master.username }}
  </div>
  <div id="sidebar-participantes">
    {% include 'salas/_sidebar_participantes.html' with sala=perfil.sala_atual user=user %}
  </div>
</aside>
<script>
function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  const icon = document.getElementById('sidebar-toggle-icon');
  sidebar.classList.toggle('closed');
  if (sidebar.classList.contains('closed')) {
    icon.textContent = '⮞';
    sidebar.setAttribute('aria-expanded', 'false');
  } else {
    icon.textContent = '⮜';
    sidebar.setAttribute('aria-expanded', 'true');
  }
}
// Sidebar começa fechado por padrão, garantir ícone correto ao carregar
document.addEventListener('DOMContentLoaded', function() {
  const sidebar = document.getElementById('sidebar');
  const icon = document.getElementById('sidebar-toggle-icon');
  if (sidebar && sidebar.classList.contains('closed')) {
    icon.textContent = '⮞';
    sidebar.setAttribute('aria-expanded', 'false');
  }
});
</script>
{% endif %}
{% endif %}
{% block sidebar_ws %}
{% if user.is_authenticated %}
{% get_perfil as perfil %}
{% if perfil and perfil.sala_atual %}
<script>
  console.log('Sidebar script carregado');
  document.addEventListener('DOMContentLoaded', function() {
  const salaId = '{{ perfil.sala_atual.id }}';
    const wsScheme = window.location.protocol === 'https:' ? 'wss' : 'ws';
  const wsPath = `${wsScheme}://${window.location.host}/ws/sala/${salaId}/`;
  const currentUserId = '{{ user.id }}';
    let salaSocket = null;
    let pollTimer = null;
  let reconnectTimer = null;
  let refreshWhileOpenTimer = null;
  let reconnectDelayMs = 5000; // backoff base
  let pingTimer = null;

    function refreshSidebar() {
      const url = `/salas/sidebar_participantes/${salaId}/?t=` + Date.now();
      fetch(url, { cache: 'reload' })
        .then(r => r.text())
        .then(html => {
          const el = document.getElementById('sidebar-participantes');
          if (el) el.innerHTML = html;
        })
        .catch(err => console.warn('[Sidebar AJAX] Falha ao atualizar:', err));
    }

    function startPolling() {
      if (pollTimer) return; // já está ativo
      console.warn('[Sidebar] Iniciando polling por fallback');
      pollTimer = setInterval(refreshSidebar, 12000); // ~12s
      // também faz uma atualização imediata
      refreshSidebar();
    }

    function stopPolling() {
      if (pollTimer) {
        clearInterval(pollTimer);
        pollTimer = null;
        console.log('[Sidebar] Polling parado');
      }
    }

    function connectWS() {
      try {
        salaSocket = new WebSocket(wsPath);
      } catch (e) {
        console.warn('[Sidebar WS] Erro ao conectar WS, ativando polling:', e);
        startPolling();
        scheduleReconnect();
        return;
      }
      salaSocket.onopen = function() {
        console.log('[Sidebar WS] Conectado');
        stopPolling();
        if (reconnectTimer) { clearTimeout(reconnectTimer); reconnectTimer = null; }
        reconnectDelayMs = 5000; // reset backoff
        // Faça uma atualização imediata mesmo sem broadcast
        refreshSidebar();
        // Marca imediatamente o próprio usuário como online na UI (otimista)
        setTimeout(() => {
          const me = document.getElementById('status-user-' + currentUserId);
          if (me) { me.textContent = '(conectado)'; me.classList.remove('status-offline'); me.classList.add('status-online'); me.style.color = 'green'; }
        }, 200);
        // E mantém uma atualização leve periódica enquanto aberto, caso não cheguem mensagens de presença
        if (refreshWhileOpenTimer) { clearInterval(refreshWhileOpenTimer); }
        refreshWhileOpenTimer = setInterval(refreshSidebar, 15000);
        // Keepalive ping para proxies que encerram conexões ociosas
        if (pingTimer) { clearInterval(pingTimer); }
        pingTimer = setInterval(() => {
          try {
            if (salaSocket && salaSocket.readyState === 1) {
              salaSocket.send(JSON.stringify({ tipo: 'ping', t: Date.now() }));
            }
          } catch(_) {}
        }, 20000);
      };
      salaSocket.onmessage = function(e) {
        // pequeno delay para garantir consistência
        setTimeout(refreshSidebar, 300);
      };
      salaSocket.onclose = function(e) {
        console.warn('[Sidebar WS] Fechado. Ativando polling e tentando reconectar...');
        if (refreshWhileOpenTimer) { clearInterval(refreshWhileOpenTimer); refreshWhileOpenTimer = null; }
        if (pingTimer) { clearInterval(pingTimer); pingTimer = null; }
        startPolling();
        scheduleReconnect();
      };
      salaSocket.onerror = function(e) {
        console.warn('[Sidebar WS] Erro:', e);
        if (pingTimer) { clearInterval(pingTimer); pingTimer = null; }
        // Não force close aqui; deixe o servidor decidir. Se fechar, onclose tratará reconexão.
      };
      salaSocket.onerror = function(e) {
        console.warn('[Sidebar WS] Erro:', e);
        try { salaSocket.close(); } catch(_) {}
      };
    }

    function scheduleReconnect() {
      if (reconnectTimer) return;
      // Pequena aleatoriedade para evitar sincronizar reconexões de múltiplas abas
      const jitter = Math.floor(Math.random() * 500);
      reconnectTimer = setTimeout(() => {
        reconnectTimer = null;
        // backoff exponencial com teto ~60s
        reconnectDelayMs = Math.min(reconnectDelayMs * 1.6, 60000);
        connectWS();
      }, reconnectDelayMs + jitter);
    }

    connectWS();
  });
</script>
{% endif %}
{% endif %}
{% endblock %}

<hr>
  {% if messages %}
  <ul>
    {% for message in messages %}
      <li style="color: green;">{{ message }}</li>
    {% endfor %}
  </ul>
{% endif %}
  {% block content %}{% endblock %}
</body>
