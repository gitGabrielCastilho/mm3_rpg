<!DOCTYPE html>
<html lang="pt-br">
<head>
  {% load static %}
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Mutantes & Malfeitores</title>

  <link rel="icon" href="{% static 'img/dice_fav_icon.png' %}" type="image/png">
  <link rel="shortcut icon" href="{% static 'img/dice_fav_icon.png' %}">
  <link rel="stylesheet" href="{% static 'css/style.css' %}">
 </head>
<body>

<nav class="nav-bar">
  <div class="nav-group">
  {% if user.is_authenticated %}
      {% load filtros %}
      {% get_perfil as perfil %}
      <div class="dropdown">
        <button class="dropbtn">Salas ▾</button>
        <div class="dropdown-content">
          <a href="{% url 'criar_sala' %}">Criar Sala</a>
          <a href="{% url 'listar_salas' %}">Minhas Salas</a>
        </div>
      </div>
      {% if perfil and perfil.sala_atual %}
        <a href="{% url 'itens' %}">Itens</a>
        <div class="dropdown">
          <button class="dropbtn">Personagens ▾</button>
          <div class="dropdown-content">
            <a href="{% url 'listar_personagens' %}">Meus Personagens (da sala)</a>
            <a href="{% url 'criar_personagem' %}">Criar Personagem (nesta sala)</a>
          </div>
        </div>
        {% if perfil.tipo == 'game_master' %}
        <div class="dropdown">
          <button class="dropbtn">NPCs ▾</button>
          <div class="dropdown-content">
            <a href="{% url 'listar_npcs' %}">Meus NPCs</a>
            <a href="{% url 'criar_npc' perfil.sala_atual.id %}">Criar NPC</a>
          </div>
        </div>
        {% endif %}
        <div class="dropdown">
          <button class="dropbtn">Combate & Mapas ▾</button>
          <div class="dropdown-content">
            {% if perfil.tipo == 'game_master' %}
              <a href="{% url 'criar_combate' perfil.sala_atual.id %}">Novo Combate</a>
              <a href="{% url 'listar_combates' perfil.sala_atual.id %}">Combates</a>
              <a href="{% url 'listar_mapas' %}">Meus Mapas</a>
              <a href="{% url 'adicionar_mapa_global' %}">Adicionar Mapa</a>
            {% else %}
              <a href="{% url 'listar_combates' perfil.sala_atual.id %}">Combates</a>
            {% endif %}
          </div>
        </div>
      {% endif %}
    {% else %}
      <a href="{% url 'listar_salas' %}">Salas</a>
      <a href="{% url 'login' %}">Login</a>
      <a href="{% url 'cadastrar_usuario' %}">Cadastro</a>
    {% endif %}
  </div>
  {% if user.is_authenticated %}
    <form action="{% url 'logout' %}" method="post" class="logout-form">
      {% csrf_token %}
      <button type="submit">Sair</button>
    </form>
  {% endif %}
</nav>

<script>
// Dropdown robusto: abre ao passar mouse ou focar, fecha ao sair
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.dropdown').forEach(function(drop) {
    let timeout;
    const menu = drop.querySelector('.dropdown-content');
    drop.addEventListener('mouseenter', function() {
      clearTimeout(timeout);
      menu.style.display = 'block';
    });
    drop.addEventListener('mouseleave', function() {
      timeout = setTimeout(() => { menu.style.display = 'none'; }, 120);
    });
    drop.querySelector('.dropbtn').addEventListener('focus', function() {
      menu.style.display = 'block';
    });
    drop.querySelector('.dropbtn').addEventListener('blur', function() {
      timeout = setTimeout(() => { menu.style.display = 'none'; }, 120);
    });
    menu.addEventListener('mouseenter', function() {
      clearTimeout(timeout);
      menu.style.display = 'block';
    });
    menu.addEventListener('mouseleave', function() {
      timeout = setTimeout(() => { menu.style.display = 'none'; }, 120);
    });
  });
});
</script>

{% if user.is_authenticated %}
{% get_perfil as perfil %}
{% if perfil and perfil.sala_atual %}
<aside class="sidebar closed" id="sidebar">
  <button id="sidebar-toggle" class="sidebar-toggle" onclick="toggleSidebar()" title="Abrir/Fechar participantes">
    <span id="sidebar-toggle-icon">⮜</span>
  </button>
  <h3 style="margin-top:0;">{{ perfil.sala_atual.nome|default:'Sala' }}</h3>
  <div style="margin-bottom: 8px;">
    <strong>Game Master:</strong> {{ perfil.sala_atual.game_master.username }}
  </div>
  <div id="sidebar-participantes">
    {% include 'salas/_sidebar_participantes.html' with sala=perfil.sala_atual user=user %}
  </div>
  <div id="sidebar-personagens" style="margin-top:10px;">
    {% include 'salas/_sidebar_personagens.html' with sala=perfil.sala_atual user=user %}
  </div>
</aside>
<script>
function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  const icon = document.getElementById('sidebar-toggle-icon');
  sidebar.classList.toggle('closed');
  if (sidebar.classList.contains('closed')) {
    icon.textContent = '⮞';
    sidebar.setAttribute('aria-expanded', 'false');
  } else {
    icon.textContent = '⮜';
    sidebar.setAttribute('aria-expanded', 'true');
  }
}
// Sidebar começa fechado por padrão, garantir ícone correto ao carregar
document.addEventListener('DOMContentLoaded', function() {
  const sidebar = document.getElementById('sidebar');
  const icon = document.getElementById('sidebar-toggle-icon');
  if (sidebar && sidebar.classList.contains('closed')) {
    icon.textContent = '⮞';
    sidebar.setAttribute('aria-expanded', 'false');
  }
});
</script>
{% endif %}
{% endif %}
{% block sidebar_ws %}{% endblock %}

<hr>
  {% if messages %}
  <ul>
    {% for message in messages %}
      <li style="color: green;">{{ message }}</li>
    {% endfor %}
  </ul>
{% endif %}
  {% block content %}{% endblock %}
</body>
